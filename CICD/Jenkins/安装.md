# 安装jenkins

## 安装jenkins

#### 1、jenkins 安装

官网： [https://jenkins.io](https://jenkins.io/)

插件：http://updates.jenkins-ci.org/download/plugins/

##### 1、安装 java 环境（jenkins 依赖 java 环境）

```shell
[root@qfedu.com tools]# ls                 # 查看解压包
jdk-8u45-linux-x64.tar.gz
[root@qfedu.com tools]# tar zxf jdk-8u45-linux-x64.tar.gz    # 解压
[root@qfedu.com tools]# mv jdk1.8.0_45/ /usr/local/jdk1.8    # 移动至指定目录
[root@qfedu.com tools]# vim /etc/profile    # 配置环境变量
JAVA_HOME=/usr/local/java
export MAVEN_HOME=/usr/local/maven
export JRE_HOME=/usr/local/java/jre
export CLASSPATH=.:$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$MAVEN_HOME/bin:$PATH
[root@qfedu.com tools]# source /etc/profile  # 配置生效
[root@qfedu.com tools]# java -version        # 查看java版本
java version "1.8.0_45"
Java(TM) SE Runtime Environment (build 1.8.0_45-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02, mixed mode)
```

##### 2、yum 安装 jenkins

```shell
[root@qfedu.com ~]# wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
# 导入jenkins源
[root@qfedu.com ~]# rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
# 导入jenkins官方证书
[root@qfedu.com ~]# yum install -y jenkins
# 安装jenkins（安装的是最新的LTS版本）

[root@qfedu.com ~]# rpm -ql jenkins   # 查看yum都安装了哪些东西
/etc/init.d/jenkins
/etc/logrotate.d/jenkins
/etc/sysconfig/jenkins
/usr/lib/jenkins
/usr/lib/jenkins/jenkins.war
/usr/sbin/rcjenkins
/var/cache/jenkins
/var/lib/jenkins
/var/log/jenkins
```

#### 2、配置文件

##### 1、查询 yum 下载 Jenkins 安装的文件

```shell
[root@qfedu.com ~]# rpm -ql jenkins
/etc/init.d/jenkins         # 启动文件
/etc/logrotate.d/jenkins    # 日志分割配置文件
/etc/sysconfig/jenkins      # jenkins主配置文件
/usr/lib/jenkins            # 存放war包目录
/usr/lib/jenkins/jenkins.war   # war 包 
/usr/sbin/rcjenkins         # 命令
/var/cache/jenkins          # war包解压目录 jenkins网页代码目录
/var/lib/jenkins            # jenkins 工作目录
/var/log/jenkins            # 日志
```

##### 2、修改配置文件

**配置文件说明**：

```shell
[root@qfedu.com ~]# grep "^[a-Z]" /etc/sysconfig/jenkins
JENKINS_HOME="/var/lib/jenkins"    # jenkins工作目录
JENKINS_JAVA_CMD=""
JENKINS_USER="jenkins"             # jenkinx启动用户
JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true"
JENKINS_PORT="8080"                # 端口
JENKINS_LISTEN_ADDRESS=""
JENKINS_HTTPS_PORT=""
JENKINS_HTTPS_KEYSTORE=""
JENKINS_HTTPS_KEYSTORE_PASSWORD=""
JENKINS_HTTPS_LISTEN_ADDRESS=""
JENKINS_DEBUG_LEVEL="5"
JENKINS_ENABLE_ACCESS_LOG="no"
JENKINS_HANDLER_MAX="100"          # 最大连接
JENKINS_HANDLER_IDLE="20"
JENKINS_ARGS=""
```

##### 3、启动 jenkins

- 首先需要修改一下启动脚本，文件在/etc/init.d/jenkins


- 因为jenkins的启动脚本默认java路径为：/usr/bin/java


- 但是我们新安装的java路径并不是在这个，所以我们需要新添加路径。如图下所示：


- 新路径地址为：/usr/local/jdk1.8/bin/java


![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522174833.png)

接下来启动：

```shell
[root@qfedu.com ~]# systemctl start jenkins
```

#####  3、验证安装

```shell
[root@qfedu.com ~]# ps -ef|grep jenkins
jenkins   16037      1  1 16:20 ?        00:00:13 /usr/local/jdk1.8/bin/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=true -DJENKINS_HOME=/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile=/var/log/jenkins/jenkins.log --webroot=/var/cache/jenkins/war --daemon --httpPort=8080 --debug=5 --handlerCountMax=100 --handlerCountMaxIdle=20
root      16107   1215  0 16:39 pts/1    00:00:00 grep --color=auto jenkins
[root@qfedu.com ~]# netstat -lnutp|grep jenkins
[root@qfedu.com ~]# netstat -lnutp|grep 8080
tcp6       0      0 :::8080                 :::*                    LISTEN      16037/java
```

出现离线安装解决方法：

###### 1、修改 /var/lib/jenkins/updates/default.json

jenkins 在下载插件之前会先检查网络连接，其会读取这个文件中的网址。默认是访问谷歌，肯定监测失败，所以将图下的google改为[www.baidu.com](http://www.baidu.com/)即可，更改完重启服务。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522174904.png)

###### 2、 修改/var/lib/jenkins/hudson.model.UpdateCenter.xml

该文件为jenkins下载插件的源地址，改地址默认jenkins默认为：https://updates.jenkins.io/update-center.json，就是因为https的问题，此处我们将其改为http即可，之后重启jenkins服务即可。

其他国内备用地址（也可以选择使用）：

https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json

http://mirror.esuni.jp/jenkins/updates/update-center.json

在修复完之后，我们发现离线问题已经解决

## master-slave架构



- jenkins的Master-slave分布式架构主要是为了解决jenkins单点构建任务多、负载较高、性能不足的场景。


- Master/Slave相当于Server和agent的概念。Master提供web接口让用户来管理job和slave，job可以运行在master本机或者被分配到slave上运行构建。一个master（jenkins服务所在机器）可以关联多个slave用来为不同的job或相同的job的不同配置来服务。


#### 1、安装

**前提：slave 所在服务器必须有 java环境**

jenkins web 端进行操作：

系统管理->管理节点->新建节点

1、进行基础配置

配置选项中的内容是可变的，根据情况来

![image-20210523153612292](https://gitee.com/c_honghui/picture/raw/master/img/20210523153612.png)

注意这里需要配置凭据，也就是配置slave所在服务器用户和密码

![img](D:%5C%E5%8D%83%E5%B3%B0%5CCI%20CD%20%E8%BD%AF%E4%BB%B6+%E7%AC%94%E8%AE%B0+%E8%B5%84%E6%96%99%5C%E7%AC%AC3%E5%A4%A9-Jenkins%E8%AF%A6%E8%A7%A3%5Cassets%5C1235834-20180905174833717-113155048.png)

之后保存，如果无误的话就会直接启动了，如图下所示是有问题的

![image-20210523153622439](https://gitee.com/c_honghui/picture/raw/master/img/20210523153622.png)

通过看输出日志，发现是 jdk 的问题，一般来说，其会判断 slave 所在服务器有没有 jdk，如果有就会进行检测，如下图所示，就是没有检查到（因为jdk是我们自己装的，路径并不是默认的路径）。

![image-20210523153639112](https://gitee.com/c_honghui/picture/raw/master/img/20210523153639.png)

没有检查到的话其就会去oracle官网下载，来为 slave 所在服务器进行安装，但是因为中国的原因，被墙了，所以也会下载失败，最终就导致彻底失败了，失败如图下：

![image-20210523153652205](https://gitee.com/c_honghui/picture/raw/master/img/20210523153652.png)

有两种方法解决：推荐方法1：

方法1：

在配置时高级的选项里指定java路径：如下图所示：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

方法2：

为 java 路径做一个软链接，保证 jenkins 可以检测到 java。

```shell
[root@qfedu.com ~]# ln -s /usr/local/jdk1.8/bin/java /usr/bin/java
[root@qfedu.com ~]# ll /usr/bin/java 
lrwxrwxrwx 1 root root 26 Jul 25 17:33 /usr/bin/java -> /usr/local/jdk1.8/bin/java
```

 之后在看已经成功了！

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

并且也可以在 slave 所在服务器看到：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

jar 包就是负责接收 master 任务的。

#### 2、配置

在项目 job 中进行配置：

可通过标签或者名称进行匹配（标签可在安装时配置）

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

#### 3、构建

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210522215954.png)

可以发现控制台的日志，其也是 slave 构建的

![image-20210523153709610](https://gitee.com/c_honghui/picture/raw/master/img/20210523153709.png)

之后查看构建完的工作目录，也有预想中的文件。

```shell
ls /var/lib/jenkins/workspace/A-web1
index.html
```

这样基本上就实现了借助 jenkins 的 slave 去构建 job了。

目前是在 slave 构建也在 slave 上部署，之后我们可以通过脚本，比如借助 rsync、ansible 等部署在其他服务器上。

#### 4、扩展

可以为slave服务器在配置时候加上标签，这样也会方便我们选择，用法也不单单局限在一台服务器上，可以让多台 slave 去竞选。

## 基于docker安装master

```shell
docker run --name jenkins -itd \
-p 8081:8080 \
-p 50000:50000 \
-v ~/jenkins:/var/jenkins_home \
jenkins/jenkins:lts
```

插件下载失败的情况

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520235833.png" alt="image-20210520235826046" style="zoom:80%;" />

基于docker安装jenkins slave节点（静态）：

在jenkins节点管理添加节点

![image-20210521001251449](https://gitee.com/c_honghui/picture/raw/master/img/20210521001251.png)

配置节点信息：自定义目录 启动方式：java web

![image-20210521001405289](https://gitee.com/c_honghui/picture/raw/master/img/20210521001405.png)

获取jnlp方式运行slave所需的秘钥信息

![image-20210521001450990](https://gitee.com/c_honghui/picture/raw/master/img/20210521001451.png)

获取jnlp slave的docker镜像

![image-20210521001524458](https://gitee.com/c_honghui/picture/raw/master/img/20210521001524.png)

查看效果：

![image-20210521001641144](https://gitee.com/c_honghui/picture/raw/master/img/20210521001641.png)