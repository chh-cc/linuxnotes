# 扫描

## 安装配置sonarscanner

[SonarScanner | SonarQube Docs](https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/)

```shell
wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.1.2450-linux.zip
unzip sonar-scanner-cli-4.6.1.2450-linux.zip -d /usr/local
vim /etc/profile
export SONAR_HOME=/usr/local/sonar-scanner-cli-4.6.1.2450-linux/
export PATH=$PATH:$SONAR_HOME/bin
source /etc/profile
sonar-scanner -h
```

安装java插件：

![image-20210519002419740](https://gitee.com/c_honghui/picture/raw/master/img/20210519002419.png)

![image-20210519233202924](https://gitee.com/c_honghui/picture/raw/master/img/20210519233209.png)

## 分析项目

获取项目：

```shell
git clone https://github.com/demo/demo-maven-service.git
cd demo-maven-service/
mvn clean package

classes   
maven-archiver
maven-status
my-app-1.1-SNAPSHOT.jar   
surefire-reports    
test-classes  
```

扫描项目：

```shell
#!/bin/bash

projectName="demo-maven-service"
scanTime=`date +%Y%m%d%H%M%S`

for((i=1;i<=10;i++))
do
    sonar-scanner  -Dsonar.host.url=http://xxxxxx:9000  \
    -Dsonar.projectKey=${projectName}${i}  \
    -Dsonar.projectName=${projectName}${i}  \
    -Dsonar.projectVersion=${scanTime} \
    -Dsonar.login=admin \
    -Dsonar.password=admin \
    -Dsonar.ws.timeout=30 \
    -Dsonar.projectDescription="my first project!"  \
    -Dsonar.links.homepage=http://www.baidu.com \
    -Dsonar.sources=src \
    -Dsonar.sourceEncoding=UTF-8 \
    -Dsonar.java.binaries=target/classes \
    -Dsonar.java.test.binaries=target/test-classes \
    -Dsonar.java.surefire.report=target/surefire-reports

    echo "${projectName}  scan success!"
done
```

![image-20210519233838648](https://gitee.com/c_honghui/picture/raw/master/img/20210519233838.png)

## 用jenkins分析项目

### 使用流水线自动扫描

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520001701.png" alt="image-20210520001701266" style="zoom:67%;" />

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520000646.png" alt="image-20210520000646384" style="zoom:67%;" />

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520001200.png" alt="image-20210520001159980" style="zoom:67%;" />

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520003109.png" alt="image-20210520003109490" style="zoom:67%;" />

查看扫描结果：

![image-20210520003222030](https://gitee.com/c_honghui/picture/raw/master/img/20210520003222.png)

### 使用sonar插件扫描

安装插件：SonarQube Scanner

先保存sonarqube的token到jenkins凭据

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520004605.png" alt="image-20210520004605538" style="zoom:67%;" />

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520004833.png" alt="image-20210520004833704" style="zoom:67%;" />

系统配置：

![image-20210520004908934](https://gitee.com/c_honghui/picture/raw/master/img/20210520004909.png)

修改上面的共享库：

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210520005600.png" alt="image-20210520005600631" style="zoom:67%;" />

多了个跳转链接：

![image-20210520005330067](https://gitee.com/c_honghui/picture/raw/master/img/20210520005330.png)