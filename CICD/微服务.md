# 微服务

单体架构容易部署但难以维护

微服务特点：

```text
服务组件化
每个服务独立开发、部署，有效避免一个服务的修改引起整个系统重新部署。
技术栈灵活
约定通信方式，使得服务本身功能实现对技术要求不再那么敏感。
独立部署
每个微服务独立部署，加快部署速度，方便扩展。
扩展性强
每个微服务可以部署多个，并且有负载均衡能力。
独立数据
每个微服务有独立的基本组件，例如数据库、缓存等。  
```

java微服务框架：

```text
• Spring Boot：快速开发微服务的框架
• Spring Cloud：基于SpringBoot实现的一个完整的微服务解决方案
• Dubbo：阿里巴巴开源的微服务治理框架
```

微服务架构：

![image-20210524145842250](https://gitee.com/c_honghui/picture/raw/master/img/20210524150044.png)

**微服务总体架构**

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210331205612.png)

• 微服务间如何通信？
• 微服务如何发现彼此？
• 组件之间怎么个调用关系？
• 哪个服务作为整个网站入口？
• 哪些微服务需要对外访问？
• 微服务怎么部署？更新？扩容？  

部署springcloud微服务项目：

![image-20210524154020966](https://gitee.com/c_honghui/picture/raw/master/img/20210524154021.png)

| 服务器IP                                              | 端口 | 服务    | 用途       |
| ----------------------------------------------------- | ---- | ------- | ---------- |
| 192.168.31.61 <br />192.168.31.62 <br />192.168.31.63 | 8888 | eureka  | 注册中心   |
| 192.168.31.63                                         | 3306 | mariadb | 数据库     |
| 192.168.31.62 <br />192.168.31.63                     | 8010 | product | 商品服务   |
|                                                       | 8020 | order   | 订单服务   |
|                                                       | 8030 | stock   | 库存服务   |
|                                                       | 8080 | portal  | 前端       |
|                                                       | 9999 | gateway | 网关       |
| 1921.68.31.62                                         | 80   | nginx   | 负载均衡器 |

部署Eureka集群

```shell
# vi src/main/resources/application-dev.yml
eureka:
server:
renewal-percent-threshold: 0.9
enable-self-preservation: false
eviction-interval-timer-in-ms: 40000
instance:
hostname: 127.0.0.1
prefer-ip-address: true
client:
register-with-eureka: true
serviceUrl:
defaultZone:
http://192.168.31.61:${server.port}/eureka/,http://192.168.31.62:${serv
er.port}/eureka/,http://192.168.31.63:${server.port}/eureka/
fetch-registry: true

使用systemd管理eureka：
[Unit]
Description=Eureka
Documentation=eureka
[Service]
ExecStart=/usr/local/jdk/bin/java -jar /data/ms/eureka/eureka-service.jar
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
[Install]
WantedBy=multi-user.target
```

mysql

```shell
创建一个账号并授权，该账户用于微服务连接：
grant all on *.* to 'ms'@'%' identified by '123456';
将源代码目录里sql文件拷贝到数据库服务器并导入：
scp -r db/ root@192.168.31.62:~
mysql -uroot –p
mysql> create database tb_stock;
mysql> user tb_stock;
mysql> source /root/db/stock.sql
```

对外提供访问：

```shell
upstream gateway {
server 192.168.31.61:9999;
server 192.168.31.62:9999;
server 192.168.31.63:9999;
}

server {
listen 80;
server_name gateway.ctnrs.com;
access_log /var/log/nginx/gateway-access.log main;
location / {
proxy_pass http://gateway;
}
}

upstream portal {
server 192.168.31.61:8080;
server 192.168.31.62:8080;
server 192.168.31.63:8080;
}

server {
listen 80;
server_name portal.ctnrs.com;
access_log /var/log/nginx/portal-access.log main;
location / {
proxy_pass http://portal;
}
}
```

微服务全链路监控：

```text
全链路性能监控 从整体维度到局部维度展示各项指标，将跨应用的所有调用链性能信息集中展现，可方便度量整体和局部性能，并且方便找到故障产生的源头，生产上可极大缩短故障排除时间

• 请求链路追踪：通过分析服务调用关系，绘制运行时拓扑信息，可视化展示
• 调用情况衡量： 各个调用环节的性能分析，例如吞吐量、响应时间、错误次数
• 容器规划参考：扩容/缩容、服务降级、流量控制
• 运行情况反馈：告警，通过调用链结合业务日志快速定位错误信息
```





















