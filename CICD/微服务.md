# 微服务

## 微服务架构

微服务定义

```text
1.微服务架构：将单个应用拆分成多个独立的、微小的服务。 
2.每个小服务程序运行在独立的进程中。 
3.服务与服务之间通过轻量协议通信（通常是HTTP协议）。 
4.通信机制互相协作、互相配合,从而为终端用户提供业务价值。 
5.每个小服务，可以采用不同的语言、框架、工具 独立开发、测试、部署、运维。 
6.微服务：独立的小服务。
```

微服务开发框架:

```text
• Spring Boot：快速开发微服务的框架
• Spring Cloud：java开源微服务框架体系(最成熟最流行)
• Dubbo：阿里巴巴开源的微服务治理框架
```

spring cloud微服务架构：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210716151433.png)

spring cloud微服务框架体系:

```text
Eureka：服务注册发现
Zuul：服务网管API代理路由
Governator：服务端容器
Ribbon：客户端负载均衡
Hystrix：服务容错组件
Archaius：服务配置组件
Servo：Metrics测量组件
Blitz4j：日志组件
```



![image-20210524145842250](https://gitee.com/c_honghui/picture/raw/master/img/20210524150044.png)

**微服务总体架构**

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210331205612.png)

## Eureka服务发现与注册

注册与发现主要是为了方便**客户端的调用**，假设开始只开发一个服务，客户端可以直接调用，但是如果是两台，写2个服务IP或者轮训都不太理想，因为遇到大型促销场景，需要增加10台，或者1000台都要更改配置列。

微服务的实体数量是动态的，我客户端调微服务的话，不是直接找微服务了，是**先找注册中心**

部署springcloud微服务项目：

![image-20210524154020966](https://gitee.com/c_honghui/picture/raw/master/img/20210524154021.png)

| 服务器IP                                              | 端口 | 服务    | 用途       |
| ----------------------------------------------------- | ---- | ------- | ---------- |
| 192.168.31.61 <br />192.168.31.62 <br />192.168.31.63 | 8888 | eureka  | 注册中心   |
| 192.168.31.63                                         | 3306 | mariadb | 数据库     |
| 192.168.31.62 <br />192.168.31.63                     | 8010 | product | 商品服务   |
|                                                       | 8020 | order   | 订单服务   |
|                                                       | 8030 | stock   | 库存服务   |
|                                                       | 8080 | portal  | 前端       |
|                                                       | 9999 | gateway | 网关       |
| 1921.68.31.62                                         | 80   | nginx   | 负载均衡器 |

部署Eureka集群

```shell
# vi src/main/resources/application-dev.yml
eureka:
server:
renewal-percent-threshold: 0.9
enable-self-preservation: false
eviction-interval-timer-in-ms: 40000
instance:
hostname: 127.0.0.1
prefer-ip-address: true
client:
register-with-eureka: true
serviceUrl:
defaultZone:
http://192.168.31.61:${server.port}/eureka/,http://192.168.31.62:${serv
er.port}/eureka/,http://192.168.31.63:${server.port}/eureka/
fetch-registry: true

使用systemd管理eureka：
[Unit]
Description=Eureka
Documentation=eureka
[Service]
ExecStart=/usr/local/jdk/bin/java -jar /data/ms/eureka/eureka-service.jar
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
[Install]
WantedBy=multi-user.target
```

mysql

```shell
创建一个账号并授权，该账户用于微服务连接：
grant all on *.* to 'ms'@'%' identified by '123456';
将源代码目录里sql文件拷贝到数据库服务器并导入：
scp -r db/ root@192.168.31.62:~
mysql -uroot –p
mysql> create database tb_stock;
mysql> user tb_stock;
mysql> source /root/db/stock.sql
```

对外提供访问：

```shell
upstream gateway {
server 192.168.31.61:9999;
server 192.168.31.62:9999;
server 192.168.31.63:9999;
}

server {
listen 80;
server_name gateway.ctnrs.com;
access_log /var/log/nginx/gateway-access.log main;
location / {
proxy_pass http://gateway;
}
}

upstream portal {
server 192.168.31.61:8080;
server 192.168.31.62:8080;
server 192.168.31.63:8080;
}

server {
listen 80;
server_name portal.ctnrs.com;
access_log /var/log/nginx/portal-access.log main;
location / {
proxy_pass http://portal;
}
}
```

微服务全链路监控：

```text
全链路性能监控 从整体维度到局部维度展示各项指标，将跨应用的所有调用链性能信息集中展现，可方便度量整体和局部性能，并且方便找到故障产生的源头，生产上可极大缩短故障排除时间

• 请求链路追踪：通过分析服务调用关系，绘制运行时拓扑信息，可视化展示
• 调用情况衡量： 各个调用环节的性能分析，例如吞吐量、响应时间、错误次数
• 容器规划参考：扩容/缩容、服务降级、流量控制
• 运行情况反馈：告警，通过调用链结合业务日志快速定位错误信息
```





















