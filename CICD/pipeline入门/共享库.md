#  共享库

在各种项目之间共享pipeline核心实现，以减少冗余并保证所有job在构建的时候会调用最新的共享库代码 。

在Jenkins中使用Groovy语法，共享库中存储的每个文件都是一个groovy的类，每个文件（类）中包含一个或多个方法。每个方法包含groovy语句块。

##  目录结构

Shared Library代码目录结构如下： 

![image-20210526104425088](https://gitee.com/c_honghui/picture/raw/master/img/20210526104431.png)

src目录就是标准的Java源目录结构。执行Pipeline时，该目录将添加到类路径中。 
vars目录托管定义可从Pipeline访问的全局脚本\(一般我们可以在这里编写标准化脚本\)。通常，每个_.groovy文件的基本名称应使用驼峰（camelCased）模式，_.txt（如果存在）可以包含格式化处理的文档。
resources目录允许libraryResource从外部库中使用步骤来加载相关联的非Groovy文件。目前内部库不支持此功能。

## 定义全局库

我们导航到 系统配置 ->  `Global Pipeline Libraries`

这些库将全局可用，系统中的任何Pipeline都可以利用这些库中实现的功能。并且通过配置SCM的方式，可以保证在每次构建时获取到指定Shared Library的最新代码。

![image-20210329170224655](https://gitee.com/c_honghui/picture/raw/master/img/20210329170338.png)

接下来我们配置共享库的仓库地址，我的仓库在github中，所以这里我填写的是github的方式。（如果你用的是gitlab可以使用gitlab方式或者git方式）。如果仓库是私有的方式，需要在jenkins的凭据中添加一个账号用于下载共享库。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210329170417.png" alt="image-20210329170416871" style="zoom:67%;" />



在Jenkinsfile中使用`@Library('jenkinslib') _ `来加载共享库，注意后面符号`_`用于加载。 
类的实例化`def tools = new org.devops.tools()`,使用类中的方法`tools.PrintMes("获取代码",'green')`。



gitlab上的jenkinslib项目:

```groovy
jenkinslib/src/org/devops/tools.groovy

package org.devops

//格式化输出
def PrintMes(value,color){
    colors = ['red'   : "\033[40;31m >>>>>>>>>>>${value}<<<<<<<<<<< \033[0m",
              'blue'  : "\033[47;34m ${value} \033[0m",
              'green' : "[1;32m>>>>>>>>>>${value}>>>>>>>>>>[m",
              'green1' : "\033[40;32m >>>>>>>>>>>${value}<<<<<<<<<<< \033[0m" ]
    ansiColor('xterm') {
        println(colors[color])
    }
}
```

jenkinsfile:

```groovy
#!groovy

@Library('jenkinslib') _     

def tools = new org.devops.tools()

pipeline {
    agent { node {  label "master" }}

    stages {
        //下载代码
        stage("GetCode"){ 
            steps{  
                timeout(time:5, unit:"MINUTES"){   
                    script{ 
                        tools.PrintMes("获取代码",'green')
                    }
                }
            }
        }
    }
}
```

