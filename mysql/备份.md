# 备份恢复

## 备份分类

- 物理备份

产生的副本都是二进制文件,常常不可编辑,例如数据库的二进制日志

适用于大数据量备份

- 逻辑备份

MySQL的逻辑备份其实就是使用MySQL自带的**mysqldump**命令或者其他工具把MySQL数据**备份成sql语句存储**，在恢复的时候通过执行mysql恢复命令（或source等）将存储的sql语句还原到mysql数据库中。

补充：增量备份备份binog日志文件即可，如何增量恢复binlog日志呢，mysqlbinlog二具可以把binlog日志转换成SQL语句，然后通过mysql恢复命令（或source等）将SQl语句还原到MySQL数据库中。

## 主从复制集群架构的数据备份策略

有主从复制了，还需要做定时全量加增量备份么？答案是肯定的！

因为，如果主库有语句级误操作，例如：(drop database oldboy;),从库也会执行drop database oldboy;这样MySQL主从库就都删除了该数据。

把从库作为数据库备份服务器时,备份策略如下：

高并发业务场景备份时,可以选择在一台从库上备份，把从库作为数据库备份服务器时需要在从库开启binlog功能

步骤如下：

-  选择一个**不对外服务服务的从库**，确保和主库更新最接近，专门做数据备份用。

-  开启从库的binlog功能。

备份时可以选择只停止SQL线程，停止应用SQL语句到数据库，I/O线程保留工作状态，执行命令为stop slave sql_thread;，备份方式可以采取mysqldump逻辑备份或者直接物理备份，例如：cp、tar（/data）根据总的备份数据量的多少选择，把全备和binlog发送到备份服务器上留存。

## 备份工具

- mysqldump(单线程)/mysqlpump(多线程)

mysql自带的逻辑备份工具,支持全备和部分备

InnoDB:热备

MyISAM:温备

策略:全备+增备,速度相对慢

- xtrabackup

物理备份工具

支持全备+部分备 全备+增备 全备+差异备份

策略:全备配合二进制日志增量备份,速度快

## mysqldump

参数

```shell
#备份所有库，这样设置的账号密码什么的也会备份了
--all-databases

#不锁表，保证各个表具有数据一致性快照。这期间增删改查正常，但是alter table等对表结构发生更改的语句要被挂起。默认关闭。
#所以该参数明显不能保证各个表之间的数据一致性（特别是外键约束的父表和子表之间）
#一致性快照说的是如果4点开始备份，那对数据做一个快照，6点结束了，这期间只会保存4点前的，新的改变不进行同步保存，根据pos点。
--single-transaction
#将会输出CHANGE MASTER命令 用于从库的恢复，2的话会默认注释掉
--master-data=2

#导出存储过程以及自定义函数。
--routines

#导出触发器
--triggers

#开始导出之前刷新日志
--flush-logs
```



例子

备份单库的库结构、表结构、表数据

```shell
mysqldump -uroot -pxxx --single-transaction --master-data=2 --routines --flush-logs --databases text > text.sql
```

## xtarbackup

安装

1.安装依赖
`yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev-devel`

2.下载安装
`wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm`

```
yum -y install percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm
```

参数

```shell

```

