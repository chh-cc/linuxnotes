# 备份恢复

## 备份分类

- 物理备份

产生的副本都是二进制文件,常常不可编辑,例如数据库的二进制日志

适用于大数据量备份

- 逻辑备份

MySQL的逻辑备份其实就是使用MySQL自带的**mysqldump**命令或者其他工具把MySQL数据**备份成sql语句存储**，在恢复的时候通过执行mysql恢复命令（或source等）将存储的sql语句还原到mysql数据库中。

补充：增量备份备份binog日志文件即可，如何增量恢复binlog日志呢，mysqlbinlog二具可以把binlog日志转换成SQL语句，然后通过mysql恢复命令（或source等）将SQl语句还原到MySQL数据库中。

## 主从复制集群架构的数据备份策略

有主从复制了，还需要做定时全量加增量备份么？答案是肯定的！

因为，如果主库有语句级误操作，例如：(drop database oldboy;),从库也会执行drop database oldboy;这样MySQL主从库就都删除了该数据。

把从库作为数据库备份服务器时,备份策略如下：

高并发业务场景备份时,可以选择在一台从库上备份，把从库作为数据库备份服务器时需要在从库开启binlog功能

步骤如下：

-  选择一个**不对外服务服务的从库**，确保和主库更新最接近，专门做数据备份用。

-  开启从库的binlog功能。

备份时可以选择只停止SQL线程，停止应用SQL语句到数据库，I/O线程保留工作状态，执行命令为stop slave sql_thread;，备份方式可以采取mysqldump逻辑备份或者直接物理备份，例如：cp、tar（/data）根据总的备份数据量的多少选择，把全备和binlog发送到备份服务器上留存。

## 备份工具

- mysqldump(单线程)/mysqlpump(多线程)

mysql自带的逻辑备份工具,支持全备和部分备

InnoDB:热备

MyISAM:温备

策略:全备+增备,速度相对慢

- xtrabackup

物理备份工具

支持全备+部分备 全备+增备 全备+差异备份

策略:全备配合二进制日志增量备份,速度快

## mysqldump

参数

```shell
#用于导出若干个数据库
-B

#备份所有库，这样设置的账号密码什么的也会备份了
--all-databases

#不锁表，保证各个表具有数据一致性快照。这期间增删改查正常，但是alter table等对表结构发生更改的语句要被挂起。默认关闭。
#所以该参数明显不能保证各个表之间的数据一致性（特别是外键约束的父表和子表之间）
#一致性快照说的是如果4点开始备份，那对数据做一个快照，6点结束了，这期间只会保存4点前的，新的改变不进行同步保存，根据pos点。
--single-transaction
#将会输出CHANGE MASTER命令 用于从库的恢复，2的话会默认注释掉
--master-data=2

#存储过程和函数
--routines

#由于mysql在全量导出时不导出event事件表,故需要在全量导出时忽略事件表
--events

#导出触发器
--triggers

#开始导出之前刷新日志
--flush-logs
```



例子

多库分别备份命令

```shell
mysql -uroot -p123456 -S /data/3306/mysql.sock -e "show databases;"|egrep -vi "Database|information_schema|performance_schema"|sed -r 's#(.*)#mysqldump -uroot -p123456 -S /data/3306/mysql.sock --events -B \1|gzip >/backup/\1.sql.gz#g'|bash
```

单库多表备份

```shell
mysqldump -uroot -p123456 -S /data/3306/mysql.sock student score >/backup/student_score.sql
#备份student库score表，在不使用-B的情况下，库名后加表名（可以接多个表，以空格隔开）
```

备份表结构

```shell
mysqldump -uroot -p123456 -S /data/3306/mysql.sock -d student score >/backup/student_score.sql    #加-d参数
```

备份表数据

```shell
mysqldump -uroot -p123456 -S /data/3306/mysql.sock -t student score >/backup/student_score.sql    #加-t参数
```

innodb引擎企业生产备份命令：推荐使用的

```shell
mysqldump -uroot -p123456 -S /data/3306/mysql.sock -A -B -F -R --master-data=2 --events --single-transaction|gzip >/opt/all.sql.gz
提示：也可以不用-F,与--master-data有些重复
```



## xtarbackup

安装

1.安装依赖
`yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev-devel`

2.下载安装
`wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm`

```
yum -y install percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm
```

参数

```shell

```

## 恢复

数据恢复和字符集关联很大，如果字符集不正确会导致恢复的数据乱码，执行mysql命令以及source命令恢复数据库的原理就是把文件的SQL语句，在数据库执行行的过程。

###  利用source命令恢复数据库

```shell
mysql -uroot -p123456 -S /data/3308/mysql.sock
source /backup/student.sql                  #恢复库，等价于
mysql -uroot -p123456 -S /data/3306/mysql.sock </backup/student.sql
```

```shell
use oldboy_gbk;
source /backup/student_score.sql             #恢复表，等价于
mysql -uroot -p123456 -S /data/3306/mysql.sock -e "use oldboy_gbk; source /backup/student_score.sql;"
```

### mysqlbinlog工具解析binlog日志实践

mysqlbinlog工具的作用是解析mysql的二进制binlog日志内容，把二进制内容解析成可以在MySQL数据库里执行的SQL语句。

binlog日志作用是用来记录mysql内部增删改等对mysql数据库的记录（对数据库的改动），对数据库查询的语句如show,sdect开头的语句没有记录日志。

**范例一、  利用mysqlbinlog -d参数解析指定库的binlog日志**

```shell
mysqlbinlog -d student /data/3306/mysql-bin.000045|egrep -v "#|--|^$|/\*"
```

按照位置截取，精确

```shell
mysqlbinlog /data/3306/mysql-bin.000045 --start-position=183 --stop-position=304
#注意：起始位置必须精确，停止位置可以不精确
#如果没有指定起始点默认从日志最开始开始，如果没有指定结束点则默认到日志最后。
```

## 增量恢复场景

生产工作中一般常用一主多从的数据库架构，常见的备份方案是在从服务器上开启binlog，然后实施定时全备份和实时增量备份

**什么是增量恢复？**

利用二进制日志和全备进行的恢复过程，被称为增量恢复。

**什么情况下需要增量恢复？**

1）主或者从库宕机（硬件损坏）足否需要增量恢复？

答：不需要增量恢复，主库宕机，只需要把其中一个同步最快的从库切换为主库

从库宕机，直接不用就好了（一般都会配LVS负载均衡）。

2）人为操作数据库SQL语句破坏主库足否需要增量恢复？

在数据库主库内部命令行误操作，会导致所有的数据库（包括主从库）

在主库执行了drop database test;这样的删除语句，这时所有的从库也会执行drop database test;语句，从而导致所有数据库上的test库数据丢失。这样才需要增量恢复的

3）只有一个主库是否需要增量恢复？

如果公司里只有一个主库的情况，首先应该做定时全量备份，然后做增量备份（每隔1-10分钟对binlog日志做切割然后备份到其他的服务器，或者写到网络文件系统（备份服务器）里。如果不允许数据丢失，最好的办法就是做从库。

正常情况：

主从同步：除了分担读写分离压力外，还可以防止物理设备损坏数据丢失的情况

从库备份：在从库进行全量和增量方式的备份，可以防止人为对主库的误操作但必须确保备份的从库实时和主库是同步状态。

**MySQL增量恢复必备条件**

存在一份全备加上全备之后的时刻到出问题时刻的所有增量binlog文件

开启MySQL log-bin日志功能

提示：主库和备份的从库都要开启binlog记录功能。