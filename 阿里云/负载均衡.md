# 负载均衡

## 产品概述

负载均衡SLB（Server Load Balancer）是一种对流量进行按需分发的服务，通过将流量分发到不同的后端服务来扩展应用系统的服务吞吐能力，并且可以消除系统中的单点故障，提升应用系统的可用性。

负载均衡负责HTTPS流量的加密与解密，后端服务器仅需处理普通HTTP流量，可以极大的节省后端服务在数据加解密上的算力，有效控制后端服务器的规模与成本。

与传统的硬件型负载均衡自建方案相比，阿里云负载均衡具备按量付费和弹性伸缩能力，无需一次性大额投入，便可拥有天猫双十一级别的海量流量分发处理能力。

## CLB

随着**应用型负载均衡ALB（Application Load Balancer）**的引入，原**负载均衡SLB（Server Load Balancer）**现称为**传统型负载均衡CLB（Classic Load Balancer）**，**负载均衡SLB**为负载均衡产品家族的总称。

组成：

- 负载均衡实例 （Instances）

  一个负载均衡实例是一个运行的负载均衡服务，用来接收流量并将其分配给后端服务器。要使用负载均衡服务，您必须创建一个负载均衡实例，并至少添加一个监听和两台ECS实例。

- 监听 （Listeners）

  监听用来检查客户端请求并将请求转发给后端服务器。监听也会对后端服务器进行健康检查。

- 后端服务器（Backend Servers）

  后端服务器是一组接收前端请求的ECS实例。您可以单独添加ECS实例到后端服务器池，也可以通过虚拟服务器组或主备服务器组来批量添加和管理。

高可用：

四层负载均衡通过LVS（Linux Virtual Server）+ keepalived的方式实现，七层负载均衡通过Tengine（淘宝网发起的Web服务器项目，在Nginx的基础上，针对有大访问量的网站需求进行了优化）实现。

负载均衡通过健康检查来判断后端ECS实例的可用性。开启健康检查功能后，当后端某个ECS实例健康检查出现异常时，负载均衡会自动将新的请求分发到其他健康检查正常的ECS实例上，而当该ECS实例恢复正常运行时，负载均衡会将其自动恢复到负载均衡服务中。

## ALB

专门面向七层，提供超强的业务处理性能，例如HTTPS卸载能力。单实例每秒查询数QPS（Query Per Second）可达100万次。同时ALB提供基于内容的高级路由特性，例如基于HTTP报头、Cookie和查询字符串进行转发、重定向和重写等，是阿里云官方云原生Ingress网关。

### 实例

面向七层，提供了超强七层负载均衡能力，通过将流量分发到不同的后端服务来扩展应用系统的服务吞吐能力。单实例可处理高达100万QPS。

#### 创建实例

前提:在每个可用区中至少启动一个ECS实例，并且ECS实例的安全组允许端口80或443上的HTTP或HTTPS访问。

1. 登录负载均衡管理控制台。
2. 在左侧导航栏，选择**应用型负载均衡ALB** > **实例**。
3. 在**实例**页面，单击**创建应用型负载均衡**。
4. 在**应用型负载均衡（按量付费）**页面，完成以下配置。

|       配置       | 说明                                                         |
| :--------------: | :----------------------------------------------------------- |
|     **地域**     | 选择应用型负载均衡实例的所属地域。<br />确保应用型负载均衡实例的地域和后端添加的云服务器ECS的地域相同。 |
|     **VPC**      | 选择一个VPC。                                                |
|    **可用区**    | 选择所选地域的可用区。<br />应用型负载均衡支持多可用区部署。为了保障业务的高可用，请至少选择2个可用区。 |
|    **IP模式**    | 选择应用型负载均衡实例的IP地址模式，可以设置为**固定IP**或者**动态IP**。<br />**固定IP**：每个可用区有且只有一个IP，并且IP固定保持不变。此模式下应用型负载均衡实例最大支持10万的每秒查询数QPS（Query Per Second）。<br />**动态IP**：每个可用区至少有一个IP。随着业务请求的增加，应用型负载均衡会自动扩展IP数量。 |
|   **功能版本**   | 选择一种功能版本：**基础版**或**标准版**。本示例选择**基础版**。 |
| **实例网络类型** | 根据业务场景选择配置对外公开或对内私有的应用型负载均衡服务，系统会根据您的选择分配公网或私网服务地址。本示例选择**公网**。<br />**公网**：仅提供公网IP，可以通过Internet访问负载均衡。<br />**说明** 应用型负载均衡公网使用弹性公网IP，使用公网实例将收取弹性公网IP实例费与带宽、流量费用。<br />**私网**：仅提供阿里云私网IP，只能通过阿里云内部网络访问该负载均衡服务，无法从Internet访问。 |
| **公网计费方式** | 选择一种计费方式：**按流量计费**、**按固定带宽计费**或**按传统95计费**。本示例选择**按流量计费**。**说明** 该参数仅在**实例网络类型**为**公网**时有效。 |
|   **实例名称**   | 输入实例名称。长度为1-80个英文或中文字符，必须以大小字母或中文开头，支持数字、正斜线（/）、半角句号（.）、短划线（-）和下划线（_）等字符。 |
|    **资源组**    | 选择云资源所属的资源组。本示例选择默认资源组。               |

5. 单击**立即购买**。

6. 在**确认订单**页面，选中**我已阅读并同意《应用型负载均衡（按量付费）服务协议》**，然后单击**立即开通**。

#### 创建坚挺

1. 返回**实例**页面，单击目标实例**操作**列下的**创建监听**。
2. 在**负载均衡业务配置向导**的**配置监听**页面，完成以下配置。

| 监听配置             | 说明                                                         |
| :------------------- | :----------------------------------------------------------- |
| **选择负载均衡协议** | 选择监听的协议类型。本示例选择**HTTPS**。                    |
| **监听端口**         | 用来接收请求并向后端服务器进行请求转发的监听端口。通常HTTP协议使用80端口，HTTPS协议使用443端口。端口范围为1~65535。**说明** 在同一个负载均衡实例内，监听端口不可重复。 |
| **监听名称**         | 输入监听名称。长度为1~80个字符，支持字母、数字、短划线（-）、正斜线（/）、英文句号（.）和下划线（_）等字符。 |
| **高级配置**         |                                                              |
| **启用HTTP2.0**      | 选择是否开启ALB前端协议版本为HTTP 2.0。                      |
| **连接空闲超时时间** | 指定连接空闲超时时间，取值范围为1~60秒。在超时时间内一直没有访问请求，负载均衡会暂时中断当前连接，直到下一次请求来临时重新建立新的连接。该功能已经在全部地域开放。**说明** 该功能对使用HTTP/2.0的请求暂不生效。 |
| **连接请求超时时间** | 指定请求超时时间，取值范围为1~180秒。在超时时间内后端服务器一直没有响应，负载均衡将放弃等待，给客户端返回HTTP 504错误码。该功能已经在全部地域开放。 |
| **Gzip数据压缩**     | 开启该配置对特定文件类型进行压缩。目前Gzip支持压缩的类型包括：text/xml、text/plain、text/css、application/javascript、application/x-javascript、application/rss+xml、application/atom+xml和application/xml。 |
| **附加HTTP头字段**   | 选择您要添加的自定义HTTP头字段：添加`X-Forwarded-For`头字段获取来访者真实IP。添加`SLB-ID`头字段获取负载均衡实例ID。添加`X-Forwarded-Proto`头字段获取负载均衡实例的监听协议。添加`X-Forwarded-Clientcert-subjectdn`头字段获取访问负载均衡实例客户端证书的所有者信息。添加`X-Forwarded-Clientcert-issuerdn`头字段获取访问负载均衡实例客户端证书的发行者信息。添加`X-Forwarded-Clientcert-fingerprint`头字段获取访问负载均衡实例客户端证书的指纹取值。添加`X-Forwarded-Clientcert-clientverify`头字段获取访问负载均衡实例客户端证书的校验结果。添加`X-Forwarded-Port`头字段获取实例的监听端口。添加`X-Forwarded-Client-Port`头字段获取访问负载均衡实例客户端的端口。 |
| **开启QUIC升级**     | 选择是否开启QUIC升级。                                       |
| **关联的QUIC监听**   | 选择关联的QUIC监听。**说明** 此参数仅在开启QUIC升级时有效。  |

3. 单击**下一步**。

#### 配置SSL证书

1. 在**负载均衡业务配置向导**的**配置SSL证书**页面，完成以下配置。

   | SSL证书配置        | 说明                                                         |
   | :----------------- | :----------------------------------------------------------- |
   | **选择服务器证书** | 选择一项服务器证书。                                         |
   | **高级配置**       |                                                              |
   | **TLS安全策略**    | 选择一项TLS安全策略。TLS安全策略包含HTTPS可选的TLS协议版本和配套的加密算法套件。 |

2. 单击**下一步**。

#### 选择服务器组

1. 在**负载均衡业务配置向导**的**选择服务器**页面，选择用于处理负载均衡接收到的访问请求的后端服务器组。
2. 单击**下一步**。

#### 配置审核

1. 在**负载均衡业务配置向导**的**选择服务器**页面，确认HTTPS监听的配置信息，然后单击**提交**。

2. 单击**知道了**。

3. 返回**实例**页面，单击[<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210408104900.png" alt="刷新" style="zoom:25%;" />](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1852224161/p242419.png)。

   当ALB实例的健康检查状态为**正常**时，表示后端ECS实例可以正常处理负载均衡转发的请求了。

### 服务器组

每个服务器组均用于将客户的请求路由到一个或多个注册的后端服务器。您可以在创建每个监听的转发规则时，指定服务器组和转发条件。满足转发规则的转发条件时，流量会被转发到相应的服务器组。

应用型负载均衡服务通过设置虚拟服务地址，将添加的同一地域不同可用区内的多台ECS实例虚拟成一个高性能、高可用的应用服务器组。您可以为不同类型的请求创建不同的服务器组，从而将来自外部的请求根据不同的监听规则转发给相应服务器组内不同的端口或后端服务器。

您可以基于每个服务器组定义应用型负载均衡实例的健康检查设置。每个服务器组默认开启健康检查。您在监听的转发规则中指定一个服务器组后，应用型负载均衡将持续对注册到该服务器组的所有服务器的运行状况进行监控。

#### 创建服务器组

在使用应用型负载均衡服务前，您必须创建服务器组并至少添加一台后端服务器来接收负载均衡转发的客户端请求。

前提:

- 在向服务器组添加ECS实例前，确保您已创建了ECS实例并部署了相关应用，用来接收转发的请求。
- 要将流量路由到服务器组中的后端服务器，请在创建监听或监听转发规则时指定服务器组。

| 配置                                                     | 说明                                                         |
| :------------------------------------------------------- | :----------------------------------------------------------- |
| **服务器组名称**                                         | 输入服务器组名称。长度为2~128个字符，必须以大小写字母或中文开头，可包含数字、英文句点（.）、下划线（_）和短划线（-）。 |
| **VPC**                                                  | 从VPC下拉列表中选择一个VPC。只有该VPC下的服务器可以加入到该服务器组。 |
| **选择后端协议**                                         | 选择一种后端协议：**HTTP**（默认）：关联HTTPS、HTTP和QUIC监听。**HTTPS**：关联HTTPS监听。 |
| **选择调度算法**                                         | 选择一种调度算法：**加权轮询**：权重值越高的后端服务器，被轮询到的次数（概率）也越高。**源IP一致性哈希**：相同的源地址会调度到相同的后端服务器。 |
| **开启会话保持**                                         | 开启或关闭会话保持。开启会话保持功能后，负载均衡会把来自同一客户端的访问请求分发到同一台后端服务器上进行处理。 |
| **Cookie处理方式**                                       | 选择一种Cookie处理方式：**植入Cookie**：客户端第一次访问时，负载均衡会在返回请求中植入Cookie（即在HTTP或HTTPS响应报文中插入SERVERID），下次客户端携带此Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器上。**重写Cookie**：负载均衡发现用户自定义了Cookie，将会对原来的Cookie进行重写，下次客户端携带新的Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器。**说明** 此参数仅在开启会话保持功能后生效。 |
| **会话保持超时时间**                                     | 输入会话保持的超时时间，取值范围为1~86400秒。**说明** 此参数仅在开启会话保持功能后生效。 |
| **配置健康检查**                                         | 开启或关闭健康检查。                                         |
| 高级配置                                                 |                                                              |
| **选择并加载健康检查**                                   | 选择并加载一个健康检查。**说明** 您可以创建健康检查，不与服务器组及监听关联，方便下次复用。 |
| **健康检查协议**                                         | 选择健康检查协议类型：**HTTP**：通过发送HEAD/GET请求模拟浏览器的访问行为来检查服务器应用是否健康。**TCP**：通过发送SYN握手报文来检测服务器端口是否存活。 |
| **健康检查方法**                                         | 选择一种健康检查方法：HEAD或GET。**HEAD**：HTTP监听健康检查默认采用HEAD方法。请确保您的后端服务器支持HEAD请求。如果您的后端应用服务器不支持HEAD方法或HEAD方法被禁用，则可能会出现健康检查失败，此时可以使用GET方法来进行健康检查。**GET**：如果响应报文长度超过8K，会被截断，但不会影响健康检查结果的判定。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查协议版本**                                     | 选择一个HTTP协议版本：**HTTP1.0**或**HTTP1.1**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查端口**                                         | 选择健康检查服务访问后端时的探测端口。**后端服务器组端口**：默认使用后端服务器的端口进行健康检查。**指定特定端口**：指定一个特定的端口进行健康检查。取值范围为1~65535。 |
| **健康检查路径**                                         | 输入健康检查页面的URL。长度限制为1~80个字符，支持使用字母、数字和短划线（-）、正斜线（/）、英文句点（.）、百分号（%）、问号（?）、井号（#）和and（&）以及扩展字符集`_;~!（)*[]@$^:',+`。URL必须以正斜线（/）开头。 |
| **健康检查域名**                                         | 输入健康检查的域名。**使用后端服务器的内网IP**（默认）：使用后端服务器的内网IP地址作为健康检查的域名。**指定特定域名**：输入一个域名。长度为1~80个字符，只能使用小写字母、数字、英文句点（.）和短划线（-）。域名中至少包含一个英文句点（.）。英文句点（.）不能出现在开头或结尾。 |
| **健康状态返回码**                                       | 选择健康检查正常的HTTP状态码：**http_2xx**（默认）、 **http_3xx**、**http_4xx**或**http_5xx**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **响应超时时间**                                         | 输入接收来自运行状况检查的响应需要等待的时间。如果后端ECS在指定的时间内没有正确响应，则判定为健康检查失败。取值范围是1~300秒，默认为5秒。 |
| **间隔时间**                                             | 输入进行健康检查的时间间隔。取值范围1~50秒，默认为2秒。      |
| **健康阈值**                                             | 健康检查连续成功多少次后，将后端服务器的健康检查状态由失败判定为成功的次数。可选值2~10，默认为3次。 |
| **不健康阈值**                                           | 健康检查连续失败多少次后，将后端服务器的健康检查状态由成功判定为失败的次数。可选值 2~10，默认为2次。 |
| **将新的配置保存为健康检查模板，方便下次快速复制使用。** | 选择将新的配置保存为健康检查模板。                           |

#### 添加后端服务器

在创建后端服务器组之后，你需要添加后端服务器来处理转发请求。

1. 登录[负载均衡管理控制台](https://slb.console.aliyun.com/slb)。

2. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。

3. 在**服务器组**页面，单击刚创建的服务器组**操作**列下的**编辑后端服务器**。

4. 单击**后端服务器**页签下的**添加后端服务器**。

5. 在**我的服务器**面板，选择后端服务器类型，选中目标服务器，然后单击**下一步**。

6. 在**配置端口和权重**面板，指定添加的服务器的端口和权重，然后单击**添加**。

   权重默认为100，权重越高的服务器将被分配到更多的访问请求。如开启会话保持，可能会造成后端服务器的请求不均匀。

   您可以鼠标浮动至[![批量操作](https://gitee.com/c_honghui/picture/raw/master/img/20210408111005.png)](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0101189061/p208921.png)批量修改服务器的权重：

   - 单击**向下复制**：如果修改当前服务器的权重，该服务器以下所有服务器的权重同步改变。
   - 单击**向上复制**：如果修改当前服务器的权重，该服务器以上所有服务器的权重同步改变。
   - 单击**全部复制**：如果修改当前服务器的权重，该服务器组中所有服务器的权重同步改变。
   - 单击权重右侧的**重置**：将服务器组中所有服务器的权重重组置为默认。

   **注意** 如果权重设置为0，该服务器不会再接受新请求。

7. 单击**添加**。

#### 删除服务器组

如果一个服务器组未被任何监听转发规则的转发操作引用，则可以删除该服务器组。删除服务器组不会影响已注册到服务器组的服务器。如果您不再需要已注册的 ECS实例，则可以停止或终止该实例。

1. 登录[负载均衡管理控制台](https://slb.console.aliyun.com/slb)。
2. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。
3. 单击目标服务器组**操作**列下的**删除**。
4. 单击**确定**。



- 监听

  监听是ALB最小业务单元，监听上需要配置协议与端口以告知ALB需要处理什么流量，例如HTTP协议，80端口。每个应用型负载均衡ALB至少有一个监听，才能开始流量处理与分发。每个ALB最多可以配置50个监听，用于处理不同的业务流量。

- 转发规则

  确定应用型负载均衡ALB实例如何将请求路由到一个或多个后端服务器组中的后端服务器。ALB具备强大的高级路由能力，在传统的路由规则基础上，还可以基于Cookie、Header和Host等多种规则进行转发，实现基于业务的灵活调度。

  服务器组是一个逻辑组，包含多个后端服务器（ECS实例）用于处理ALB分发的业务请求。ALB中服务器组独立于ALB存在，可以将同一服务器组挂载在不同ALB内。服务器组最大可以包含1000个后端服务器。ALB服务器组支持云ECS、ECI、ENI等多种类型的后端服务器。

- 健康检查

  应用型负载均衡ALB通过健康检查来判断后端服务器（ECS实例）的业务可用性。ALB探测服务器组中不健康的服务器组，并避免将流量分发给不健康的服务器组。ALB支持丰富灵活的健康检查配置，如协议、端口、以及各种健康检查阈值。同时ALB提供健康检查模板，可将健康检查模板快速的应用到不同的服务器组。

