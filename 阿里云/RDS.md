# RDS

- 实例：一个独立占用物理内存的数据库服务进程，用户可以设置不同的内存大小、磁盘空间和数据库类型。其中内存的规格会决定该实例的性能。实例创建后可以变更配置和删除实例。
- 数据库：在一个实例下创建的逻辑单元，一个实例可以创建多个数据库，数据库在实例内的命名唯一。
- RDS MySQL仅支持InnoDB和X-Engine两种存储引擎

## 使用限制

| 约束项         | 使用约束                                                     |
| :------------- | :----------------------------------------------------------- |
| 实例参数       | 大部分实例参数可以使用控制台或API进行修改，同时出于安全和稳定性考虑，部分参数不支持修改。 |
| 数据库root权限 | 不提供root或者sa权限。                                       |
| 数据库备份     | 可使用命令行或图形界面进行逻辑备份。仅限通过控制台或API进行物理备份。 |
| 数据库还原     | 可使用命令行或图形界面进行逻辑数据还原。仅限通过控制台或API进行物理还原。 |
| MySQL存储引擎  | 当前仅支持InnoDB引擎和X-Engine引擎。                         |
| 数据库复制     | RDS MySQL提供主备复制架构（基础版除外），其中的备（slave）实例不对用户开放，用户应用不能直接访问。 |
| 实例重启       | 必须通过控制台或API重启实例。                                |
| 网络设置       | 若MySQL 5.5或MySQL 5.6实例位于经典网络且开启了数据库代理，禁止在SNAT模式下开启net.ipv4.tcp_timestamps。 |
| 空间存储       | 若存储空间使用率过高，为防止用户误操作导致数据丢失，将会锁定实例。 |
| 帮助信息       | 当前仅MySQL 8.0支持mysql.help_topic表，可以查询帮助主题的详细内容。其他版本mysql.help_topic表为空。 |
| 实例数量       | 按量付费实例数量限制为30个。您可以前往配额中心申请提升配额。 |

## 创建实例

**类型:**

● 不建议继续购买 Mariadb 类型实例了。
● 5.6(MySQL) 版实际上并不是 RDS，而是阿里云产品云数据库 Polardb。  

**系列：**

![image-20210309102039589](https://gitee.com/c_honghui/picture/raw/master/img/20210309102039.png)

● 基础版：单节点运行，无 SLA 保证，产品功能较少，并且执行变更配置、版本升级等任务时，会出现较长时间的不可用
● 高可用：**主从 (1 主 1 从 ) 双节点**运行，推荐购买，其中**从库是隐藏的高可用节点，不提供服务**，如果需要读写分离，需要购买只读实例，具体会在“只读实例”进行说明。
● 三节点企业版：1 主 2 从三节点运行的版本，目前已经不再支持 5.6 三节点企业版的购买，**5.7 高可用版本支持直接升级三节点企业版**。三节点企业版只有MySQL 提供。

**存储类型：**

RDS 存储数据的磁盘类型，  推荐购买优先级为 : **本地 SSD 高可用** -> 云 SSD 高可用 -> 单机基础版：  

● 本地 SSD 是指引擎位于同一节点的 SSD 盘。将数据存储于本地 SSD 盘。
● SSD 云盘是指基于分布式存储架构的弹性块存储设备 , 将数据存储于 SSD云盘。
● ESSD 云盘是增强型（Enhanced）的 SSD 云盘，增强的原因是 ESSD 采用了 25 GE 网络和 RDMA 技术，读写能力更强和延迟更低。
● 请注意，从性能来说，ESSD 云盘无疑是更适合数据库的，但是 ESSD 云盘数据库由于推出较晚，相比本地 SSD 盘实例来说，功能不如本地 SSD 丰富，比如云 SSD 实例磁盘满后不支持临时解锁。  

**主节点可用区 ：**

如果需要购买 ECS，除了保证同地域外，优先选择同可用区，如果对应的可用区没有资源无法购买，也可以选择其他可用区，不同可用区的网络延迟理论上低于 3ms。有的主可用区的右上角，会提示蓝色数字，这些蓝色数字指的是当前可用区下，已存在的 ECS 与 RDS 实例数量。  

**部署方案：**

![image-20210309112419334](https://gitee.com/c_honghui/picture/raw/master/img/20210309112524.png)

当选择了主节点可用区后，如果选择的系列是高可用版，还需要选择部署方案，部署方案分为单可用区部署与多可用区部署，如果要实现同城容灾的话，可以考虑多可用区部署，即主节点和备节点不在同一个可用区。备节点可用区目前只能自动分配。  

**实例规格：**

● RDS 的规格是产品提前规划好的，无法自由的选择 CPU 数量和内存与 IOPS的数量

● RDS 售卖只售卖 CPU、内存、IOPS、连接数 , 并不售卖和限制 QPS、TPS这些指标，所以，无法评估某个规格支持多少 QPS 和 TPS，一般需要进行实际业务压测才能得出结论。

● 实例规格分为独享类、独占类型（独享的顶配就是独占）、通用型，通用性实例存在轻微的资源复用的情况，较独享实例而言，独享实例完全独享的 CPU 和内存，性能稳定，不会因为物理机上其它实例的行为而受到影响。理论上，同规格的独享和通用，性能差异不大，它们的**差异在稳定性**。

● 由于 RDS 的连接数是产品规格决定的，您**无法像自建数据库那样随意的调整数据库连接数**，比如 mysql，您无法调整 max_connections 参数。当您连接数不足时，我们首先建议的操作是分析连接数不足的原因，售后遇到很多客户连接数不足的原因是非活跃会话长时间不释放导致，此时应考虑业务侧优化，控制长连接会话。当您确认无法通过业务侧优化后，再考虑升级 RDS 的规格。    

**存储引擎：**

![image-20210309112741005](https://gitee.com/c_honghui/picture/raw/master/img/20210309112741.png)

阿里云 RDS for MySQL 不支持 MYISAM、MEMORY 等存储引擎，及时某些系列或者类型您可以创建，也不要使用。  

**表名大小写：**

![image-20210309112846662](https://gitee.com/c_honghui/picture/raw/master/img/20210309112846.png)

如果您的业务表是区分大小写的，需要在此处选择“区分大小写”，创建完成后，不支持修改。  

**小版本升级策略：**

![image-20210309112900361](https://gitee.com/c_honghui/picture/raw/master/img/20210309112900.png)

● 勾选自动升级，有新的内核小版本发布时，将在待处理事件里展示出来，并在选定时间内进行升级。
● 勾选手动升级，也并不意味着一直不会升级，当小版本的生命周期结束的时候，依然会强制升级 ( 同样将会在待处理事件里展示出来 )。
● 阿里云后台系统会在一些极端情况下进行小版本升级，这类小版本升级一般不会做短信或者站内信通知，也不会在待处理事件展示。  

## 设置IP白名单

创建RDS MySQL实例后，暂时还无法访问该实例，需要设置白名单

1. 单击目标实例ID，在左侧导航栏单击**数据安全性**。
2. 单击**添加白名单分组**，填写**分组名称**；或单击已有分组的 **修改** 。
3. 填写需要访问该实例的IP地址或IP段，可加载ecs内网IP

## 设置安全组

创建RDS MySQL实例后，暂时无法访问实例。您需要设置RDS MySQL实例的IP白名单或安全组。

在RDS白名单中添加安全组后，该安全组中的ECS实例就可以访问RDS实例。

## 创建数据库和账号

### 创建高权限账号

RDS MySQL实例支持两种数据库账号：高权限账号和普通账号。

| 账号类型       | 说明                                                         |
| :------------- | :----------------------------------------------------------- |
| **高权限账号** | 只能通过控制台或API创建和管理。一个实例中只能创建一个高权限账号，可以管理所有普通账号和数据库。开放了更多权限，可满足个性化和精细化的权限管理需求，例如可按用户分配不同表的查询权限。拥有实例下所有数据库的所有权限。可以断开任意账号的连接。 |
| **普通账号**   | 可以通过控制台、API或者SQL语句创建和管理。一个实例可以创建多个普通账号，具体的数量与实例内核有关 。需要手动给普通账号授予特定数据库的权限。普通账号不能创建和管理其他账号，也不能断开其他账号的连接。 |

| 账号类型     | 建库数量 | 建表数量 | 用户数             |
| :----------- | :------- | :------- | :----------------- |
| 高权限账号   | 不限     | <20万    | 与实例内核参数相关 |
| 普通权限账号 | 500      | <20万    | 与实例内核参数相关 |

1. 找到目标实例，单击实例ID。
2. 在左侧导航栏中选择**账号管理**。
3. 单击**创建账号**。

### 创建普通帐号

### 创建数据库

账号权限列表：

高权限账号：SELECT  INSERT  UPDATE  DELETE  CREATE  DROP  RELOAD  PROCESS  REFERENCES  INDEX      ALTER  CREATE TEMPORARY TABLES  LOCK TABLES  EXECUTE  REPLICATION SLAVE      REPLICATION CLIENT  CREATE VIEW  SHOW VIEW  CREATE ROUTINE  ALTER ROUTINE      CREATE USER  EVENT  TRIGGER    

普通帐号：

- 只读：SELECT  LOCK TABLES  SHOW VIEW  PROCESS  REPLICATION SLAVE  REPLICATION CLIENT    
- 读写：SELECT  INSERT  UPDATE  DELETE  CREATE    DROP  REFERENCES  INDEX  ALTER  CREATE TEMPORARY TABLES      LOCK TABLES  EXECUTE  CREATE VIEW  SHOW VIEW  CREATE ROUTINE      ALTER ROUTINE  EVENT  TRIGGER  PROCESS  REPLICATION SLAVE      REPLICATION CLIENT
- ddl：CREATE  DROP  INDEX  ALTER  CREATE TEMPORARY TABLES    LOCK TABLES  CREATE VIEW  SHOW VIEW  CREATE ROUTINE  ALTER ROUTINE      PROCESS  REPLICATION SLAVE  REPLICATION CLIENT
- dml：SELECT  INSERT  UPDATE  DELETE  CREATE TEMPORARY TABLES    LOCK TABLES  EXECUTE  SHOW VIEW  EVENT  TRIGGER      PROCESS  REPLICATION SLAVE  REPLICATION CLIENT  

## 连接实例

默认提供内网地址供您内部访问RDS实例，如果需要外网访问，您需要申请外网地址。

```shell
mysql -hrm-bp1457xxxxxx.mysql.rds.aliyuncs.com -P3306 -utestuser -p [-D 数据库名]
```

## 变更实例

### 高可用升级为三节点

前提：

- 实例版本如下：
  - MySQL 5.7高可用版（本地SSD盘）
  - MySQL 8.0高可用版（本地SSD盘）
- 实例没有只读实例。
- 实例内核小版本为20200110或更早的版本。

在**基本信息**页面的**配置信息**区域查看是否有**升级内核小版本**按钮。如果有按钮，请单击按钮查看当前版本是否为**rds_20200110**（请勿升级内核版本）；如果没有按钮，表示内核已经是最新版，不支持升级，您可以购买三节点企业版实例，然后使用数据传输服务迁移数据。

操作：

1. 找到目标实例，单击实例ID。
2. 在**配置信息**区域单击**升级到三节点企业版**。

### 自动或手动主备切换

实例默认为自动切换，当主实例出现故障无法访问时，会自动切换到备实例。

- 主备实例切换过程中可能会有闪断，请确保您的应用程序具有自动重连机制。
- 如果实例下挂载有只读实例，那么主备实例切换后，只读实例的数据会有几分钟的延迟，因为需要重建复制链路、同步增量数据等。
- 在主备实例切换期间，有很多操作无法执行，例如管理数据库和账号、切换网络类型等，建议您选择**可维护时间内进行切换**。

#### 主备切换原因

主备切换后，会发送短信通知您，告知切换原因：

- 风险隐患
- 人工操作
- 实例故障

主备切换后，实例状态会显示**运行中**，您不需要进行任何操作，实例可以正常运行。您可以在实例的**日志管理**页面查看**主备切换日志**。

#### 手动切换主备

1. 找到目标实例，单击实例ID。
2. 在左侧导航栏中，选择**服务可用性**。
3. 在**实例可用性**区域，单击**主备库切换**。
4. 选择切换时间，然后单击**确定**。

#### 临时关闭自动主备切换：

- 大促活动等，不希望主备切换影响系统可用性。
- 重要应用系统升级等，不希望主备切换引进其他变数。
- 重大事件或者稳定保障期，不希望主备切换影响系统稳定性。

1. 单击**主备库切换设置**。
2. 选择**临时关闭**，并设置**临时关闭截止时间：**，然后单击**确定**。

### 设置可维护阶段

为保障云数据库RDS实例的稳定性，后端系统会不定期对实例进行维护操作。默认可维护时间段为02:00~06:00，您可以根据业务规律，将可维护时间段设置在业务低峰期，以免维护过程中可能对业务造成的影响。

- 在进行正式维护前，RDS会给阿里云账号中设置的联系人发送短信和邮件，请注意查收。
- 实例维护当天，为保障整个维护过程的稳定性，实例会在可维护时间段时将实例状态切换为**实例维护中**。当实例处于该状态时，对数据库的访问以及查询类操作（如性能监控）不会受到任何影响，但除了账号管理、数据库管理和IP白名单设置外的变更操作（如升降级、重启等）均暂时无法使用。
- 在可维护时间段内，实例会发生1到2次连接闪断，请确保应用程序具有重连机制。

### 修改数据复制方式

前提：

- MySQL 8.0高可用版（本地SSD盘）
- MySQL 5.7高可用版（本地SSD盘）
- MySQL 5.6高可用版
- MySQL 5.5

复制方式：

- 强同步
  - 应用发起的更新在主实例执行完成后，会将日志同步传输到所有备实例，至少1个备实例收到并存储日志后，事务才完成提交。
  - 在强同步模式下，实例的复制方式会始终保持强同步，无论出现何种状况，都不会退化为异步。
  - 当实例的节点数≥3时，才支持强同步。因此，只有三节点企业版（原金融版）实例支持强同步。三节点企业版实例的数据复制方式无法修改。

- 半同步

  应用发起的更新在主实例执行完成后，会将日志同步传输到备实例，备实例收到日志，事务就算完成了提交，不需要等待备实例执行日志内容。

  当备实例不可用或者主备实例间出现网络异常时，半同步会退化为异步。

- 应用发起更新请求，即进行增加、删除、修改数据的操作时，主实例完成操作后会立即响应应用，同时主实例向备实例异步复制数据。因此，在异步数据复制方式下，备实例不可用时不会影响主实例上的操作，而主实例不可用时可能会导致主备实例数据不一致。

操作：

1. 在左侧导航栏中，单击**服务可用性**。
2. 单击**修改数据复制方式**。

## 升级版本

### 升级内核小版本

支持自动升级或手动升级内核小版本，内核小版本的升级涉及性能提升、新功能或问题修复等。
升级内核小版本是阿里云的内核小版本，不是MySQL的内核版本。

自动升级：

默认自动升级内核小版本，您可以在**基本信息**页面看到**小版本自动升级**的设置情况。阿里云有新的内核小版本发布时，将会推送通知给您。自动升级操作将会在您设置的可维护时间段内进行

手动升级：

当您的RDS MySQL实例所使用的内核小版本生命周期（通常为1年）结束时，阿里云会推送通知给您，告知您实例需要在一个月内升级至最新的稳定版本，之前的内核版本将会下线。

### 升级数据库版本

目前RDS MySQL仅支持直接升级MySQL 5.5到MySQL 5.6，您也可以通过迁移的方式间接升级数据库版本，例如从5.6升级至8.0：

1. 创建新实例
2. 迁移数据到新实例
3. 释放原实例

## 实例参数

为保证实例的稳定，仅支持对控制台中开放的参数进行修改

### 修改单个参数

部分参数修改后不需要重启实例，通常5分钟左右可以生效；部分参数修改后需要重启实例

### 使用参数模板

如果需要批量管理实例的参数，您可以使用参数模板功能，快速应用模板到实例上。

高可用版和基础版提供三种系统参数模板：

- 默认参数模版

  数据安全性最高，但速度较慢。数据复制方式为半同步，涉及数据保护的参数为：

  - InnoDB引擎

    - innodb_flush_log_at_trx_commit = 1
    - sync_binlog = 1

  - X-Engine引擎（当前仅提供默认参数模板）

    sync_binlog = 1

- 异步参数模版

  数据安全性较高，速度较快。数据复制方式为异步，涉及数据保护的参数为：

  - innodb_flush_log_at_trx_commit = 1
  - sync_binlog = 1

- 高性能参数模版

  数据安全性一般，但速度最快。数据复制方式为异步，涉及数据保护的参数为：

  - innodb_flush_log_at_trx_commit = 2
  - sync_binlog = 1000

| 参数                           | 取值 | 说明                                                         |
| :----------------------------- | :--- | :----------------------------------------------------------- |
| innodb_flush_log_at_trx_commit | 1    | 事务提交时，把事务日志从缓存区写到日志文件中，并且立刻写入到磁盘上。 |
|                                | 2    | 事务提交时，把事务日志从缓存区写到日志文件中，但不一定立刻写入到磁盘上。日志文件会每秒写入到磁盘，如果写入前系统崩溃，就会导致最后1秒的日志丢失。 |
| sync_binlog                    | 1    | 事务提交后，将二进制日志文件写入磁盘并立即刷新，相当于同步写入磁盘，不经过系统缓存。 |
|                                | 1000 | 每写入1000次系统缓存就执行一次写入磁盘并刷新的操作，会有数据丢失的风险。 |

### 参数调优

**back_log**

- 适用版本：8.0、5.7、5.6、5.5

- 默认值：3000

- 修改完后是否需要重启：是

- 作用：MySQL每处理一个连接请求时都会创建一个新线程与之对应。在主线程创建新线程期间，如果前端应用有大量的短连接请求到达数据库，MySQL会**限制这些新的连接进入请求队列**，由参数back_log控制。如果等待的连接数量超过back_log的值，则将不会接受新的连接请求，所以如果需要MySQL能够处理大量的短连接，需要提高此参数的大小。

- 现象：如果参数过小，应用可能出现如下错误：

  ```
  SQLSTATE[HY000] [2002] Connection timed out;
  ```

- 修改建议：提高此参数值的大小。

**innodb_autoinc_lock_mode**

- 适用版本：8.0、5.7、5.6、5.5

- 默认值：1

- 修改完后是否需要重启：是

- 作用：在MySQL 5.1.22后，InnoDB为了解决自增主键锁表的问题，引入了参数innodb_autoinc_lock_mode，用于控制自增主键的锁机制。该参数可以设置的值为0、1、2，RDS默认的参数值为1，表示InnoDB使用轻量级别的mutex锁来获取自增锁，替代最原始的表级锁。但是在load data（包括`INSERT … SELECT`和`REPLACE … SELECT`）场景下若使用自增表锁，则可能导致应用在并发导入数据时出现死锁。

- 现象：在load data（包括INSERT … SELECT和REPLACE … SELECT）场景下若使用自增表锁，在并发导入数据时出现如下死锁：

  ```
  RECORD LOCKS space id xx page no xx n bits xx index PRIMARY of table xx.xx trx id xxx lock_mode X insert intention waiting. TABLE LOCK table xxx.xxx trx id xxxx lock mode AUTO-INC waiting；
  ```

- 修改建议：建议将该参数值改为2，表示所有情况插入都使用轻量级别的mutex锁（**只针对row模式**），这样就可以避免auto_inc的死锁，同时在`INSERT … SELECT`的场景下性能会有很大提升。

**query_cache_size**

- 适用版本：5.7、5.6、5.5
- 默认值：3145728
- 修改完后是否需要重启：否
- 作用：该参数用于控制MySQL query cache的内存大小。如果MySQL开启query cache，在执行每一个query的时候会先锁住query cache，然后判断是否存在于query cache中，如果存在则直接返回结果，如果不存在，则再进行引擎查询等操作。同时，insert、update和delete这样的操作都会将query cahce失效掉，这种失效还包括结构或者索引的任何变化。但是cache失效的维护代价较高，会给MySQL带来较大的压力。所以，当数据库不会频繁更新时，query cache是很有用的，但如果写入操作非常频繁并集中在某几张表上，那么query cache lock的锁机制就会造成很频繁的锁冲突，对于这一张表的写和读会互相等待query cache lock解锁，从而导致select的查询效率下降。
- 现象：数据库中有大量的连接状态为`checking query cache for query`、`Waiting for query cache lock`、`storing result in query cache`。
- 修改建议：RDS默认是关闭query cache功能的，如果您的实例打开了query cache，当出现上述情况后可以关闭query cache。

**net_write_timeout**

- 适用版本：8.0、5.7、5.6、5.5

- 默认值：60

- 修改完后是否需要重启：否

- 作用：等待将一个block发送给客户端的超时时间。

- 现象：若参数设置过小，可能会导致客户端出现如下错误：

  ```
  the last packet successfully received from the server was milliseconds ago或the last packet sent successfully to the server was milliseconds ago.
  ```

- 修改建议：该参数在RDS中默认设置为60秒，一般在网络条件比较差时或者客户端处理每个block耗时较长时，由于net_write_timeout设置过小导致的连接中断很容易发生，建议增加该参数的大小。

**tmp_table_size**

- 适用版本：8.0、5.7、5.6、5.5
- 默认值：2097152
- 修改完后是否需要重启：否
- 作用：该参数用于决定内部内存临时表的最大值，每个线程都要分配，实际起限制作用的是tmp_table_size和max_heap_table_size的最小值。如果内存临时表超出了限制，MySQL就会自动地把它转化为基于磁盘的MyISAM表。优化查询语句的时候，要避免使用临时表，如果实在避免不了的话，要保证这些临时表是存在内存中的。
- 现象：如果复杂的SQL语句中包含了group by、distinct等不能通过索引进行优化而使用了临时表，则会导致SQL执行时间加长。
- 修改建议：如果应用中有很多group by、distinct等语句，同时数据库有足够的内存，可以增大tmp_table_size（max_heap_table_size）的值，以此来提升查询性能。

**loose_rds_max_tmp_disk_space**

- 适用版本：5.6、5.5

- 默认值：10737418240

- 修改完后是否需要重启：否

- 作用：用于控制MySQL能够使用的临时文件的大小。

- 现象：如果临时文件超出loose_rds_max_tmp_disk_space的取值，则会导致应用出现如下错误：

  ```
  The table ‘/home/mysql/dataxxx/tmp/#sql_2db3_1’ is full
  ```

- 修改建议：首先需要分析一下导致临时文件增加的SQL语句是否能够通过索引或者其它方式进行优化。其次，如果确定实例的空间足够，则可以提升此参数的值，以保证SQL能够正常执行。

**loose_tokudb_buffer_pool_ratio**

- 适用版本：5.6
- 默认值：0
- 修改完后是否需要重启：是
- 作用：用于控制TokuDB引擎能够使用的buffer内存大小，比如innodb_buffer_pool_size设置为1000MB，tokudb_buffer_pool_ratio设置为50（代表50%），那么TokuDB引擎的表能够使用的buffer内存大小则为500MB。
- 修改建议：如果RDS中使用TokuDB引擎，建议调大该参数，以此来提升TokuDB引擎表的访问性能。

**loose_max_statement_time**

- 适用版本：5.6

- 默认值：0

- 修改完后是否需要重启：否

- 作用：用于控制查询在MySQL的最长执行时间。如果超过该参数设置的时间，查询将会自动失败，默认是不限制。

- 现象：若查询时间超过了该参数的值，则会出现如下错误：

  ```
  ERROR 3006 (HY000): Query execution was interrupted, max_statement_time exceeded
  ```

- 修改建议：如果您想要控制数据库中SQL的执行时间，则可以开启该参数，单位是毫秒。

**loose_rds_threads_running_high_watermark**

- 适用版本：5.6、5.5
- 默认值：50000
- 修改完后是否需要重启：否
- 作用：用于控制MySQL并发的查询数目，比如将rds_threads_running_high_watermark的值设置为100，则允许MySQL同时进行的并发查询为100个，超过限制数量的查询将会被拒绝掉。
- 修改建议：该参数常常在秒杀或者大并发的场景下使用，对数据库具有较好的保护作用。

## 备份

- 自动备份：您可以设置自动备份的时间。自动备份总是备份整个实例的数据。
- 手动备份：您可以随时手动发起数据备份。可以备份整个实例或指定的库表。
- **数据备份**：系统对数据进行备份，并生成备份集。您可以恢复备份集所在时间点的数据。
- **日志备份**：开启日志备份后，基于“数据备份+日志备份”，您可以恢复时间范围内**任意时间点**的数据。
- 数据备份和日志备份存放于阿里云提供的备份空间，**不占用实例的存储空间**。
- 备份在备实例执行，不占用主实例CPU，不影响主实例性能。
- 备份过程中执行耗时长的DDL或更新语句，会导致锁表，进而导致备份失败。

### 备份大小

在实例的**基本信息**页面的右下角，可以查看备份的大小。

备份的大小=数据备份的大小+日志备份的大小

| 日志     | 说明                                                         | 费用                             | 作用                           |
| :------- | :----------------------------------------------------------- | :------------------------------- | :----------------------------- |
| 本地日志 | 实例的原始日志，存放于实例的存储空间。                       | 不涉及费用，但占用实例存储空间。 | 例如，可用于自行搭建主从架构。 |
| 日志备份 | 开启日志备份后，本地日志会实时上传至备份空间，备份空间里的即为日志备份。 | 要费用                           | 实现按时间点恢复。             |

在实例的**监控与报警**页面可以查看本地日志占用的存储空间。

备份的大小可能比数据量大，也可能比数据量小。云盘实例采用快照备份。**快照备份的大小可能远大于数据的大小**

### 自动备份与手动备份

- 只读实例不支持备份设置。
- 备份期间不要执行DDL操作，避免锁表导致备份失败。
- 尽量选择业务低峰期进行备份。
- 表数量超过60万将无法进行备份。表数量过多时建议进行分库。
- 备份的表数量超过5万张将无法进行单库单表恢复。

#### 自动备份

自动备份包括数据备份和日志备份。数据备份无法关闭，您可以修改数据备份的频率。

| 实例类型                                                     | 最低频率 | 最高频率                            |
| :----------------------------------------------------------- | :------- | :---------------------------------- |
| 本地盘实例（高可用版或三节点企业版）<br />云盘实例（基础版） | 每周2次  | 每天1次                             |
| 云盘实例（高可用版）                                         |          | 每15分钟1次（开启**增加快照频率**） |

1. 单击目标实例ID
2. 单击**备份恢复**
3. 选择**备份设置**页签，单击**编辑**
4. 设置以下参数，然后单击**确定**。

数据备份设置：

| 实例类型       | 参数                       | 说明                                                         |
| :------------- | :------------------------- | :----------------------------------------------------------- |
| **所有实例**   | **备份周期**               | 每周至少选2天进行数据备份。                                  |
|                | **备份时间**               | 选择数据备份开始的时间段，例如05:00-06:00。建议设置为业务低峰期。 |
|                | **保留时长**               | 默认为7天。可选范围：<br />云盘版：7~730天。<br />**说明**5.7基础版固定为7天，无法修改。如果开启**秒级备份**，则保留时长固定为7天。<br />本地盘版：7天或以上（小于2的31次方）。<br />保留不超过730天的数据备份为常规备份。<br />保留超过730天的数据备份为归档备份，费用较低。<br />**说明** 如果设置超过730天，或者勾选**实例释放前长期保留**，则还需设置归档备份的保留个数，例如保留每个月最早的2个归档备份。 |
| **本地盘实例** | **实例释放前长期保留**     | 勾选后，只要实例未释放，数据备份一直保留。                   |
|                | **实例释放后保留备份文件** | 选择**保留最后一个**或**全部保留**。<br />**说明**该备份是**永久保留**，当前**0折优惠**。按量付费和包年包月实例都适用。实例释放后，可以在[已删除实例备份](https://rdsnext.console.aliyun.com/rdsDeletedInstanceBackups/cn-hangzhou)页面下载备份进行恢复。 |
|                | **库表备份**               | 开启后将支持[MySQL单库单表恢复](https://help.aliyun.com/document_detail/103175.htm#concept-ocr-swk-ngb)。默认为开启，无法关闭。<br />**说明**<br />仅RDS MySQL 8.0、5.7、5.6 高可用版（本地盘）支持。<br />开启后，新生成的备份文件将逐步采用新的备份格式。 |
| **云盘实例**   | **增加快照频率**           | 勾选后，可设置每N小时备份1次，甚至每15分钟备份一次。<br />**说明**<br />仅高可用云盘版支持。<br />**增加快照频率**和**秒级备份**不能同时开启。<br />开启后，最大保留时长会减少。 |
|                | **秒级备份**               | 开启后，每次备份只需1秒即可完成。<br />**说明**<br />仅高可用ESSD云盘版支持。<br />**增加快照频率**和**秒级备份**不能同时开启。<br />开启后，保留时长固定为7天。<br />开启后，最多支持保留10个备份（包括自动和手动）。已有10个备份时，手动创建备份会失败。 |

日志备份设置：

| 参数             | 说明                                                         |
| :--------------- | :----------------------------------------------------------- |
| **日志备份**     | 开启后可以实现按时间点恢复。默认为开启。<br />**说明** 5.7基础版不支持关闭。 |
| **日志备份保留** | 可选范围：7~730天。默认为7天，<br />必须小于等于数据备份天数。<br />**说明** 5.7基础版固定为7天。 |

#### 手动备份

1. 单击页面右上角的**备份实例**
2. 备份所有库或者特定库表。

| 实例类型   | 备份所有库                                                   | 备份特定库表                |
| :--------- | :----------------------------------------------------------- | :-------------------------- |
| 本地盘实例 | 两种方式：<br />**物理备份**（备份与恢复速度比逻辑备份快）<br />**逻辑备份** > **实例备份** | **逻辑备份** > **库表备份** |
| 云盘实例   | **快照备份**                                                 | 不支持                      |

### 库表级备份

RDS MySQL的自动备份始终备份所有库，您可以手动备份部分库。

| 实例类型                                   | 库表恢复的方式                                               |
| :----------------------------------------- | :----------------------------------------------------------- |
| RDS MySQL 8.0、5.7、5.6 高可用版（本地盘） | 在[自动备份](https://help.aliyun.com/document_detail/98818.htm#section-iz5-u2s-xxr)设置中开启库表备份，开启后，新生成的备份将支持库表恢复。在**备份恢复**页面单击**数据库 库/表级别恢复**，具体请参见[库表恢复](https://help.aliyun.com/document_detail/103175.htm#concept-ocr-swk-ngb)。 |
| 其它实例                                   | [使用mysqldump进行备份恢复](https://help.aliyun.com/document_detail/41833.htm)。 |

1. 在页面右上角，单击**备份实例**。
2. 在对话框中，选择**备份方式**为**逻辑备份**，然后选择**备份策略**为**库表备份**。
3. 把需要手动备份的库添加到右侧，并单击**确定**

### 下载备份

## 恢复

### 恢复mysql数据

前提：

- 运行中且没有被锁定。
- 当前没有迁移任务。
- 如果要按时间点进行恢复，需要确保日志备份已开启。
- 若要按备份集恢复，则原实例必须至少有一个物理备份。

恢复方式：

- 方式一：恢复到一个新实例，经过验证后，再将数据迁回原实例，此功能原名为克隆实例。
  1. 单击目标实例ID，在左侧导航栏单击**备份恢复**。
  2. 单击**数据库恢复**

- 方式二：恢复单库和单表的数据到原实例或新实例。

  前提：

  - 实例为如下版本：
    - MySQL 8.0 高可用版（本地SSD盘）
    - MySQL 5.7 高可用版（本地SSD盘）
    - MySQL 5.6 高可用版
  - 实例存储引擎不为X-Engine。
  - 实例内的表低于50000张才可以使用单库单表恢复功能，超过50000张表时无法使用。
  - 控制台***\*备份恢复\** > \**备份设置\****里开启单库单表恢复功能。

  注：

  - 恢复到原实例过程中**会进行主备切换**，RDS服务可能会出现约30秒闪断，请确保您的应用有自动重连机制。

  - 单库单表恢复功能会将备份文件从tar压缩包变成xbstream文件包，备份文件占用的存储空间会略微增大。

  - 单库单表恢复只会恢复指定的表，请勾选所有涉及到的表。以下几种情况会导致恢复失败：

    - 从最近一份备份集生成时间点到指定恢复的时间点，这段时间内指定的表被删除，恢复会失败。
    - 出现未指定的表时会恢复失败。例如指定恢复表b，但是表b是表a在指点时间点之前重命名的，由于表a没有指定，恢复会失败。

    如果无法确定所有涉及的表，则需要进行实例级别的恢复。

  - 每次最多选择50个库或者表。

  操作：

  | 参数名称             | 说明                                                         |
  | :------------------- | :----------------------------------------------------------- |
  | **回档位置**         | **回档到原实例**：将库/表恢复到原实例中。<br />**回档到新实例**：新购实例，并将库/表恢复到新实例中。 |
  | **还原方式**         | **按备份集**<br />**按时间点**：可以设置为日志备份保留时间内的任意时间点。 |
  | **备份集**           | 选择备份集来进行库/表恢复。<br />**说明** **还原方式**选择**按备份集**时可用。 |
  | **还原时间**         | 选择时间点来进行库/表恢复。**说明** **还原方式**选择**按时间点**时可用。 |
  | **还原模式**         | **逻辑还原**：速度较慢。<br />**物理还原**：速度较快，但是实例会进行主备切换，所有只读实例会重启。如果实例处于运维状态、指定恢复的库表数据量较少或只读实例复制中断时，后端会自动选择**逻辑还原**。**说明** 实例有只读实例时此选项可见。 |
  | **需要恢复的库和表** | 勾选需要恢复的库或表。                                       |
  | **已选择的库和表**   | 显示已勾选的库和表，并可预设恢复后的库/表名称。显示已勾选的库和表的总大小，以及该实例剩余存储空间，请关注剩余存储空间是否足够。**说明** 恢复到原实例时，恢复后库名或表名不能与之前相同，默认会在原库表名后添加`_backup`，您可以在恢复后修改名称。 |

- 方式三：跨地域恢复数据到新实例或已有实例。

