# RDS

## 使用限制

| 约束项         | 使用约束                                                     |
| :------------- | :----------------------------------------------------------- |
| 实例参数       | 大部分实例参数可以使用控制台或API进行修改，同时出于安全和稳定性考虑，部分参数不支持修改。 |
| 数据库root权限 | 不提供root或者sa权限。                                       |
| 数据库备份     | 可使用命令行或图形界面进行逻辑备份。仅限通过控制台或API进行物理备份。 |
| 数据库还原     | 可使用命令行或图形界面进行逻辑数据还原。仅限通过控制台或API进行物理还原。 |
| MySQL存储引擎  | 当前仅支持InnoDB引擎和X-Engine引擎。                         |
| 数据库复制     | RDS MySQL提供主备复制架构（基础版除外），其中的备（slave）实例不对用户开放，用户应用不能直接访问。 |
| 实例重启       | 必须通过控制台或API重启实例。                                |
| 网络设置       | 若MySQL 5.5或MySQL 5.6实例位于经典网络且开启了数据库代理，禁止在SNAT模式下开启net.ipv4.tcp_timestamps。 |
| 空间存储       | 若存储空间使用率过高，为防止用户误操作导致数据丢失，将会锁定实例。 |
| 帮助信息       | 当前仅MySQL 8.0支持mysql.help_topic表，可以查询帮助主题的详细内容。其他版本mysql.help_topic表为空。 |
| 实例数量       | 按量付费实例数量限制为30个。您可以前往[配额中心](https://quotas.console.aliyun.com/)申请提升配额。 |







### 创建实例

**计费方式:**

![image-20210309101447379](https://gitee.com/c_honghui/picture/raw/master/img/20210309101447.png)

包年包月实例购买后，不支持手动释放。
按量付费实例是指按小时计费的实例，只要购买了实例，无论是否使用，每小时都会计费。按量实例支持手动释放，目前包年包月计费还不支持直接换为按量计费方式。  

**地域:**

如果需要购买 ECS，推荐购买同地域，同地域才可以直接（直接的意思是不需要其他配置，默认互通）实现内网互通。  

**类型:**

● 不建议继续购买 Mariadb 类型实例了。
● 5.6(MySQL) 版实际上并不是 RDS，而是阿里云产品云数据库 Polardb。  

**系列：**

![image-20210309102039589](https://gitee.com/c_honghui/picture/raw/master/img/20210309102039.png)

● 基础版是指单节点运行，无 SLA 保证，产品功能较少，并且执行变更配置、版本升级等任务时，会出现较长时间的不可用，正式业务不建议购买，MySQL 5.7 系列的基础版支持直接升级高可用版，SQL Server 基础版目前
也支持直接升级高可用版。
● 高可用是指**主从 (1 主 1 从 ) 双节点**运行，推荐购买，其中**从库是隐藏的高可用节点，不提供服务**，如果需要读写分离，需要购买只读实例，具体会在“只读实例”进行说明。
● 三节点企业版（原名金融版，这个名称与金融云没有直接关系）是指 1 主 2 从三节点运行的版本，目前已经不再支持 5.6 三节点企业版的购买，**5.7 高可用版本支持直接升级三节点企业版**。三节点企业版只有MySQL 提供。
● 集群版是基于的 SQL Server 源生 Always On 技术，目前只有 2017 版支持，支持只读实例与读写分离。集群版只有 SQL Server 提供。  

**存储类型：**

RDS 存储数据的磁盘类型，  推荐购买优先级为 : **本地 SSD 高可用** -> 云 SSD 高可用 -> 单机基础版：  

● 本地 SSD 是指引擎位于同一节点的 SSD 盘。将数据存储于本地 SSD 盘。
● SSD 云盘是指基于分布式存储架构的弹性块存储设备 , 将数据存储于 SSD云盘。
● ESSD 云盘是增强型（Enhanced）的 SSD 云盘，增强的原因是 ESSD 采用了 25 GE 网络和 RDMA 技术，读写能力更强和延迟更低。
● 请注意，从性能来说，ESSD 云盘无疑是更适合数据库的，但是 ESSD 云盘数据库由于推出较晚，相比本地 SSD 盘实例来说，功能不如本地 SSD 丰富，比如云 SSD 实例磁盘满后不支持临时解锁。  

**主节点可用区 ：**

如果需要购买 ECS，除了保证同地域外，优先选择同可用区，如果对应的可用区没有资源无法购买，也可以选择其他可用区，不同可用区的网络延迟理论上低于 3ms。有的主可用区的右上角，会提示蓝色数字，这些蓝色数字指的是当前可用区下，已存在的 ECS 与 RDS 实例数量。  

**部署方案：**

![image-20210309112419334](https://gitee.com/c_honghui/picture/raw/master/img/20210309112524.png)

当选择了主节点可用区后，如果选择的系列是高可用版，还需要选择部署方案，部署方案分为单可用区部署与多可用区部署，如果要实现同城容灾的话，可以考虑多可用区部署，即主节点和备节点不在同一个可用区。备节点可用区目前只能自动分配。  

**实例规格：**

● RDS 的规格是产品提前规划好的，无法自由的选择 CPU 数量和内存与 IOPS的数量

● RDS 售卖只售卖 CPU、内存、IOPS、连接数 , 并不售卖和限制 QPS、TPS这些指标，所以，无法评估某个规格支持多少 QPS 和 TPS，一般需要进行实际业务压测才能得出结论。

● 实例规格分为独享类、独占类型（独享的顶配就是独占）、通用型，通用性实例存在轻微的资源复用的情况，较独享实例而言，独享实例完全独享的 CPU 和内存，性能稳定，不会因为物理机上其它实例的行为而受到影响。理论上，同规格的独享和通用，性能差异不大，它们的**差异在稳定性**。

● 由于 RDS 的连接数是产品规格决定的，您**无法像自建数据库那样随意的调整数据库连接数**，比如 mysql，您无法调整 max_connections 参数。当您连接数不足时，我们首先建议的操作是分析连接数不足的原因，售后遇到很多客户连接数不足的原因是非活跃会话长时间不释放导致，此时应考虑业务侧优化，控制长连接会话。当您确认无法通过业务侧优化后，再考虑升级 RDS 的规格。    

**网络类型 ：**

![image-20210309112716145](https://gitee.com/c_honghui/picture/raw/master/img/20210309112716.png)

- 如果 ECS 是专有网络，RDS 购买时需要选择与 RDS 相同的专有网络才可以内网直接互通。
- 一个地域可以创建多个专有网络，一个专有网络下，也可以创建多个交换机，交换机创建必须以可用区为基础。即创建交换机时，必须选定交换机所在的可用区。 

**存储引擎：**

![image-20210309112741005](https://gitee.com/c_honghui/picture/raw/master/img/20210309112741.png)

阿里云 RDS for MySQL 不支持 MYISAM、MEMORY 等存储引擎，及时某些系列或者类型您可以创建，也不要使用。  

**表名大小写：**

![image-20210309112846662](https://gitee.com/c_honghui/picture/raw/master/img/20210309112846.png)

如果您的业务表是区分大小写的，需要在此处选择“区分大小写”，创建完成后，不支持修改。  

**小版本升级策略：**

![image-20210309112900361](https://gitee.com/c_honghui/picture/raw/master/img/20210309112900.png)

● 勾选自动升级，有新的内核小版本发布时，将在待处理事件里展示出来，并在选定时间内进行升级。
● 勾选手动升级，也并不意味着一直不会升级，当小版本的生命周期结束的时候，依然会强制升级 ( 同样将会在待处理事件里展示出来 )。
● 阿里云后台系统会在一些极端情况下进行小版本升级，这类小版本升级一般不会做短信或者站内信通知，也不会在待处理事件展示。  

## RDS数据库实例详情页

### 基本信息

![image-20210309113857577](https://gitee.com/c_honghui/picture/raw/master/img/20210309113857.png)

#### 迁移可用区

标记②处的“迁移可用区”，可以将实例迁移到其他可用区（云 SSD 实例不支持）：

● 如果交换机无法选择，说明您选择的 VPC 下的交换机所在的可用区，没有与待迁移可用区一致的，需要更改 VPC 或者手动创建符合要求的交换机。
● 切换时间并不代表迁移开始时间，无论您选择何种切换时间，迁移任务都是马上开始，实例状态会马上由“运行中”变为“迁移中”，如果选择运维时间切换，在运维时间前，任务会自动暂停并等待运维时间切换。反之立即切换，所以这个切换时间控制的是闪断的发生时间，而不是迁移开始时间。
● **切换会造成 30s 左右的闪断**，业务需要进行重连，重连的意思是，数据库的连接断开后，程序会自动检测然后重新连接，这方面的技术实现，您可以网上搜索或者与您的技术人员沟通。
● 任务存在一种情况，比如您运维时间为 23 点 ~24 点，如果在 22 点发起迁移但是在 23 点前，迁移数据未完成，则无法正常进入暂停状态等待切换，此时任务会继续运行直到可正常暂停任务并等待下一个运维时间段时间段切换 , 如果下一个运维时间依然不满足暂停条件（这种情况非常少见），则任务会继续运行直到可正常暂停任务并等待下一个运维时间段时间段切换，循环往复，如果出现这种情况，请反馈阿里云售后核实。  

![image-20210309114633190](https://gitee.com/c_honghui/picture/raw/master/img/20210309114633.png)

#### 重启数据库

标记③处的“重启数据库”，类似于我们在自己服务器上停止掉 MYSQL的线程重新启动一样。  

● 重启的时间正常在 **10 分钟以内**完成，重启会造成实例访问异常，请**在业务低峰期操作**。
● 建议您在重启之前，先确认 CPU 跑满的原因，然后再重启，避免重启后再次跑满。  

#### 备份实例

标记③处的“备份实例”，点击后会对实例做备份，类似于我们在自己的 服务器上备份 MySQL 一样，其中，本地 SSD 盘实例的备份，分为**物理备份和逻辑备份**，云 SSD 的备份，只有快照备份：  

● 物理备份是指直接备份磁盘的物理文件，一般借助 **xtrabackup** 实现
● 逻辑备份相当于我们借助 **MySQLdump** 的方式备份的文件，推荐物理备份
● 高可用实例的备份一般**在备库（隐藏的从节点）进行**，所以备份不影响主节点
● 物理备份存在失败的可能，我们遇到**最多的导致备份失败的原因是实例表数量过多**，一般情况下，**60W 以内的表数量**，备份出现问题的几率较低。
● **备份期间尽量避免执行 DDL 操作**（alter 等操作），避免影响备份，导致备份失败。  
● 执行备份时，进度一直 25%，这点目前是正常的，在备份没完成前，备份会一直处于 25% 不会做任何更新。  

####　实例分布

标记④处的实例分布，分别代表当前这个实例是否存在只读实例、灾备实例以及分析实例。  

- 只读实例 ：

很多情况下，主实例如果出现性能瓶颈，单纯的升配无法解决业务负载的情况下，可以考虑增加只读节点，分摊业务负载  

● 需要新建一个实例，这个实例与主实例不同，但是同步主实例数据。
● 只读实例，只支持按量付费，不支持包年包月。
● 一个主实例下的只读实例不是无限的，主实例内存小于 64G 的最多允许 5 个，大于 64G 的最多 10 个。
● 只读实例并不要求必须与主实例的可用区一致。
● 只读实例**肯定存在延迟**，只是延迟大和小的区别，一般只读实例是秒级延迟，如果您出现延迟非常大的问题并且正在发生，请参考该文档进行判断： https://yq.aliyun.com/articles/692087?spm=a2c4e.11155435.0.0.6ff-363b54ixTeg。  

● 只读实例，无法备份。
● 只读实例无 Binlog，这也就意味着您如果要自建 Slave, 不可以选择只读节点。
● 只读实例有独立于主实例的链接地址，**可以单独连接**。
● 当只读实例存在时，主实例无法直接释放，需要先删除只读实例，才可以释放主实例  

![image-20210309120023680](https://gitee.com/c_honghui/picture/raw/master/img/20210309120023.png)

### 账号管理

#### 创建账号

标记①处用来创建数据库账户，新购买的 RDS 是**没有账户**的，我们在自己的服务器或者电脑上自己创建的 MySQL 会初始化一个 root(super 权限 ) 管理账户，我们可以以 root 账户登陆，但是 RDS 并非如此，需要我们手动创建账户才可以登陆 ：

● RDS 严格管控账户权限，账户分为**高权限账户**与**普通账户**，高权限账户只是比普通账户权限大一些，但不是 super 权限账户，无法进行系统更改。  

● 阿里云 RDS 不提供 super 权限账户 ( 即使您可以创建名为“root”的账户，  也并非和自建 MySQL 一样的 super 权限 )。  

● 高权限账户与普通账户的权限区别可以参考：
https://help.aliyun.com/document_detail/146395.html?spm=a2c4g.11174283.6.803.7f405b83KIOj47  

● 您可能看到一些账户不是您创建的，在访问数据库，例如“root(MySQL 5.7以上为 aliyun_root)”、“aurora”、“RDS_service”、“aurora_proxy”这些都是系统账户，可以忽略，它们分别的作用是本地运维账号 ( 用于实例管控，例如修改内核参数、查询实例状态等 )、远程管控访问账号 ( 用于远程访问管理实例，例如主备切换、实例监控等 )、数据库代理服务账号 ( 在开启数据库代理服务以后，通过这个账号来转发连接 )。  

● 目前 RDS 控制台创建账户，账户的 host( 与开源 MySQL 的 host 含义一致 )默认为“%”，您当前**无法在控制台创建 host 非“%”的账户**。  

● 如果您需要管控账户的 host，需要使用 create user 命令进行创建（就像开源MySQL 一样），然后借助 grant 命令进行授权，只有创建高权限账户才能这样操作（普通账户不支持），要操作这一步需要您对开源 MYSQL 的账户管理和访问控制有较基础的了解。如果您创建账户后，遇到连接问题，可以参考这里：
https://yq.aliyun.com/articles/158321?spm=5176.100239.0.0.xN4KBm
https://yq.aliyun.com/articles/164796?spm=a2c4e.11155435.0.0.88c51842pUENHk  

● 我们建议您不要在 RDS 里创建过多的表 ( **建议少于 20W 表数量** ), 避免影响RDS 自身的物理备份，导致备份失败。  

#### 服务授权账号

标记②处是为了阿里云售后能够有权限访问您的数据库数据所用，一般用来排查问题  

### 重置密码

标记③处的“重置密码”，如果创建账户后，忘记了密码，可以在此重置密码  

● 重置普通账户的密码时，不要勾选“同时重置账号”选项，这个只供重置高权限账户时使用，否则会出错，另外，不是您创建的账户（比如当您使用 DTS 或者 DRDS 时，这些产品会创建自身的账户来访问您
的 RDS，一般会在账户描述部分添加系统标识，如“Created by DRDS,Donot change password”），请不要对其修改密码，影响 DTS 和 DRDS 的使用，我们遇到非常多的客户出现过这类问题，处理往往非常困难和耗时，进而
影响客户业务。  

### 数据库管理

使用高权限账户登陆RDS 后，即可使用 create database 命令进行创建。  

### 备份恢复

[高可用版](https://help.aliyun.com/document_detail/127875.htm#concept-1443745)和[三节点企业版](https://help.aliyun.com/document_detail/51701.htm#concept-yqy-zvw-5db)实例：备份在备实例执行，不占用主实例CPU，不影响主实例性能。

#### 备份方式

- 自动备份：您可以设置自动备份的时间。自动备份总是备份整个实例的数据。
- 手动备份：您可以随时手动发起数据备份。可以备份整个实例或指定的库表。

#### 备份组成

阿里云会按照您“备份设置”的策略，自动对阿里云数据库进行备份。  

备份分为**数据备份**与**日志备份**，阿里云会把这些备份放到阿里云内部的OSS 中保存，**不占用实例的存储空间**。

![image-20210309150118697](https://gitee.com/c_honghui/picture/raw/master/img/20210309150118.png)

##### 数据备份

系统对数据进行备份，并生成备份集。您可以恢复备份集所在时间点的数据。

标记①处的“数据备份”，存放的是数据库的数据备份（不包含 Binlog），这些数据，包括 MySQL 内部系统数据库与您创建的业务数据库。  

● 备份开始 / 结束时间 : 代表这个备份集的开始和结束时间，如果您要判断一次备份的耗时，这里非常有参考依据。  

● 备份大小：一般不会有太大的变化，如果您发现某一此备份比前一次备份大小差异很大，您可以下载具体的备份文件，解压后进行对比。  

● 备份集恢复时间点 : 目前还不可用，所以一直是 0。

● 备份方法：目前有 3 种，分别是物理备份、逻辑备份、快照备份（云 SSD 盘才会有）。  

● 备份类型：分为全量（物理备份）和单库（单库一般是逻辑备份时才会出现）。  

● 备份所在实例编号：指的是发起备份所在的节点，前面章节已经讨论过，高可用实例备份是在备库，主库和备库有不同的编号，此处可以进行区分。  

● 下载：主要用来下载备份文件，如果您执行 wget 下载时出现 403 错误，请在下载地址 URL 前后加英文单引号来避免：wget‘url’。另外，快照备份不支持下载。因为快照备份比较特殊，下载后也无法使用。  

●  目前 RDS **不支持在原实例上对数据进行全量恢复**，但是可以支持在原实例上恢复某个表或者库。  

数据备份在某些情况下可以删除：

● 仅支持 MySQL 的双机高可用版本。  

● 当关闭日志备份时（意味着 RDS 实例不再支持按时间点恢复功能）。可删除存储时长在 7 天以上的任意数据备份文件。  

● 当开启日志备份时，可删除数据备份范围为超出日志备份保留时间的备份文件。  

##### 日志备份

开启日志备份后，基于“数据备份+日志备份”，您可以恢复时间范围内**任意时间点**的数据。

标记①处的“日志备份”是指 Binlog 日志的备份  

![image-20210309153537512](https://gitee.com/c_honghui/picture/raw/master/img/20210309153537.png)

这里展示了所有目前存在于“备份空间”里的 Binlog 文件，“Binlog 文件记录开始时间”与“Binlog 文件记录结束时间”取自 Binlog 内部的时间戳，同一个“Binlog 所在实例编号”的“Binlog 文件名”是连续的 , 它们的时间也是连续的  

● 文件大小：指的当前 Binlog 文件大小，通常情况下，当 Binlog 大小超过 500MB 时会切换到下一序号文件继续写入。老的 Binlog 文件并不会立刻上传，而是异步上传。    

● 下载：要用来下载备份空间里的 Binlog 文件，如果您执行 wget 下载时出现403 错误，请在下载地址前后加英文单引号来避免：wget ‘url’。

● 强烈推荐开启日志备份。

#### 备份设置

- 只读实例不支持备份设置。
- 备份期间不要执行DDL操作，避免锁表导致备份失败。
- 尽量选择业务低峰期进行备份。
- 表数量超过60万将无法进行备份。表数量过多时建议进行分库。
- 备份的表数量超过5万张将无法进行[单库单表恢复](https://help.aliyun.com/document_detail/103175.htm#concept-ocr-swk-ngb)。

##### 自动备份

RDS的自动备份总是备份所有库表，不支持只备份一部分。

标记①处的“备份设置”，用来设置 RDS 的数据备份和日志备份的保留时间、备份周期等策略。  

![image-20210309155016182](https://gitee.com/c_honghui/picture/raw/master/img/20210309155016.png)

![image-20210309155232952](https://gitee.com/c_honghui/picture/raw/master/img/20210309155233.png)

![image-20210309155315558](https://gitee.com/c_honghui/picture/raw/master/img/20210309155315.png)

● 备份周期：每周至少选两天进行备份，**日志备份是实时备份的**，无法设置备份周期。  

● 备份时间：是指开始数据备份的时间段，只能设置数据备份，不能控制日志备份。  

● 保留时长：这里是重点的重点，RDS 目前的数据备份存储时间上限没有限制（但是日志备份存储时间为 7~730 天之间），分为**常规备份**（数据备份保留时间在 730 天以内的）和**归档备份**（数据备份保留时间在 730 天以外的）。归档备份还可以设置保留周期，即“归档备份保留”，分为每周 ( 最多 7 个 )、每月( 最多 31 个 ) 和全部（全部归档的数据备份）。  

● 归档备份保留：的含义与“备份周期”类似，设计这个选项的目的是很多场景下归档的备份没必要全部保留，所以增加了策略选择，您可以指定一周或者一个月只保留几个或者全部保留归档备份。  

##### 日志备份

标记①处的“本地日志设置”主要用来设置“存储空间”里的 Binlog日志  

Binlog 是开源 MySQL 的一种日志记录形式，  可以帮助我们恢复数据，但是 Binlog 日志不能一直保存下去，
因为它会占用磁盘空间  

RDS for MySQL 也有 Binlog 日志，它的 Binlog 是**默认开启**的（无法关闭）  

登陆数据库执行 :`show binary logs`查看主节点 ( 高可用的从节点您看不到 )Binlog 数量以及大小  

如果您开启了日志备份，“存储空间”里的 Binlog 会进行备份并上传到“备份空间 ( 阿里云内部 OSS)”然后清理 ( 清理策略就是“本地日志设置”) 掉“存储空间”里的 Binlog。    

![image-20210309152848107](https://gitee.com/c_honghui/picture/raw/master/img/20210309152848.png)

● 保留时长：保存在“存储空间”里的 Binlog的保留时长，超过这个时长范围的 Binlog，会被清理，单位是小时，这个功能类似于开源 MySQL 的这个参数 expire_logs_days。
● 空间使用率不超过：用来保证“存储空间”里的 Binlog 总占用大小小于当前购买的“存储空间”大小，超过这个使用率，会对 Binlog 进行清理。
● 保留个数：用来限制“存储空间”里的 Binlog 保留数量 (show binary logs 可以看到 )，
● 可用空间保护：是当“存储空间”的使用率高于 80%（这里并不特指 Binlog而 是 所 有 数 据 文 件）或 者“存 储 空 间 ” 剩 余 空 间 不 足 5G 时， 强 制 清 理Binlog，清理的前提是 Binlog 确实占用了空间，如果 Binlog 数量和空间已经到了收缩的极限了（RDS 必须要存留 1 个 Binlog），不会进行清理。  

#### 数据库恢复

##### 前提条件

原实例需要满足如下条件：

- 运行中且没有被锁定。
- 当前没有迁移任务。
- 如果要按时间点进行恢复，需要确保日志备份已开启。
- 若要按备份集恢复，则原实例必须至少有一个物理备份。

##### 恢复方式

- 方式一：恢复到一个新实例，经过验证后，再将数据迁回原实例，此功能原名为克隆实例。
- 方式二：恢复单库和单表的数据到原实例或新实例。
- 方式三：跨地域恢复数据到新实例或已有实例。

标记②处的“数据库恢复 ( 原克隆实例 )”可以进行数据恢复。我们本地自建数据库数据丢失要恢复的时候，有 **2 种恢复方法**：

一是借助一个数据**误操作之前的全量备份**以及该**全量备份后面的 Binlog 文件**（数据误删除之前）来恢复
二是直接恢复数据**误操作之前的全量备份**文件  

恢复方式：

**"按备份集”**恢复是指恢复“数据备份”页面里的某一次备份完成的备份集  

**“按时间点”**恢复可以恢复到备份范围内的某一个秒级时间点  

比如我们在 2020-05-10 20:43:20 秒误操作，删除了一个表的数据，我们可以通过“按时间点”恢复 2020-05-10 20:43:19 秒的数据，等数据恢复后（**数据恢复到一个新的实例**里，您需要新购实例，您可以按量购买，按时计费，节省费用），在恢复实例里找到您需要的数据，**导出后再导入原 RDS**( 数据丢失的 RDS)。除了还原方式，还需要注意，规格越大理论上恢复时间越快，存储空间要大于等于原数据库实例。  

#### 库表级别恢复

回档到新实例：

![image-20210309161839224](https://gitee.com/c_honghui/picture/raw/master/img/20210309161839.png)

![image-20210309162030815](https://gitee.com/c_honghui/picture/raw/master/img/20210309162030.png)

回档到原实例：

![image-20210309162150784](https://gitee.com/c_honghui/picture/raw/master/img/20210309162150.png)

● 回档位置：用来选择把要恢复的库和表恢复到当前的实例还是新的实例（新实例会在恢复操作过程中购买），如果您要恢复到当前实例，为了避免库名或者表明冲突，恢复后的名字后面都会在原库名或者表名的后面，加一个“_
backup”，而恢复到新实例并不需要如此。
● 还原方式：可以选择是恢复某个备份集里的库或者表还是把要恢复的库或者表按时间点进行恢复。
● 还原模式：该模式，只有在恢复到当前实例时才会出现，逻辑恢复类似于 SQL的写入，物理恢复类似于物理文件的写入。  

#### 一键上传binlog

把“存储空间”里还没有到上传 ( 之前我们在“本地日志设置”讨论过 ) 的 Binlog，上传到“备份空间”然后再清理掉“存储空间”里的 Binlog，所以点击这个功能，“备份空间”里的 Binlog 会增加 ( 增加的程度，与目前“存储空间”里的 Binlog 数量有关 ),“存储空间”里的 Binlog 会减少 ( 减少的程度，与目前“存储空间”里的 Binlog 数量有关 )。点击后，会将“存储空间”里已经不再写入的Binlog 文件上传到备份空间中（所以永远会留一个正在写入的 Binlog），这个功能并不遵循“本地日志设置”的策略进行 Binlog 的保留。  

### 数据库连接

阿里云 RDS 的链接地址是一个字符串  

![image-20210309171326993](https://gitee.com/c_honghui/picture/raw/master/img/20210309171327.png)

● 十二种 MySQL 连接错误实例：
● https://yq.aliyun.com/articles/158321?spm=5176.100239.0.0.xN4KBm
● 阿里云 ECS 无法连接阿里云数据库的一般原因：
● https://yq.aliyun.com/articles/164796?spm=a2c4e.11155435.0.0.56ae1842rdH6Al  

## RDS实例数据库代理

#### 代理服务

如果您不开数据库代理,请求经过 SLB 后会直达 RDS 数据库节点 

如果您开了数据库代理这个产品，请求会从 SLB 发给 Proxy，然后再由 Proxy 转发给 RDS，因为经过一层转发，您的 SQL响应可能会有非常非常低的延迟增加（不会影响业务请求）。 

**要开通读写分离，必须先开通数据库代理**，开通数据库代理并不一定要开通读写分离。      

![image-20210309172649733](https://gitee.com/c_honghui/picture/raw/master/img/20210309172649.png)

![image-20210309172730317](https://gitee.com/c_honghui/picture/raw/master/img/20210309172730.png)

支持的版本和实例类型有 :

```text
MySQL 8.0 三节点企业版（内核小版本 20191204或以上）
MySQL 8.0 高可用版（内核小版本 20190915 或以上）
MySQL 5.7 三节点企业版（内核小版本 20191128 或以上）
MySQL 5.7 高可用版（内核小版本20190925 或以上）
MySQL 5.6 高可用版（内核小版本 20200229 或以上）
华东 1（杭州）可用区 D、华南 1（深圳）金融可用区 B 不支持开通代理服务
```

#### 读写分离

![image-20210309173433899](https://gitee.com/c_honghui/picture/raw/master/img/20210309173433.png)

读写分离的地址与代理服务的地址完全一样，RDS 数据库代理**通过权重以及延迟阈值的设置来分发请求到不同的节点**，您可以点击“设置读写分离”来更改权重和延迟阈值 ：

![image-20210309173457065](https://gitee.com/c_honghui/picture/raw/master/img/20210309173457.png)

延迟阈值：指的是只读延迟的时间，超过这个阈值，请求将不会发送到对应的只读节点 ( 不论该只读实例的权重是多少 )。  

读权重分配：0代表不接受读请求

测试读写分离权重是否生效，您可以通过长连接执行 10000 次 `select @@server_id`; 命令，然后统计输出结果的每个server_id 出现的次数，来验证读权重的负载比例。  

主实例的权重设置为 0 了，主实例依然有大量的读请求，根据经验，原因一般是下面 5 点：  

● 显式事务导致，显式事务是指 begin、start transaction、set autocommit=0这类请求触发，这类请求开启显式事务后，其后续的请求，会全部被读写分离分发到主节点。这里有一个重点功能叫“事务拆分”，关于事务拆分稍后的章节会做具体说明。
● 程序配置地址错误，业务没有完全使用读写分离地址，部分业务使用了主实例
地址，这样的话，无法进行分发。连接主实例地址的请求，会全部到主实例。
● 程序请求属于 Multi Statements 类型，Multi Statements 类型请求会强制发
到主库，Multi Statements 是指一个请求里包含多个 SQL，类似下面这种 :
● $sql =“SELECT COUNT(*) AS _num FROM test; INSERT INTO
test(id) VALUES (1); SELECT COUNT(*) AS _num FROM test;“;
● $MySQLi->multi_query($sql);
● 查询请求使用了临时表，会强制发到主库。
● 查询请求使用了自定义函数，会强制发到主库。  

转发逻辑

全部发往主实例：
● 所有 DML 操作（INSERT、UPDATE、DELETE、SELECT FOR UPDATE）。
● 所有 DDL 操作（建表 / 库、删表 / 库、变更表结构、权限等）。
● 所有事务中的请求。
● 用户自定义函数。
● 存储过程。
● EXECUTE 语句。
● Multi Statements。
● 使用到临时表的请求。
● SELECT last_insert_id()。
● 所有对用户变量的查询和更改。
● SHOW PROCESSLIST。
● KILL（SQL 语句中的 KILL，非命令 KILL）。  

发往只读实例或主实例：
● 非事务中的读请求。
● COM_STMT_EXECUTE 命令。  

在只读实例和主实例上都进行发送：
● 所有系统变量的更改。
● USE 命令。
● COM_STMT_PREPARE 命令。
● COM_CHANGE_USER/COM_QUIT/COM_SET_OPTION 等命令。  

## RDS监控

监控类型：

![image-20210309205239909](https://gitee.com/c_honghui/picture/raw/master/img/20210309205246.png)

## RDS实例数据安全性

![image-20210309205619815](https://gitee.com/c_honghui/picture/raw/master/img/20210309205619.png)

### 白名单设置

无论是我们本地电 脑访问RDS还是使用阿里云ECS访问RDS，都需要把客户端的 IP**加入白名单中， 才可以正常访问。**

如果不知道本地真实公网IP：

1. 将公司的公网网段或者0.0.0.0/0添加到RDS白名单

2. 连接RDS实例

   ```shell
   mysql -hRDS连接地址 -u账户 -p密码 -P3306
   ```

3. 查询进程信息，对应的 **Host** 就是本地设备的真实出口 IP 地址

   ```mysql
   show processlist
   ```

4. 将步骤 1中在白名单中添加的 0.0.0.0/0 条目删除，添加上真实的本地公网IP。

#### 添加白名单分组

是为了管理白名单地址，比如我们可以 把分组名称命名为业务相关的名字，添加业务相关的 IP进入该分组：

![image-20210309211639329](https://gitee.com/c_honghui/picture/raw/master/img/20210309211639.png)

网络隔离模式：

分为**通用白名单模式**（即白名单不区分经典网络及专有网络，添加的 IP地址或者 IP段，既可以适用于经典网络地址连接RDS时验证，也 可以适用于专有网络地址连接RDS时验证）和**高安全白名单模式** ( 即白名单中区分 经典网络的 IP白名单分组和专有网络的 IP白名单分组。连接专有网络地址时，验证专有网络白名单的分组，连接经典网络地址时，验证经典网络白名单的分组 )。建议切换高安全模式。

组内白名单：

0.0.0.0/0（请不要写成 0.0.0.0）指的是允许所有连接通过对应的网络地址连接这个 RDS，一般用来做测试，正式业务不建议您这样设置。

添加安全组：

可以把某个安全组下的 ECS 全部加到RDS这个功能下面，加完后，这个安全组下的所有服务器都可以直接连接这个 RDS( 不需要再添加白名单了)。

## RDS实例服务可用性

主节点提供服务,备节点隐藏作为HA高可用

![image-20210309221115719](https://gitee.com/c_honghui/picture/raw/master/img/20210309221115.png)

### 主备切换设置

该功能设置在主节点异常后，是否进行**自动的主备切换**，推荐开启。您如果有特殊的需求（比如压测性能等），可以临时关闭。

### 主备库切换

该功能可以手动人为的实现主备切换，该功能点击后，您可以有 2 个选择：一 是马上进行主备切换，二是在维护时间进行主备切换。

### 修改数据复制方式

手动转换异步和半同步

半同步是指当应用发起的更新并且在主实例执行完成后，主实例会将日志（Binlog）传输到备实例，备实例收到日志，事务就算完成了提交，主实例会响应客户 端修改完成，不需要等待备实例执行日志内容。

异步是指当应用发起的更新并且在主实例执行完成后，主实例会立即响应客户端 修改完成，同时主实例向备实例异步复制数据。

半同步情况下，当备实例不可用或者主备实例间出现网络异常时，半同步会退化为异步。异步情况下，备实例不可用时不会影响主实例上的操作，主实例不可用有较 低的概率导致主备库数据不一致。

## RDS实例日志管理

**错误日志**

[NOTE] 类型的日志一般可以忽略，[WARN] 类型的日志需要关注，[ERROR] 类型的错误需要排查。RDS的错误日志只记录近一个月的日志，不是永久的。

**慢日志**

RDS的慢日志类似于我们本地自建数据库配置的 slow_log，RDS的 slow_log 配置与本地自建的MYSQL 完全一样，您同样可以通过更改 **long_query_time** 的值进行阈值的调整，唯一的区别是，RDS的慢日志记录是记录到 table 里的（RDS的 参数 log_output=TABLE）, **记录的表是 MySQL.slow_log**，您现在也可以直接查询 这个表获取实时的慢日志信息。这个功能的慢日志展示与“错误日志”类似，也是固 定的频率抽取这个区间（上一次采集与这一次采集这个时间段）内的慢日志信息然后 展示出来，**并非实时展示**（理论上一分钟一次）。请注意如下 3 点：

● 如果一定时间内产生的慢日志非常多，RDS的采集程序抽取慢日志的时候， 会非常耗时，造成实例负载增加。 
● 慢日志的**保存只有一个月**，不是永久的。
● 如果您发现您的请求确实应该计入慢日志而却没有在慢日志明细页面展示。很 有可能出现了MySQL.slow_log 表损坏的情况。判断依据和处理方案可以参考这里 :https://help.aliyun.com/knowledge_detail/144433.html?spm=5176.11065259.1996646101.searchclickresult.7db42ff1tjEABi

主备切换日志

