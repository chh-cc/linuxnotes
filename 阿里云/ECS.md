# ECS

配置一个四层监听（TCP协议或UDP协议），并且ECS使用的是Linux系统，确保ECS实例上/etc/sysctl.conf目录下net.ipv4.conf文件中的以下三个参数的值为零：

```sh
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```

阿里云ECS默认采用dhcp分配网络，重启ecs时，dhclient会更新resolv.conf文件，这样就修改掉了ecs上配置的dns服务器。

禁止dhclient更新resolv.conf文件：
修改网卡配置文件，在该文件中添加如下语句即可：

```shell
vim /etc/sysconfig/network-scripts/ifcfg-eth0
PEERDNS=no
```

升级一台ECS服务器的CPU和内存需要停机，升级一台ECS的带宽不需要停机

selinux可能会禁止某些端口的使用，造成无法监视

## 地域和可用区

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210408232205.png" alt="img" style="zoom:67%;" />

同一可用区内的 ECS 实例网络**延时更小**

关于经营许可证备案

选择地域时您需要考虑某些地区的特殊要求。如您在中国内地地域购买了ECS实例，并**用于Web服务器，您需要完成经营许可证备案**。

如您有办理经营许可证备案的需求，请您重点关注：

- 北京地区企业，请选择购买的地域为**华北 2**。
- 广东地区企业，请选择购买的地域为**华南 1**。

## 操作须知

- 不要卸载相关硬件的驱动程序。
- 不要随意修改网卡MAC地址。
- 建议不要开启SELinux。
- 为保证服务的连续性，避免因宕机迁移而导致的服务不可用，建议将相关软件都设置成开机启动。如果有应用服务连接数据库，需要在程序中设置成自动重连机制。
- 不建议升级云服务器的内核和操作系统版本。
- 不要修改Linux实例默认的/etc/issue文件内容。否则，根据实例创建的自定义镜像的系统发行版本无法被正确识别，使用该镜像创建的实例无法正常启动。
- 不要随意更改根目录所在分区下各个目录的权限，尤其是/etc、/sbin、/bin、/boot、/dev、/usr和/lib等目录的权限。如果权限更改不当会导致系统出现异常。
- 不要重命名、删除或禁用Linux下的root账号。
- 不要编译Linux系统的内核，或对内核进行任何其他操作。
- 如果您使用普通云盘，不建议使用swap分区。如果使用高效云盘、SSD云盘或ESSD云盘，可以根据实际情况使用swap分区。
- 不要开启NetWorkManager服务。该服务会跟系统内部网络服务出现冲突，导致网络异常。
- 请谨慎使用root等管理账号进行fio、mkfs、fsck、扩容等操作，避免误操作引起的数据受损。

## 实例

在一些业务场景下，可以通过购买按量付费的云服务器ECS实例来满足特定时间段内需要更多计算资源的需求,可以多次设置ECS实例的自动释放时间

升级包年包月实例规格无需预先停止实例，大约15分钟左右，**重启后**新实例规格才能**生效**。

升级实例带宽无需预先停止实例，大约5分钟左右。

### 实例规格

实例规格族名称格式为**ecs.<规格族>**，实例规格名称为**ecs.<规格族>.<nx>large**。

- **<规格族>**：由小写字母加数字组成。

  - c：一般表示计算型（computational）
  - g：一般表示通用型（general）
  - r：一般表示内存型（ram）
  - ne：一般表示网络增强型（network enhanced）

- 规格对应业务场景

  ![img](https://gitee.com/c_honghui/picture/raw/master/img/20210719225327.png)

- 自建服务选型

  | 应用类型 | 常用应用          | 选型原则                                                     | 推荐实例规格族                                    |
  | :------- | :---------------- | :----------------------------------------------------------- | :------------------------------------------------ |
  | 负载均衡 | Nginx             | 应用特点：需要支持**高频率的新建连接**操作。**CPU计算能力**：要求较高。内存：要求不高。 | c6e、hfc7、g5ne系列                               |
  | RPC产品  | SOFADubbo         | 应用特点：网络链接密集型；进程运行时需要消耗较高的内存。     | g6e、g6系列                                       |
  | 缓存     | RedisMemcacheSolo | CPU计算能力：要求不高。**内存**：要求较高。                  | 实例规格族：r6e、re6系列块存储：SSD云盘或ESSD云盘 |
  | 配置中心 | ZooKeeper         | 在应用启动协商时会有大量I/O读写操作。CPU计算能力：要求不高。内存：要求不高。 | 实例规格族：c6e、c6系列块存储：SSD云盘或ESSD云盘  |
  | 消息队列 | KafkaRabbitMQ     | 从消息完整性方面考虑，存储优先选用云盘。CPU计算能力：要求不高。内存和vCPU配比通常为1:1。存储：要求不高。 | 实例规格族：c6e、c6系列块存储：SSD云盘或ESSD云盘  |
  | 容器编排 | Kubernetes        | 通过弹性裸金属服务器和容器组合，可以最大限度挖掘计算潜能。   | ebmc6e、ebmg6e、ebmc6、ebmg6系列                  |
  | 大表存储 | HBase             | 一般可以选择d系列。如果业务存在超高IOPS（Input/Output Operations Per Second）需求，可以选择i系列。 | d2c、d2s系列i3系列                                |
  | 数据库   | MySQLNoSQL        | 对于存储有弹性扩展的需求，可以选择ECS和ESSD。对于I/O敏感型业务的需求，优先选择i系列。 | 实例规格：c6e、g6e、r6e系列块存储：ESSD云盘i3系列 |
  | 文本搜索 | Elasticsearch     | 选用内存与vCPU配比较大的ECS规格。日常需要将数据库数据导出成ES文件，对I/O读写有要求。 | 实例规格：g6e、g6系列块存储：ESSD云盘d2c、d2s系列 |

### 创建实例

- 基础配置

  - 选择镜像。您可以选择公共镜像、自定义镜像、共享镜像或从镜像市场选择镜像。

  - 选择存储。

    **系统盘**：必选项，用于安装操作系统。

    **数据盘**：可选项。可以创建空云盘，也可以使用快照创建云盘。最多可以添加16块云盘作数据盘。

    **共享盘NAS**：可选项。您可以选择已经创建的文件系统进行挂载，最多可以挂载5个文件系统。

- 系统配置

  - 选择并设置登录凭证

  - 设置实例名称以及显示在操作系统内部的计算机名

    <img src="https://gitee.com/c_honghui/picture/raw/master/img/20210411012802.png" alt="image-20210411012755335" style="zoom:67%;" />

    生成的实例名分别为k8s-node-0006、k8s-node-0007、k8s-node-0008，生成的主机名分别为k8s-node-0006-ecshost、k8s-node-0007-ecshost、k8s-node-0008-ecshost

  - 设置高级选项

- 分组设置
  - 添加标签
  - 选择资源组
  - 选择部署集

#### 使用自定义镜像创建实例

可以使用自定义镜像方便地创建具有**相同操作系统、应用程序和数据**的ECS实例

前提条件：

在需要创建实例的账号和地域中持有自定义镜像。

操作：

单击***\*实例与镜像\** > \**镜像\****

找到待使用的镜像，在**操作**列中，单击**创建实例**

#### 购买相同配置的实例

找到待操作实例，在**操作**列中，单击**更多** > **购买相同配置**

#### 使用实例启动模板创建实例

实例启动模板中包含了用于创建实例的配置信息，可以存储除了密码以外的任意配置信息，包括密钥对、RAM角色、实例类型和网络设置等。

实例启动模板不支持修改，但可以创建多个版本，每个版本可以配置不同的参数，通过版本管理体现实例配置的演进过程。您可以使用模板任意一个版本创建实例。

可以直接使用现有实例启动模板配置实例，省去重复选择配置项的时间。

1. 在左侧导航栏，单击**部署与弹性** > **实例启动模板**
2. 找到模板或版本，在**操作**列中，单击**创建实例**
3. 在**自定义购买**页面，选择模板和版本，待配置信息加载完成，检查所有配置信息。
4. 创建实例

## 安全组

通过配置安全组规则，您可以控制安全组内ECS实例的入流量和出流量。

安全组分为普通安全组和企业安全组。企业安全组面向企业级场景，可以容纳更多的实例、弹性网卡和私网IP，而且访问策略更加严格。在安全组通用特性基础上，**企业安全组**还具有以下特性：

- 仅支持专有网络。
- **默认拒绝所有出方向的访问请求**。
- 同一安全组内的实例之间默认内网隔离。



实现在阿里云的同一个专有网络VPC下的三个交换机下的云服务器ECS实例之间内网互相不能访问，但并不影响该专有网络VPC的内网其他流量？

```text
创建三个安全组,分别包含三个交换机下的所有ECS实例,先为每个安全组配置允许所有网段访问的规则,再配置禁止另外两个交换机所在的网段访问的规则,优先级要高于前者
```



建议：

- 单个安全组内尽量保持规则简洁。单台实例可以加入多个安全组，单个安全组可以添加多条安全组规则
- **不同类型应用的实例加入不同的安全组**，分别维护安全组规则。例如，需要接受公网访问的实例加入同一个安全组，默认拒绝所有访问，然后设置仅暴露对外提供服务的端口（例如80、443等）。
- 避免直接修改线上环境使用的安全组。可以**先克隆一个安全组**并在测试环境调试
- 合理定义安全组名称、标签等

### 特点

安全组具有以下功能特点：

- 一台ECS实例至少属于一个安全组，**可以同时加入多个安全组**。
- 一个安全组可以管理**同一个地域**内的多台ECS实例。
- 在没有设置允许访问的安全组规则的情况下，不同安全组内的ECS实例之间默认内网不通。
- 安全组支持有状态应用。一个有状态的会话连接中，会话的最长保持时间是910秒。安全组会默认放行同一会话中的通信。例如，在会话期内，如果连接的数据包在入方向是允许的，则在出方向也是允许的。
- 优先级从1-100，应该是数值越小，优先级越高

### 使用流程

创建安全组→添加安全规则→ecs实例加入安全组→管理安全组→管理安全规则

### 安全组规则

| 属性     | 说明                                                         |
| :------- | :----------------------------------------------------------- |
| 规则方向 | 根据实例的网络类型区分：专有网络VPC支持入方向和出方向。经典网络支持公网出、入方向，内网出、入方向。 |
| 授权策略 | 支持允许、拒绝两种访问策略。                                 |
| 协议类型 | TCP、UDP、ICMP（IPv4）和GRE。                                |
| 端口范围 | 应用或协议开启的端口。                                       |
| 优先级   | 优先级的取值范围为1~100，数值越小，代表优先级越高。同类型规则间依赖优先级决定最终执行的规则。当ECS实例加入了多个安全组时，多个安全组会从高到低依次匹配规则。最终生效的安全组规则如下：如果两条安全组规则只有授权策略不同：拒绝策略的规则生效，允许策略的规则不生效。如果两条安全组规则只有优先级不同：优先级高的规则生效。 |
| 授权对象 | 支持设置IP地址段和安全组ID。                                 |

### 案例

案例1：同地域同账号的实例实现内网互通

- 如果在同一个安全组内，默认内网互通，不需要设置。
- 如果在不同的安全组内，默认内网不通。此时，在实例所在安全组中分别添加一条安全组规则，授权另一个安全组内的实例访问本安全组内的实例，实现内网互通。

| 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 优先级 | 授权对象                           |
| :------- | :------- | :------- | :----------------- | :----------- | :----- | :--------------------------------- |
| 专有网络 | 入方向   | 允许     | 设置适用的协议类型 | 设置端口范围 | 1      | 输入允许访问的实例所在的安全组ID。 |

案例2：同地域不同账号的实例实现内网互通

此案例仅适用于经典网络类型的ECS实例。

UserA（账号ID：160998252992****）在华东1有一台经典网络类型的ECS实例InstanceA（内网IP：A.A.A.A），InstanceA所属的安全组为GroupA（安全组ID：sg-bp174yoe2ib1sqj5****）。

UserB（账号ID：135652617028****）在华东1有一台经典网络类型的ECS实例InstanceB（内网IP：B.B.B.B），InstanceB所属的安全组为GroupB（安全组ID：sg-bp148p6ncq1rjuvr****）。

您需要在GroupA和GroupB中分别添加安全组规则，授权InstanceA和InstanceB内网互通。

- 在GroupA中添加安全组规则，授权InstanceB内网访问InstanceA，如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                                     | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :----------------------------------------------------------- | :----- |
  | 经典网络 | 入方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 格式：UserB的账号ID/GroupB的ID示例：135652617028****/sg-bp148p6ncq1rjuvr**** | 1      |

- 在GroupB中添加安全组规则，授权InstanceA内网访问InstanceB，如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                                     | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :----------------------------------------------------------- | :----- |
  | 经典网络 | 入方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 格式：UserA的账号ID/GroupA的ID示例：160998252992****/sg-bp174yoe2ib1sqj5**** | 1      |

案例3：只允许特定ip远程登录实例

Linux实例

| 网络类型 | 规则方向 | 授权策略 | 协议类型  | 端口范围 | 授权对象                                         | 优先级 |
| :------- | :------- | :------- | :-------- | :------- | :----------------------------------------------- | :----- |
| VPC      | 入方向   | 允许     | 自定义TCP | SSH (22) | 允许远程连接的CIDR，例如1.2.3.4/32或10.0.0.0/8。 | 1      |

案例4：只允许实例访问外部特定ip

- 禁止实例以任何协议访问所有公网IP地址，优先级应低于允许访问的规则（如本例中设置优先级为2）。安全组规则如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型 | 端口范围 | 授权对象  | 优先级 |
  | :------- | :------- | :------- | :------- | :------- | :-------- | :----- |
  | VPC      | 出方向   | 拒绝     | 全部     | -1/-1    | 0.0.0.0/0 | 2      |

- 允许实例访问特定公网IP地址，优先级应高于拒绝访问的安全组规则的优先级（如本例中设置为1）。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                             | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :--------------------------------------------------- | :----- |
  | VPC      | 出方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 允许实例访问的特定CIDR，例如1.2.3.4/32或10.0.0.0/8。 | 1      |

## 快照

快照是某一时间点云盘数据状态的**备份文件**。

云盘第一份快照是实际使用量的全量快照，不备份空数据块，后续创建的快照均是增量快照，只存储变化的数据块。

快照适用范围：数据盘、系统盘

**创建自定义镜像的快照云盘属性必须是系统盘**

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412115128.png)

回滚快照操作时必需在云服务器ECS实例的**状态为“停止”**时才能进行

使用快照回滚，并不是自己创建快照自己用，**可以用别的ECS实例的快照回滚的**

### 创建云盘快照

1. 在左侧导航栏，选择**实例与镜像** > **实例**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要创建快照的实例，单击实例ID。
4. 在**实例详情**页，单击**云盘**页签。
5. 找到要创建快照的云盘，在**操作**列单击**创建快照**。

### 复制快照

创建了普通快照后，您可以将普通快照**从一个地域复制到另一个地域**，复制后的快照会被分配一个与源快照不同的ID。

通过复制快照，您可以在新的地域快速启用业务，或者**将业务系统迁移到新的地域**，降低运维成本以及实现更好的可用性。

操作：

1. 在左侧导航栏，单击**存储与快照** > **快照**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到目标快照，在**操作**列中，单击**复制快照**。
4. 在弹出**复制快照**对话框中，配置参数。

### 使用快照回滚云盘

**发生系统故障或错误操作时**，您可以使用快照回滚云盘，实现应用版本回退。

操作：

1. 在左侧导航栏，单击**实例与镜像** > **实例**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要回滚云盘的实例，在**操作**列中，单击**管理**
4. 在**实例详情**页，单击**快照**页签。
5. 选择需要的快照，在**操作**列中，单击**回滚磁盘**。

### 自动快照策略

创建自动快照策略：

1. 在左侧导航栏，单击***\*存储与快照\** > \**快照\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**快照**页面，单击**自动快照策略**页签。
4. 在**自动快照策略**页面右上角处，单击**创建策略**。
5. 在**创建策略**对话框，完成自动快照策略设置。

| 区域                   | 说明                                                         |
| :--------------------- | :----------------------------------------------------------- |
| **策略名称**           | 自动快照策略的名称。                                         |
| **创建时间**           | 一天内创建自动快照的时间点，支持在00:00~23:00共24个整点中选择一个或多个时间点。<br />**说明** 创建快照会暂时降低块存储I/O性能，一般性能差异在10%以内，出现短暂瞬间变慢。建议您选择避开业务高峰的时间点。 |
| **重复日期**           | 创建自动快照的日期，支持在周一至周日之间选择一个或多个日期。 |
| **保留时间**           | 自动快照的保留时间，默认保留30天，支持以下选项：<br />**自定义时长**：保留天数范围为1~65536天。<br />**持续保留，直至快照数量达到额度上限后被自动删除**：在自动快照数量达到上限后，系统会删除最早创建的自动快照。 |
| **标签**               | 选择已有的标签键和标签值，或输入新的标签键和标签值，通过该自动快照策略创建的自动快照会默认绑定该标签。 |
| **快照跨地域复制**     | 如果启用快照跨地域复制，通过该自动快照策略创建的自动快照会自动复制到目标地域。选中**启用**后，您需要继续设置**目标地域**和**复制快照的保留时间**。 |
| **目标地域**           | 设置快照复制的目标地域。                                     |
| **复制快照的保留时间** | 设置复制快照后，目标地域中副本快照的保留时间。<br />**自定义时长**：保留天数范围为1~65536天。<br />**持续保留，不受快照数量额度上限影响**：目标地域中副本快照一直保留。 |

执行或取消自动快照：

- 在快照页面执行或取消自动快照策略

1. 在左侧导航栏，单击***\*存储与快照\** > \**快照\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**快照**列表页中，选择**自动快照策略**。
4. 在**自动快照策略**页面，找到需要修改的策略，在**操作**列，单击**设置磁盘**。
5. 在**设置磁盘**页面，单击**未设置策略磁盘**页签：
   - 如果想要执行快照策略：单击**未设置策略磁盘**页签，找到要执行策略的磁盘，单击其右侧的**执行快照策略**。或者选择多个磁盘，单击下面的**执行快照策略**。
   - 如果想要取消快照策略：单击**已设置策略磁盘**页签，找到要执行策略的磁盘，单击其右侧的**取消快照策略**。或者选择多个磁盘，单击下面的**取消快照策略**。

- 创建实例时启动自动快照策略

![image-20210412143107016](https://gitee.com/c_honghui/picture/raw/master/img/20210412143107.png)

- 创建云盘时启动自动快照策略

![image-20210412143526124](https://gitee.com/c_honghui/picture/raw/master/img/20210412143526.png)

## 镜像

镜像是一种地域性资源，您**不能跨地域使用镜像**创建实例。例如，在华北2（北京）地域创建实例时，您只能使用位于华北2（北京）地域的镜像。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210409000535.png)

### 镜像类型

#### 公共镜像

阿里云提供**Alibaba Cloud Linux镜像**和**第三方商业镜像及开源镜像合作的正版镜像**两种类型的公共镜像。

您可免费使用其他公共镜像创建ECS实例（除Windows Server和Red Hat Enterprise Linux之外）

#### 自定义镜像

基于实例创建

基于快照创建

从本地导入的自定义镜像

自定义镜像**会产生快照费用**

自定义镜像适用范围：**仅系统盘**

### 用快照创建自定义镜像

通过创建自定义镜像，您可以将一台ECS实例的操作系统、数据制作成环境副本，再**通过自定义镜像创建多台ECS实例**，**快速复制系统环境**。

前提：您已经创建了一份系统盘快照。

找到目标实例，单机管理：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412001245.png)

单机快照，找到云盘属性为系统盘的目标快照，单击创建自定义镜像：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412001313.png)

**注意：**

- 必须包含一份系统盘快照创建自定义镜像。仅包含数据盘快照无法创建自定义镜像。
- 加密快照和非加密快照均可用于创建自定义镜像。
- 创建快照的**源ECS实例到期或释放后**，使用该快照创建的自定义镜像不受影响，使用该镜像创建的ECS实例也不受影响。
- 使用自定义镜像创建VPC网络的ECS实例后，可能出现网络无法连通的异常情况。

### 用实例创建自定义镜像

创建实例后，您可以根据业务需要自定义实例（如安装软件、部署应用环境等），并为更新后的实例创建自定义镜像。使用该镜像创建的新实例，会包含您已配置的自定义项，省去您重复自定义实例的时间。

前提：

- 检查实例的网络配置。
- 检查系统盘使用剩余空间，确保系统盘没有被写满。

**注意：**

- **无需停止实例**即可创建镜像。
- 镜像创建过程中，不能改变实例的状态。例如，不要停止、启动或者重启实例，避免创建失败。
- 实例及其创建的镜像属于同一个地域。
- **不要在/etc/fstab文件中加载数据盘信息**，否则使用该镜像创建的实例无法启动。

操作：

1. 找到目标实例。在**操作**列中，单击**更多** > **云盘和镜像** > **创建自定义镜像**。

### 导入镜像

可以使用导入的自定义镜像创建ECS实例或更换系统盘

导入流程：

1. 在源服务器使用工具检测镜像规范

下载检测工具到当前目录

```shell
wget http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/73848/cn_zh/1557459863884/image_check
```

使用root权限运行检测工具

```shell
chmod +x image_check
sudo <检测工具所在路径>/image_check –p [生成报告的目标路径] 
```

检测工具会根据检测项给出`OK`、`FAILED`或者`WARNING`检测结果。

- `OK`：检测项均符合要求。
- `FAILED`：检测项不符合要求，使用该自定义镜像创建的ECS实例无法正常启动。建议您修复报错项后再制作镜像，以提高实例启动效率。
- `WARNING`：检测项不符合要求，使用该自定义镜像创建的ECS实例可以安全启动，但ECS无法通过有效途径干预您的实例配置。您可以选择立即修复，也可以暂时忽略问题直接制作镜像。

2. 在源服务器安装cloud-init

检查是否已安装cloud-init

```shell
which cloud-init
```

如果没有，安装

```shell
yum -y install python3-pip
wget https://ecs-image-tools.oss-cn-hangzhou.aliyuncs.com/cloud-init-19.1.7.tgz
tar -zxvf cloud-init-19.1.7.tgz
cd ./cloud-init-19.1.7
pip3 install -r ./requirements.txt
```

运行脚本

```
cd ./tools
bash ./deploy.sh <issue> <major_version>

<issue> 取值范围：centos | redhat |rhel | debian | ubuntu | opensuse | sles
<major_version> CentOS 7.6的主要版本号为7
```

3. 检查是否需要在源服务器中安装virtio驱动

检查当前操作系统的内核是否支持virtio驱动

```shell
grep -i virtio /boot/config-$(uname -r)
```

若没有CONFIG_VIRTIO_BLK和CONFIG_VIRTIO_NET这两个参数表示该操作系统没有安装virtio相关驱动，需要为您的服务器编译安装virtio驱动

若参数值为y，表示包含了virtio驱动，可以直接导入自定义的镜像到阿里云

若参数取值为m，执行以下命令确认virtio驱动是否包含在临时文件系统initramfs或者initrd中。

```shell
lsinitrd /boot/initramfs-$(uname -r).img | grep virtio
```

如果临时文件系统initramfs没有包含virtio驱动，则需要修复临时文件系统。

4. 转换镜像格式（RAW、VHD和qcow2格式镜像文件除外）
5. 导入镜像

自动导入：

- 单击***\*实例与镜像\** > \**镜像\****

- 在**镜像**页的右上角，单击**SMC在线迁移**。

手动导入

- 使用OSS的第三方工具客户端或API上传制作好的自定义镜像
- 单击***\*实例与镜像\** > \**镜像\****
- 授权ECS服务访问您的OSS资源
- 单击**导入镜像**

### 更新镜像

1. 在左侧导航栏，单击**实例与镜像** > **镜像**。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**镜像**页面，选择**自定义镜像**页签。
4. 找到目标镜像，在**操作**栏单击[![更多操作](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2403222061/p171570.png)](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2403222061/p171570.png)图标，然后单击**更新镜像**。
5. 跳转至OOS管理控制台后，完成以下配置：
   1. 完成通用设置，包括输入新镜像名称和描述，并指定执行所使用到的权限来源。
   2. **可选：**完成镜像分发设置。您可以根据需要设置是否复制或共享该镜像。
   3. 选择镜像。如果您在前一步操作已选择了目标镜像，此时将自动选中，请确认已选的镜像是否为需要操作的镜像。
   4. 配置中转实例，设置用于创建临时ECS实例的专有网络、交换机、安全组和实例类型。
   5. **可选：**发送远程命令。您可以根据需要选择命令类型并输入命令内容，该命令内容将在临时创建的ECS实例中执行。
   6. **可选：**完成高级选项配置。您可以根据需要设置伸缩组配置，添加标签或将当前配置保存为模板。
6. 单击**立即执行**，并在弹出的对话框中确认提示信息。
7. 在**创建或更新镜像**页面，您可以查看任务运行情况。

### 复制镜像

复制镜像适用于跨地域部署ECS实例、跨地域备份数据。

1. 在左侧导航栏，选择***\*实例与镜像\** > \**镜像\****。

2. 在顶部菜单栏左上角处，选择地域。

3. 在**镜像**页面，选择**自定义镜像**页签。

4. 选择需要复制的镜像，在**操作**列中，单击**复制镜像**。

5. 在**复制镜像**对话框中，完成以下配置。

   1. 确认选中的自定义镜像的ID。

   2. 在**目标地域**的下拉菜单中，选择一个地域，必须和当前地域不同。

   3. 填写镜像在目标地域显示的**自定义镜像名称**。

   4. **可选：**填写镜像在目标地域显示的**描述**。

   5. 可选：

      勾选**加密**，在下拉菜单中选择密钥**Default Service CMK**。

      **Default Service CMK**表示使用密钥管理服务KMS创建的默认密钥。

   6. 单击**确定**。

### 导出镜像

创建自定义镜像后，您可以导出镜像到OSS存储空间（OSS Bucket），并下载到本地使用。

操作：

选择***\*实例与镜像\** > \**镜像\****

授权ECS服务访问OSS的权限

找到目标镜像，在**操作**列，再次单击***\*更多\** > \**导出镜像\****

## 块存储

块存储是阿里云为云服务器ECS提供的块设备产品,可以像使用物理硬盘一样格式化并建立文件系统来使用块存储.

块存储要和实例同一个可用区才可以挂载

关于系统盘

```text
通过更换ECS实例的系统盘操作来实现系统盘的扩容
扩容ECS实例的系统盘时需要停止您的实例，因此会短暂中断您的业务
扩容系统盘后，用户创建的快照会保留
```

一个ECS实例最多可以挂载16块数据盘

ECS 实例的系统盘使用的 SSD 云盘,需要新增数据盘时不能使用本地SSD 盘

重新初始化磁盘必须该磁盘已经挂载，并且挂载该磁盘的实例处于停止状态

### 块存储类型

#### 云盘

云服务器ECS一般最多挂载16块数据盘。您可以扩容单块云盘，扩容生效后**不支持缩容**

云盘是阿里云为云服务器ECS提供的数据块级别的块存储产品,云盘采用**分布式三副本机制**，为ECS实例提供99.9999999%的数据可靠性保证。

| 性能类别                                | ESSD云盘                   |                           |                          |                            | SSD云盘                  | 高效云盘                | 普通云盘 |
| :-------------------------------------- | :------------------------- | :------------------------ | :----------------------- | :------------------------- | ------------------------ | ----------------------- | -------- |
|                                         | PL3                        | PL2                       | PL1                      | PL0                        |                          |                         |          |
| 单盘最大容量（GiB）                     | 1261~32768                 | 461~32768                 | 20~32768                 | 40~32768                   | 32768                    | 32768                   | 2000     |
| 最大IOPS                                | 1000000                    | 100000                    | 50000                    | 10000                      | 25000                    | 5000                    | 数百     |
| 最大吞吐量（MB/s）                      | 4000                       | 750                       | 350                      | 180                        | 300                      | 140                     | 30~40    |
| 单盘IOPS性能计算公式                    | min{1800+50*容量, 1000000} | min{1800+50*容量, 100000} | min{1800+50*容量, 50000} | min{ 1800+12*容量, 10000 } | min{1800+30*容量, 25000} | min{1800+8*容量, 5000}  | 无       |
| 单盘吞吐量性能计算公式（MB/s）          | min{120+0.5*容量, 4000}    | min{120+0.5*容量, 750}    | min{120+0.5*容量, 350}   | min{100+0.25*容量, 180}    | min{120+0.5*容量, 300}   | min{100+0.15*容量, 140} | 无       |
| 单路随机写平均时延（ms），Block Size=4K | 0.2                        |                           |                          | 0.3~0.5                    | 0.5~2                    | 1~3                     | 5~10     |
| API参数取值                             | cloud_essd                 |                           |                          |                            | cloud_ssd                | cloud_efficiency        | cloud    |

#### 创建云盘

1. 在左侧导航栏，单击**存储与快照** > **云盘**。
2. 在**云盘**页面右上角，单击**创建云盘**。
3. 在创建云盘页面中，设置云盘的配置参数。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412101903.png)

#### 使用快照创建云盘

前提：您已经为历史系统盘或数据盘创建了快照，并确认快照ID。

1. 在左侧导航栏，单击**存储与快照** > **云盘**。
2. 在**云盘**页面右上角，单击**创建云盘**。
3. 在云盘购买页面，单击**用快照创建磁盘**，并选择目标快照。

#### 挂载数据盘

可以将单独创建的按量付费云盘挂载到ECS实例上，作为数据盘使用

前提：

- 被挂载的**实例和云盘在同一个可用区**。
- 被挂载的实例的状态为**运行中**（Running）或者**已停止**（Stopped），不能为**已锁定**（Locked）。
- 云盘的状态为**待挂载**（Available）。
- 您的账号不欠费。

操作：

1. 在左侧导航栏，单击***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要挂载云盘的实例，单击实例ID。
4. 单击**云盘**页签，在**云盘**页面的右上方，单击**挂载云盘**。

#### 格式化数据盘

- 小于2T的盘

查看数据盘信息：

```shell
fdisk -l
```

创建一个分区：

```shell
fdisk -u /dev/vdb
p查看分区情况
n创建一个分区
p选择分区类型为主分区
1输入分区编号，按回车键。
回车
回车
p
w
```

创建文件系统：

```shell
mkfs -t ext4 /dev/vdb1
或
mkfs -t xfs /dev/vdb1
```

配置/etc/fstab并挂载

由于释放云盘等操作可能会导致其他云盘的设备名变动，建议您在/etc/fstab中使用全局唯一标识符UUID来引用新分区。

```shell
cp /etc/fstab /etc/fstab.bak
echo `blkid /dev/vdb1 | awk '{print $2}' | sed 's/\"//g'` /data ext4 defaults 0 0 >> /etc/fstab
mount /dev/vdb1 /data
```

- 大于2T的盘

```shell
yum install -y parted
yum install -y e2fsprogs
fdisk -l
#分区
parted /dev/vdb
mklabel gpt
mkpart primary 1 100%
#检查分区是否对齐
align-check optimal 1
print
quit
#使系统重读分区表
partprobe
#创建文件系统
mkfs -t ext4 /dev/vdb1
mount /dev/vdb1 /test
cp /etc/fstab /etc/fstab.bak
echo `blkid /dev/vdb1 | awk '{print $2}' | sed 's/\"//g'` /test ext4 defaults 0 0 >> /etc/fstab
```

ext4文件系统默认开启lazy init功能。该功能开启时，实例会发起一个线程持续地初始化ext4文件系统的metadata，从而延迟metadata初始化。所以在格式化数据盘后的近期时间内，云盘的IOPS性能会受到影响，IOPS性能测试的数据会明显偏低。

```shell
mke2fs -O 64bit,has_journal,extents,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize -E lazy_itable_init=0,lazy_journal_init=0   /dev/vdb1
```

#### 裸设备创建文件系统

```shell
mkfs.ext4 /dev/vdb
或
mkfs.xfs /dev/vdb
```

#### 在线扩容云盘

1. 为扩容云盘创建快照
2. 在平台扩容云盘容量
3. 查看云盘分区情况

```shell
fdisk -lu
```

4. 扩容分区

```shell
#分区为GPT格式，必须执行此步骤；如果您的分区为MBR格式，请跳过此步骤
yum install gdisk -y
#CentOS 7及以上版本运行以下命令。
yum install -y cloud-utils-growpart
#Debian 9及以上版本、Ubuntu14及以上版本运行以下命令。
apt-get update
apt-get install -y cloud-guest-utils
#扩容分区
growpart /dev/vda 1
```

5. 扩容文件系统

```shell
#扩容ext*
resize2fs /dev/vda1
#扩容xfs
xfs_growfs /media/vdc
```

支持在线扩容的Linux公共镜像（或基于公共镜像制作的自定义镜像）包括：

- Alibaba Cloud Linux：Alibaba Cloud Linux 2.1903 LTS 64位
- CentOS：
  - CentOS 6：CentOS 6.8及以上版本
  - CentOS 7：CentOS 7.2及以上版本
  - CentOS 8及以上版本
- Red Hat Enterprise Linux：
  - RHEL 6：RHEL 6.9及以上版本
  - RHEL 7：RHEL 7.4及以上版本
  - RHEL 8及以上版本
- Ubuntu：Ubuntu 16及以上版本
- Debian：Debian 8及以上版本
- SUSE：SUSE 12 SP2及以上版本
- OpenSUSE：OpenSUSE 42.3及以上版本

## 网络

专有网络（Virtual Private Cloud，简称VPC）是基于阿里云构建的一个隔离的网络环境，**专有网络之间逻辑上彻底隔离**。您可以自定义这个专有网络的拓扑和IP地址，适用于对网络安全性要求较高和有一定网络管理能力的用户。

在已经创建好的阿里云的云服务器ECS实例中进行了更改网卡mac地址的操作，可能会导致网络不通

如果您有已经创建的专有网络VPC和交换机，在创建专有网络VPC类型的云产品实例时，云产品实例还是会创建在默认交换机中，这时候可以自己选择VPC

通过与VPN连接方式结合，可以实现专有网络VPC与传统数据中心组成一个按需定制的网络环境。

同一个地域内，不同账号下，经典网络下可以通过安全组规则设置两台云服务器之间内网互通

使用阿里云高速通道可以实现专有网络VPC之间互联和私网通信

5M带宽是指带宽总出口是5M，下行5M，**上行不限**（这里的**下行代表出网**带宽即从服务器流出的带宽;**上行代表入网**带宽即流入服务器的带宽）

### 专有网络IP

私有IP

场景：

- 负载均衡
- 同一局域网内ECS实例之间内网互访
- 同一局域网内ECS实例与其他云服务（如OSS、RDS）之间内网互访

公网IP

阿里云只对公网出网带宽收取费用，**入网带宽免费**。

| 维度            | ECS系统分配的公网IP地址（PublicIP）                          | 弹性公网IP（EIP）地址                                        |
| :-------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| 使用场景        | 如果希望在创建ECS实例时由ECS系统自动分配一个公网IP地址，释放实例时这个公网IP地址随实例一起释放，不保留该公网IP地址，您可以选择PublicIP。 | 如果希望长期使用某个公网IP地址，根据业务需要将它绑定到指定的ECS实例上，您可以选择弹性公网IP（EIP）。EIP可以反复绑定和解绑。释放实例后，EIP仍然存在。 |
| 获取方式        | 在创建ECS实例时，如果您选择**分配公网IP地址**，实例即被分配一个PublicIP。 | 单独申请EIP地址，并绑定到未分配PublicIP的ECS实例上。         |
| 分配上限        | 一台ECS实例只能分配一个PublicIP。                            | 可以关联多个EIP，通过设置多EIP网卡可见模式实现。             |
| 解绑方式        | PublicIP一经分配，只能释放，不能解绑。                       |                                                              |
| 释放方式        | 释放实例时，PublicIP地址随实例一起释放。在实例的使用期间，将带宽值设置为0 Mbit/s，可以释放PublicIP。 |                                                              |
| 如何查看MAC地址 | VPC类型的ECS实例的公网访问通过私有网卡映射完成。所以，无论您的实例是否分配或者绑定了公网IP地址，在实例内部您都无法查询到公网网卡。 |                                                              |

### 修改私有IP

前提：

- 实例的弹性网卡未设置辅助私网IP地址。
- 实例处于已停止状态。

操作：

1. 在左侧导航栏，选择***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到目标实例，在**操作**区域选择***\*更多\** > \**网络和安全组\** > \**修改私有IP\****。

### 弹性网卡

弹性网卡ENI（Elastic Network Interface）是一种可以绑定到专有网络VPC类型ECS实例上的虚拟网卡。

#### 创建弹性网卡

前提：

- 已在相应地域下创建专有网络VPC，并创建虚拟交换机。
- 已在指定的专有网络下创建安全组。

操作：

1. 在左侧导航栏，单击***\*网络与安全\** > \**弹性网卡\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 单击**创建弹性网卡**。

#### 绑定弹性网卡

如果ECS实例最后一次启动时间在2018年4月1日之前（包括但不限于启动新购的实例、重启、重开机），您必须重启一直保持运行中状态的实例，否则不支持绑定弹性网卡。

操作：

1. 在左侧导航栏，单击***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要绑定弹性网卡的实例，在**操作**列中，单击***\*更多\** > \**网络和安全组\** > \**绑定辅助弹性网卡\****。

#### 配置弹性网卡

