# ECS



配置一个四层监听（TCP协议或UDP协议），并且ECS使用的是Linux系统，确保ECS实例上/etc/sysctl.conf目录下net.ipv4.conf文件中的以下三个参数的值为零：

```sh
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```



ECS的系统内核是经过特殊开发的,不建议自行编译内核



升级一台ECS服务器的CPU和内存需要停机，升级一台ECS的带宽不需要停机





selinux可能会禁止某些端口的使用，造成无法监视









## 地域和可用区

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210408232205.png" alt="img" style="zoom:67%;" />

同一可用区内的 ECS 实例网络延时更小

关于经营许可证备案

选择地域时您需要考虑某些地区的特殊要求。如您在中国内地地域购买了ECS实例，并用于Web服务器，您需要完成经营许可证备案。

如您有办理经营许可证备案的需求，请您重点关注：

- 北京地区企业，请选择购买的地域为**华北 2**。
- 广东地区企业，请选择购买的地域为**华南 1**。

## 操作须知

- 不要卸载相关硬件的驱动程序。
- 不要随意修改网卡MAC地址。
- 建议不要开启SELinux。
- 为保证服务的连续性，避免因宕机迁移而导致的服务不可用，建议将相关软件都设置成开机启动。如果有应用服务连接数据库，需要在程序中设置成自动重连机制。
- 不建议升级云服务器的内核和操作系统版本。
- 不要修改Linux实例默认的/etc/issue文件内容。否则，根据实例创建的自定义镜像的系统发行版本无法被正确识别，使用该镜像创建的实例无法正常启动。
- 不要随意更改根目录所在分区下各个目录的权限，尤其是/etc、/sbin、/bin、/boot、/dev、/usr和/lib等目录的权限。如果权限更改不当会导致系统出现异常。
- 不要重命名、删除或禁用Linux下的root账号。
- 不要编译Linux系统的内核，或对内核进行任何其他操作。
- 如果您使用普通云盘，不建议使用swap分区。如果使用高效云盘、SSD云盘或ESSD云盘，可以根据实际情况使用swap分区。
- 不要开启NetWorkManager服务。该服务会跟系统内部网络服务出现冲突，导致网络异常。
- 请谨慎使用root等管理账号进行fio、mkfs、fsck、扩容等操作，避免误操作引起的数据受损。

## 实例

在一些业务场景下，可以通过购买按量付费的云服务器ECS实例来满足特定时间段内需要更多计算资源的需求,可以多次设置ECS实例的自动释放时间

### 创建实例

- 基础配置

  - 选择镜像。您可以选择公共镜像、自定义镜像、共享镜像或从镜像市场选择镜像。
  - 选择存储。**系统盘**：必选项，用于安装操作系统。**数据盘**：可选项。可以创建空云盘，也可以使用快照创建云盘。最多可以添加16块云盘作数据盘。**共享盘NAS**：可选项。您可以选择已经创建的文件系统进行挂载，最多可以挂载5个文件系统。

- 系统配置

  - 选择并设置登录凭证

  - 设置实例名称以及显示在操作系统内部的计算机名

    <img src="https://gitee.com/c_honghui/picture/raw/master/img/20210411012802.png" alt="image-20210411012755335" style="zoom:67%;" />

    生成的实例名分别为k8s-node-0006、k8s-node-0007、k8s-node-0008，生成的主机名分别为k8s-node-0006-ecshost、k8s-node-0007-ecshost、k8s-node-0008-ecshost

  - 设置高级选项

- 分组设置
  - 添加标签
  - 选择资源组
  - 选择部署集

#### 使用自定义镜像创建实例

可以使用自定义镜像方便地创建具有相同操作系统、应用程序和数据的ECS实例，提高工作或交付效率

前提条件：

在需要创建实例的账号和地域中持有自定义镜像。

#### 购买相同配置的实例

找到待操作实例，在**操作**列中，单击**更多** > **购买相同配置**

#### 使用实例启动模板创建实例

可以直接使用现有实例启动模板配置实例，省去重复选择配置项的时间。

1. 在左侧导航栏，单击**部署与弹性** > **实例启动模板**
2. 找到模板或版本，在**操作**列中，单击**创建实例**
3. 在**自定义购买**页面，选择模板和版本，待配置信息加载完成，检查所有配置信息。
4. 创建实例

### 升降配实例

#### 修改实例规格

一个实例规格已预定义vCPU和内存。修改实例规格时，您需要选择目标实例规格，不能单独修改vCPU或内存。

| 实例计费方式 | 操作时段     | 何时生效                              |
| :----------- | :----------- | :------------------------------------ |
| 包年包月实例 | 到期前       | 重启实例后生效                        |
|              | 到期前15日内 | 进入新的计费周期后，7天内重启实例生效 |
|              | 到期后释放前 | 重启实例后生效                        |
| 按量付费实例 | 不涉及       | 重启实例后生效                        |

#### 修改公网带宽计费

| 公网IP类型 | 何时生效 |
| :--------- | :------- |
| 固定公网IP | 立即生效 |
| 弹性公网IP | 立即生效 |

### FAQ

- 资源售罄怎么办？

更换地狱；更换可用区；更换资源配置

- 开通一台需要多久？

1~2分钟

- 企业级实例和共享型实例的区别？

企业级实例采用固定CPU调度模式。每个vCPU绑定到一个物理CPU超线程，实例间无CPU资源争抢，实例计算性能稳定且有严格的SLA保证。

共享型实例采用非绑定CPU调度模式。每个vCPU会被随机分配到任何空闲CPU超线程上，不同实例vCPU会争抢物理CPU资源，并导致高负载时计算性能波动不稳定，有可用性SLA保证，但无性能SLA保证。

## 安全组

安全组是一种虚拟防火墙，具备状态检测和数据包过滤能力，用于在云端划分安全域。通过配置安全组规则，您可以控制安全组内ECS实例的入流量和出流量。

实现在阿里云的同一个专有网络VPC下的三个交换机下的云服务器ECS实例之间内网互相不能访问，但并不影响该专有网络VPC的内网其他流量？

```text
创建三个安全组,分别包含三个交换机下的所有ECS实例,先为每个安全组配置允许所有网段访问的规则,再配置禁止另外两个交换机所在的网段访问的规则,优先级要高于前者
```

一个安全组中可以包含同一个地域的同一个专有网络VPC内的云服务器ECS实例

当一个ECS创建后，默认安全规则是允许外网TCP22端口访问

安全组规则包括

```text
A、 安全组授权； 
B、 协议授权； 
C、 端口授权； 
D、 IP授权；
```

优先级从1-100，应该是数值越小，优先级越高



使用安全组时

- 仅允许少量请求访问ECS实例时，可以将安全组作为白名单使用。即先设置安全组为拒绝全部访问，然后逐一添加允许通信的访问请求策略。
- 不建议使用一个安全组管理所有应用，不同的分层一定有不同的隔离需求。
- 不建议为每台ECS实例单独设置一个安全组，您只需将具有相同安全保护需求的ECS实例加入同一安全组。

添加安全组规则时

- 建议您设置简洁的安全组规则。如果您给一台ECS实例分配了多个安全组，该ECS实例很可能会同时遵循数百条安全组规则，任何规则变更都可能引起网络不通的故障。
- 如果您需要修改生产环境的安全组规则，建议您提前在克隆的安全组上进行调试，避免影响线上应用。
- 为应用添加安全组规则时遵循最小授权原则。例如，您可以：
  - 选择开放具体的端口，如80/80。不要设置为端口范围，如1/80。
  - 添加安全组规则时，谨慎授权0.0.0.0/0（全网段）访问源。

### 特点

安全组具有以下功能特点：

- 一台ECS实例至少属于一个安全组，可以同时加入多个安全组。
- 一个安全组可以管理同一个地域内的多台ECS实例。
- 在没有设置允许访问的安全组规则的情况下，不同安全组内的ECS实例之间默认内网不通。
- 安全组支持有状态应用。一个有状态的会话连接中，会话的最长保持时间是910秒。安全组会默认放行同一会话中的通信。例如，在会话期内，如果连接的数据包在入方向是允许的，则在出方向也是允许的。

### 使用流程

- 管理ECS实例

创建安全组→添加安全规则→ecs实例加入安全组→管理安全组→管理安全规则

- 管理弹性网卡

创建安全组→添加安全组规则→弹性网卡加入安全组→ecs实例绑定弹性网卡→管理安全组→管理安全规则

### 安全组规则

| 属性     | 说明                                                         |
| :------- | :----------------------------------------------------------- |
| 规则方向 | 根据实例的网络类型区分：专有网络VPC支持入方向和出方向。经典网络支持公网出、入方向，内网出、入方向。 |
| 授权策略 | 支持允许、拒绝两种访问策略。                                 |
| 协议类型 | TCP、UDP、ICMP（IPv4）和GRE。                                |
| 端口范围 | 应用或协议开启的端口。                                       |
| 优先级   | 优先级的取值范围为1~100，数值越小，代表优先级越高。同类型规则间依赖优先级决定最终执行的规则。当ECS实例加入了多个安全组时，多个安全组会从高到低依次匹配规则。最终生效的安全组规则如下：如果两条安全组规则只有授权策略不同：拒绝策略的规则生效，允许策略的规则不生效。如果两条安全组规则只有优先级不同：优先级高的规则生效。 |
| 授权对象 | 支持设置IP地址段和安全组ID。                                 |

### 案例

案例1：同地域同账号的实例实现内网互通

- 如果在同一个安全组内，默认内网互通，不需要设置。
- 如果在不同的安全组内，默认内网不通。此时，在实例所在安全组中分别添加一条安全组规则，授权另一个安全组内的实例访问本安全组内的实例，实现内网互通。

| 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 优先级 | 授权对象                           |
| :------- | :------- | :------- | :----------------- | :----------- | :----- | :--------------------------------- |
| 专有网络 | 入方向   | 允许     | 设置适用的协议类型 | 设置端口范围 | 1      | 输入允许访问的实例所在的安全组ID。 |

案例2：同地域不同账号的实例实现内网互通

此案例仅适用于经典网络类型的ECS实例。

UserA（账号ID：160998252992****）在华东1有一台经典网络类型的ECS实例InstanceA（内网IP：A.A.A.A），InstanceA所属的安全组为GroupA（安全组ID：sg-bp174yoe2ib1sqj5****）。

UserB（账号ID：135652617028****）在华东1有一台经典网络类型的ECS实例InstanceB（内网IP：B.B.B.B），InstanceB所属的安全组为GroupB（安全组ID：sg-bp148p6ncq1rjuvr****）。

您需要在GroupA和GroupB中分别添加安全组规则，授权InstanceA和InstanceB内网互通。

- 在GroupA中添加安全组规则，授权InstanceB内网访问InstanceA，如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                                     | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :----------------------------------------------------------- | :----- |
  | 经典网络 | 入方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 格式：UserB的账号ID/GroupB的ID示例：135652617028****/sg-bp148p6ncq1rjuvr**** | 1      |

- 在GroupB中添加安全组规则，授权InstanceA内网访问InstanceB，如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                                     | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :----------------------------------------------------------- | :----- |
  | 经典网络 | 入方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 格式：UserA的账号ID/GroupA的ID示例：160998252992****/sg-bp174yoe2ib1sqj5**** | 1      |

案例3：只允许特定ip远程登录实例

Linux实例

| 网络类型 | 规则方向 | 授权策略 | 协议类型  | 端口范围 | 授权对象                                         | 优先级 |
| :------- | :------- | :------- | :-------- | :------- | :----------------------------------------------- | :----- |
| VPC      | 入方向   | 允许     | 自定义TCP | SSH (22) | 允许远程连接的CIDR，例如1.2.3.4/32或10.0.0.0/8。 | 1      |

案例4：只允许实例访问外部特定ip

- 禁止实例以任何协议访问所有公网IP地址，优先级应低于允许访问的规则（如本例中设置优先级为2）。安全组规则如下表所示。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型 | 端口范围 | 授权对象  | 优先级 |
  | :------- | :------- | :------- | :------- | :------- | :-------- | :----- |
  | VPC      | 出方向   | 拒绝     | 全部     | -1/-1    | 0.0.0.0/0 | 2      |

- 允许实例访问特定公网IP地址，优先级应高于拒绝访问的安全组规则的优先级（如本例中设置为1）。

  | 网络类型 | 规则方向 | 授权策略 | 协议类型           | 端口范围     | 授权对象                                             | 优先级 |
  | :------- | :------- | :------- | :----------------- | :----------- | :--------------------------------------------------- | :----- |
  | VPC      | 出方向   | 允许     | 选择适用的协议类型 | 设置端口范围 | 允许实例访问的特定CIDR，例如1.2.3.4/32或10.0.0.0/8。 | 1      |

## 快照

快照是某一时间点云盘数据状态的备份文件。

云盘第一份快照是实际使用量的全量快照，不备份空数据块，后续创建的快照均是增量快照，只存储变化的数据块。

快照适用范围：数据盘、系统盘

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412115128.png)

回滚快照操作时必需在云服务器ECS实例的状态为“停止”时才能进行

使用快照回滚，并不是自己创建快照自己用，可以用别的ECS实例的快照回滚的

### 创建云盘快照

1. 在左侧导航栏，选择**实例与镜像** > **实例**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要创建快照的实例，单击实例ID。
4. 在**实例详情**页，单击**云盘**页签。
5. 找到要创建快照的云盘，在**操作**列单击**创建快照**。

### 复制快照

创建了普通快照后，您可以将普通快照从一个地域复制到另一个地域，复制后的快照会被分配一个与源快照不同的ID。

通过复制快照，您可以在新的地域快速启用业务，或者将业务系统迁移到新的地域，降低运维成本以及实现更好的可用性。

操作：

1. 在左侧导航栏，单击**存储与快照** > **快照**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到目标快照，在**操作**列中，单击**复制快照**。
4. 在弹出**复制快照**对话框中，配置参数。

### 使用快照回滚云盘

发生系统故障或错误操作时，您可以使用快照回滚云盘，实现应用版本回退。

操作：

1. 在左侧导航栏，单击**实例与镜像** > **实例**。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要回滚云盘的实例，在**操作**列中，单击**管理**
4. 在**实例详情**页，单击**快照**页签。
5. 选择需要的快照，在**操作**列中，单击**回滚磁盘**。

### 自动快照策略

创建自动快照策略：

1. 在左侧导航栏，单击***\*存储与快照\** > \**快照\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**快照**页面，单击**自动快照策略**页签。
4. 在**自动快照策略**页面右上角处，单击**创建策略**。
5. 在**创建策略**对话框，完成自动快照策略设置。

| 区域                   | 说明                                                         |
| :--------------------- | :----------------------------------------------------------- |
| **策略名称**           | 自动快照策略的名称。                                         |
| **创建时间**           | 一天内创建自动快照的时间点，支持在00:00~23:00共24个整点中选择一个或多个时间点。<br />**说明** 创建快照会暂时降低块存储I/O性能，一般性能差异在10%以内，出现短暂瞬间变慢。建议您选择避开业务高峰的时间点。 |
| **重复日期**           | 创建自动快照的日期，支持在周一至周日之间选择一个或多个日期。 |
| **保留时间**           | 自动快照的保留时间，默认保留30天，支持以下选项：<br />**自定义时长**：保留天数范围为1~65536天。<br />**持续保留，直至快照数量达到额度上限后被自动删除**：在自动快照数量达到上限后，系统会删除最早创建的自动快照。 |
| **标签**               | 选择已有的标签键和标签值，或输入新的标签键和标签值，通过该自动快照策略创建的自动快照会默认绑定该标签。 |
| **快照跨地域复制**     | 如果启用快照跨地域复制，通过该自动快照策略创建的自动快照会自动复制到目标地域。选中**启用**后，您需要继续设置**目标地域**和**复制快照的保留时间**。 |
| **目标地域**           | 设置快照复制的目标地域。                                     |
| **复制快照的保留时间** | 设置复制快照后，目标地域中副本快照的保留时间。<br />**自定义时长**：保留天数范围为1~65536天。<br />**持续保留，不受快照数量额度上限影响**：目标地域中副本快照一直保留。 |

执行或取消自动快照：

- 在快照页面执行或取消自动快照策略

1. 在左侧导航栏，单击***\*存储与快照\** > \**快照\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**快照**列表页中，选择**自动快照策略**。
4. 在**自动快照策略**页面，找到需要修改的策略，在**操作**列，单击**设置磁盘**。
5. 在**设置磁盘**页面，单击**未设置策略磁盘**页签：
   - 如果想要执行快照策略：单击**未设置策略磁盘**页签，找到要执行策略的磁盘，单击其右侧的**执行快照策略**。或者选择多个磁盘，单击下面的**执行快照策略**。
   - 如果想要取消快照策略：单击**已设置策略磁盘**页签，找到要执行策略的磁盘，单击其右侧的**取消快照策略**。或者选择多个磁盘，单击下面的**取消快照策略**。

- 创建实例时启动自动快照策略

![image-20210412143107016](https://gitee.com/c_honghui/picture/raw/master/img/20210412143107.png)

- 创建云盘时启动自动快照策略

![image-20210412143526124](https://gitee.com/c_honghui/picture/raw/master/img/20210412143526.png)

## 镜像

镜像是一种地域性资源，您不能跨地域使用镜像创建实例。例如，在华北2（北京）地域创建实例时，您只能使用位于华北2（北京）地域的镜像。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210409000535.png)

### 镜像类型

#### 公共镜像

阿里云提供**Alibaba Cloud Linux镜像**和**第三方商业镜像及开源镜像合作的正版镜像**两种类型的公共镜像。除Windows Server和Red Hat Enterprise Linux之外，您可免费使用其他公共镜像创建ECS实例。

#### 自定义镜像

自定义镜像是您使用实例或快照创建的镜像，或是您从本地导入的镜像。

自定义镜像适用范围：仅系统盘

##### 用快照创建自定义镜像

通过创建自定义镜像，您可以将一台ECS实例的操作系统、数据制作成环境副本，再通过自定义镜像创建多台ECS实例，快速复制系统环境。

前提：您已经创建了一份系统盘快照。

找到目标实例，单机管理：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412001245.png)

单机快照，找到云盘属性为系统盘的目标快照，单击创建自定义镜像：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412001313.png)

##### 用实例创建自定义镜像

创建实例后，您可以根据业务需要自定义实例（如安装软件、部署应用环境等），并为更新后的实例创建自定义镜像。使用该镜像创建的新实例，会包含您已配置的自定义项，省去您重复自定义实例的时间。

前提：

- 检查实例的网络配置。
- 检查系统盘使用剩余空间，确保系统盘没有被写满。

注意：

- 无需停止实例即可创建镜像。
- 镜像创建过程中，不能改变实例的状态。例如，不要停止、启动或者重启实例，避免创建失败。
- 实例及其创建的镜像属于同一个地域。
- 不要在/etc/fstab文件中加载数据盘信息，否则使用该镜像创建的实例无法启动。

操作：

1. 找到目标实例。在**操作**列中，单击**更多** > **云盘和镜像** > **创建自定义镜像**。

##### 更新镜像

1. 在左侧导航栏，单击**实例与镜像** > **镜像**。
2. 在顶部菜单栏左上角处，选择地域。
3. 在**镜像**页面，选择**自定义镜像**页签。
4. 找到目标镜像，在**操作**栏单击[![更多操作](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2403222061/p171570.png)](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2403222061/p171570.png)图标，然后单击**更新镜像**。
5. 跳转至OOS管理控制台后，完成以下配置：
   1. 完成通用设置，包括输入新镜像名称和描述，并指定执行所使用到的权限来源。
   2. **可选：**完成镜像分发设置。您可以根据需要设置是否复制或共享该镜像。
   3. 选择镜像。如果您在前一步操作已选择了目标镜像，此时将自动选中，请确认已选的镜像是否为需要操作的镜像。
   4. 配置中转实例，设置用于创建临时ECS实例的专有网络、交换机、安全组和实例类型。
   5. **可选：**发送远程命令。您可以根据需要选择命令类型并输入命令内容，该命令内容将在临时创建的ECS实例中执行。
   6. **可选：**完成高级选项配置。您可以根据需要设置伸缩组配置，添加标签或将当前配置保存为模板。
6. 单击**立即执行**，并在弹出的对话框中确认提示信息。
7. 在**创建或更新镜像**页面，您可以查看任务运行情况。

##### 复制镜像

复制镜像适用于跨地域部署ECS实例、跨地域备份数据。

1. 在左侧导航栏，选择***\*实例与镜像\** > \**镜像\****。

2. 在顶部菜单栏左上角处，选择地域。

3. 在**镜像**页面，选择**自定义镜像**页签。

4. 选择需要复制的镜像，在**操作**列中，单击**复制镜像**。

5. 在**复制镜像**对话框中，完成以下配置。

   1. 确认选中的自定义镜像的ID。

   2. 在**目标地域**的下拉菜单中，选择一个地域，必须和当前地域不同。

   3. 填写镜像在目标地域显示的**自定义镜像名称**。

   4. **可选：**填写镜像在目标地域显示的**描述**。

   5. 可选：

      勾选**加密**，在下拉菜单中选择密钥**Default Service CMK**。

      **Default Service CMK**表示使用密钥管理服务KMS创建的默认密钥。

   6. 单击**确定**。

##### 导出镜像

## 块存储

块存储是阿里云为云服务器ECS提供的块设备产品,可以像使用物理硬盘一样格式化并建立文件系统来使用块存储.

块存储要和实例同一个可用区才可以挂载

关于系统盘

```text
通过更换ECS实例的系统盘操作来实现系统盘的扩容
扩容ECS实例的系统盘时需要停止您的实例，因此会短暂中断您的业务
扩容系统盘后，用户创建的快照会保留
```

一个ECS实例最多可以挂载16块数据盘

ECS 实例的系统盘使用的 SSD 云盘,需要新增数据盘时不能使用本地SSD 盘

重新初始化磁盘必须该磁盘已经挂载，并且挂载该磁盘的实例处于停止状态

### 块存储类型

#### 云盘

云盘是阿里云为云服务器ECS提供的数据块级别的块存储产品,云盘采用分布式三副本机制，为ECS实例提供99.9999999%的数据可靠性保证。

| 性能类别                                | ESSD云盘                   |                           |                          |                            | SSD云盘                  | 高效云盘                | 普通云盘 |
| :-------------------------------------- | :------------------------- | :------------------------ | :----------------------- | :------------------------- | ------------------------ | ----------------------- | -------- |
|                                         | PL3                        | PL2                       | PL1                      | PL0                        |                          |                         |          |
| 单盘最大容量（GiB）                     | 1261~32768                 | 461~32768                 | 20~32768                 | 40~32768                   | 32768                    | 32768                   | 2000     |
| 最大IOPS                                | 1000000                    | 100000                    | 50000                    | 10000                      | 25000                    | 5000                    | 数百     |
| 最大吞吐量（MB/s）                      | 4000                       | 750                       | 350                      | 180                        | 300                      | 140                     | 30~40    |
| 单盘IOPS性能计算公式                    | min{1800+50*容量, 1000000} | min{1800+50*容量, 100000} | min{1800+50*容量, 50000} | min{ 1800+12*容量, 10000 } | min{1800+30*容量, 25000} | min{1800+8*容量, 5000}  | 无       |
| 单盘吞吐量性能计算公式（MB/s）          | min{120+0.5*容量, 4000}    | min{120+0.5*容量, 750}    | min{120+0.5*容量, 350}   | min{100+0.25*容量, 180}    | min{120+0.5*容量, 300}   | min{100+0.15*容量, 140} | 无       |
| 单路随机写平均时延（ms），Block Size=4K | 0.2                        |                           |                          | 0.3~0.5                    | 0.5~2                    | 1~3                     | 5~10     |
| API参数取值                             | cloud_essd                 |                           |                          |                            | cloud_ssd                | cloud_efficiency        | cloud    |

#### 创建云盘

1. 在左侧导航栏，单击**存储与快照** > **云盘**。
2. 在**云盘**页面右上角，单击**创建云盘**。
3. 在创建云盘页面中，设置云盘的配置参数。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210412101903.png)

#### 使用快照创建云盘

前提：您已经为历史系统盘或数据盘创建了快照，并确认快照ID。

1. 在左侧导航栏，单击**存储与快照** > **云盘**。
2. 在**云盘**页面右上角，单击**创建云盘**。
3. 在云盘购买页面，单击**用快照创建磁盘**，并选择目标快照。

#### 挂载数据盘

可以将单独创建的按量付费云盘挂载到ECS实例上，作为数据盘使用

前提：

- 被挂载的实例和云盘在同一个可用区。
- 被挂载的实例的状态为**运行中**（Running）或者**已停止**（Stopped），不能为**已锁定**（Locked）。
- 云盘的状态为**待挂载**（Available）。
- 您的账号不欠费。

操作：

1. 在左侧导航栏，单击***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要挂载云盘的实例，单击实例ID。
4. 单击**云盘**页签，在**云盘**页面的右上方，单击**挂载云盘**。

#### 格式化数据盘

- 小于2T的盘

查看数据盘信息：

```shell
fdisk -l
```

创建一个分区：

```shell
fdisk -u /dev/vdb
p查看分区情况
n创建一个分区
p选择分区类型为主分区
1输入分区编号，按回车键。
回车
回车
p
w
```

创建文件系统：

```shell
mkfs -t ext4 /dev/vdb1
或
mkfs -t xfs /dev/vdb1
```

配置/etc/fstab并挂载

由于释放云盘等操作可能会导致其他云盘的设备名变动，建议您在/etc/fstab中使用全局唯一标识符UUID来引用新分区。

```shell
cp /etc/fstab /etc/fstab.bak
echo `blkid /dev/vdb1 | awk '{print $2}' | sed 's/\"//g'` /data ext4 defaults 0 0 >> /etc/fstab
mount /dev/vdb1 /data
```

- 大于2T的盘

```shell
yum install -y parted
yum install -y e2fsprogs
fdisk -l
#分区
parted /dev/vdb
mklabel gpt
mkpart primary 1 100%
#检查分区是否对齐
align-check optimal 1
print
quit
#使系统重读分区表
partprobe
#创建文件系统
mkfs -t ext4 /dev/vdb1
mount /dev/vdb1 /test
cp /etc/fstab /etc/fstab.bak
echo `blkid /dev/vdb1 | awk '{print $2}' | sed 's/\"//g'` /test ext4 defaults 0 0 >> /etc/fstab
```

ext4文件系统默认开启lazy init功能。该功能开启时，实例会发起一个线程持续地初始化ext4文件系统的metadata，从而延迟metadata初始化。所以在格式化数据盘后的近期时间内，云盘的IOPS性能会受到影响，IOPS性能测试的数据会明显偏低。

```shell
mke2fs -O 64bit,has_journal,extents,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize -E lazy_itable_init=0,lazy_journal_init=0   /dev/vdb1
```

#### 裸设备创建文件系统

```shell
mkfs.ext4 /dev/vdb
或
mkfs.xfs /dev/vdb
```

#### 在线扩容云盘

1. 为扩容云盘创建快照
2. 在平台扩容云盘容量
3. 查看云盘分区情况

```shell
fdisk -lu
```

4. 扩容分区

```shell
#分区为GPT格式，必须执行此步骤；如果您的分区为MBR格式，请跳过此步骤
yum install gdisk -y
#CentOS 7及以上版本运行以下命令。
yum install -y cloud-utils-growpart
#Debian 9及以上版本、Ubuntu14及以上版本运行以下命令。
apt-get update
apt-get install -y cloud-guest-utils
#扩容分区
growpart /dev/vda 1
```

5. 扩容文件系统

```shell
#扩容ext*
resize2fs /dev/vda1
#扩容xfs
xfs_growfs /media/vdc
```

支持在线扩容的Linux公共镜像（或基于公共镜像制作的自定义镜像）包括：

- Alibaba Cloud Linux：Alibaba Cloud Linux 2.1903 LTS 64位
- CentOS：
  - CentOS 6：CentOS 6.8及以上版本
  - CentOS 7：CentOS 7.2及以上版本
  - CentOS 8及以上版本
- Red Hat Enterprise Linux：
  - RHEL 6：RHEL 6.9及以上版本
  - RHEL 7：RHEL 7.4及以上版本
  - RHEL 8及以上版本
- Ubuntu：Ubuntu 16及以上版本
- Debian：Debian 8及以上版本
- SUSE：SUSE 12 SP2及以上版本
- OpenSUSE：OpenSUSE 42.3及以上版本

## 网络

专有网络（Virtual Private Cloud，简称VPC）是基于阿里云构建的一个隔离的网络环境，专有网络之间逻辑上彻底隔离。您可以自定义这个专有网络的拓扑和IP地址，适用于对网络安全性要求较高和有一定网络管理能力的用户。

在已经创建好的阿里云的云服务器ECS实例中进行了更改网卡mac地址的操作，可能会导致网络不通

如果您有已经创建的专有网络VPC和交换机，在创建专有网络VPC类型的云产品实例时，云产品实例还是会创建在默认交换机中，这时候可以自己选择VPC

通过与VPN连接方式结合，可以实现专有网络VPC与传统数据中心组成一个按需定制的网络环境。

同一个地域内，不同账号下，经典网络下可以通过安全组规则设置两台云服务器之间内网互通

使用阿里云高速通道可以实现专有网络VPC之间互联和私网通信

5M带宽是指带宽总出口是5M，下行5M，上行不限（这里的下行代表出网带宽即从服务器流出的带宽;上行代表入网带宽即流入服务器的带宽）

### 专有网络IP

私有IP

场景：

- 负载均衡
- 同一局域网内ECS实例之间内网互访
- 同一局域网内ECS实例与其他云服务（如OSS、RDS）之间内网互访

公网IP

阿里云只对公网出网带宽收取费用，入网带宽免费。

| 维度            | ECS系统分配的公网IP地址（PublicIP）                          | 弹性公网IP（EIP）地址                                        |
| :-------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| 使用场景        | 如果希望在创建ECS实例时由ECS系统自动分配一个公网IP地址，释放实例时这个公网IP地址随实例一起释放，不保留该公网IP地址，您可以选择PublicIP。 | 如果希望长期使用某个公网IP地址，根据业务需要将它绑定到指定的ECS实例上，您可以选择弹性公网IP（EIP）。EIP可以反复绑定和解绑。释放实例后，EIP仍然存在。 |
| 获取方式        | 在创建ECS实例时，如果您选择**分配公网IP地址**，实例即被分配一个PublicIP。 | 单独申请EIP地址，并绑定到未分配PublicIP的ECS实例上。         |
| 分配上限        | 一台ECS实例只能分配一个PublicIP。                            | 可以关联多个EIP，通过设置多EIP网卡可见模式实现。             |
| 解绑方式        | PublicIP一经分配，只能释放，不能解绑。                       |                                                              |
| 释放方式        | 释放实例时，PublicIP地址随实例一起释放。在实例的使用期间，将带宽值设置为0 Mbit/s，可以释放PublicIP。 |                                                              |
| 如何查看MAC地址 | VPC类型的ECS实例的公网访问通过私有网卡映射完成。所以，无论您的实例是否分配或者绑定了公网IP地址，在实例内部您都无法查询到公网网卡。 |                                                              |

### 修改私有IP

前提：

- 实例的弹性网卡未设置辅助私网IP地址。
- 实例处于已停止状态。

操作：

1. 在左侧导航栏，选择***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到目标实例，在**操作**区域选择***\*更多\** > \**网络和安全组\** > \**修改私有IP\****。

### 弹性网卡

弹性网卡ENI（Elastic Network Interface）是一种可以绑定到专有网络VPC类型ECS实例上的虚拟网卡。

#### 创建弹性网卡

前提：

- 已在相应地域下创建专有网络VPC，并创建虚拟交换机。
- 已在指定的专有网络下创建安全组。

操作：

1. 在左侧导航栏，单击***\*网络与安全\** > \**弹性网卡\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 单击**创建弹性网卡**。

#### 绑定弹性网卡

如果ECS实例最后一次启动时间在2018年4月1日之前（包括但不限于启动新购的实例、重启、重开机），您必须重启一直保持运行中状态的实例，否则不支持绑定弹性网卡。

操作：

1. 在左侧导航栏，单击***\*实例与镜像\** > \**实例\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 找到需要绑定弹性网卡的实例，在**操作**列中，单击***\*更多\** > \**网络和安全组\** > \**绑定辅助弹性网卡\****。

#### 配置弹性网卡

## 部署与弹性

### 实例启动模板

实例启动模板是一项持久化ECS实例配置的功能，可用于快速创建实例。实例启动模板中包含了用于创建实例的配置信息，可以存储除了密码以外的任意配置信息，包括密钥对、RAM角色、实例类型和网络设置等。

实例启动模板不支持修改，但可以创建多个版本，每个版本可以配置不同的参数，通过版本管理体现实例配置的演进过程。您可以使用模板任意一个版本创建实例。

#### 创建实例启动模板

1. 在左侧导航栏，单击***\*部署与弹性\** > \**实例启动模板\****。
2. 在顶部菜单栏左上角处，选择地域。
3. 单击**创建模板**。
4. 在**启动模板**页面，完成基础配置和高级配置。

### 基于ECS实例创建伸缩组

如果您的业务负载经常有临时波动或者有固定的扩缩容需求，建议您通过弹性伸缩的伸缩组来实现自动扩缩容。基于已有ECS实例创建伸缩组后，系统会根据业务情况自动添加或减少一组具有相同配置的ECS实例。

前提：

- 如果需要为伸缩组关联负载均衡实例，请确保满足以下条件：
  - 您持有一个或多个处于**运行中**状态的负载均衡实例。
  - 负载均衡实例和伸缩组必须位于同一地域。
  - 如果负载均衡实例和伸缩组的网络类型均为专有网络，则必须位于同一专有网络。
  - 当负载均衡实例的网络类型为经典网络，伸缩组的网络类型为专有网络时，如果负载均衡实例的后端服务器组中包含专有网络ECS实例，该ECS实例必须与伸缩组位于同一专有网络。
  - 负载均衡实例配置至少一个监听。
  - 负载均衡实例必须开启健康检查。
- 如果需要为伸缩组关联RDS实例，请确保满足以下条件：
  - 您持有一个或多个处于**运行中**状态的RDS实例。
  - RDS实例和伸缩组必须位于同一地域。

操作：

## 防止ecs重启覆盖resolv.conf

阿里云ECS默认采用dhcp分配网络，重启ecs时，dhclient会更新resolv.conf文件，这样就修改掉了ecs上配置的dns服务器。

禁止dhclient更新resolv.conf文件：
修改网卡配置文件，在该文件中添加如下语句即可：
vim /etc/sysconfig/network-scripts/ifcfg-eth0
PEERDNS=no

## Linux 启动与登录问题

Linux 启动与登录问题是 ECS 的高频问题，而往往处理不及时会直接影响到用户业务的正常可持续运行，因此也变成了我们处理问题优先级的重中之重。
在云环境上影响 ECS 启动与登录的因素非常多，镜像、管控、虚拟化、底层硬件、系统与文件异常等等。

### 系统启动与登陆异常

#### 系统启动异常

1.	 部分 CentOS 系统启动黑屏，无异常报错的场景，可以 fsck 一下系统盘。
2.	 根分区空间满，以及 inode 数量耗尽。
3.	 升级内核或者从老的共享实例迁移到独享规格导致的启动异常。
3.1	 手动注入驱动 (mkinitrd virtio 相关驱动 )。
3.2	 修改 grub 的启动顺序，优先尝试使用老内核启动。
3.3	 /boot 目录下面内核的关联文件是否全（下面仅为 demo，不同系统内核版
本文件不一致，部分内核版本 boot 下的 i386 目录也是有用的）。  

```text
config-4.9.0-7-amd64
initrd.img-4.9.0-7-amd64
System.map-4.9.0-7-amd64
vmlinuz-4.9.0-7-amd64
```

​	    3.4　/boot/grub/device.map 里面的 hda 改成 vda。  

4. fstab/grub 中的 uuid 不对，可以直接修改为 /dev/vda1 这种形式尝试。数据盘分区异常加载起不来的场景，可以去注释 fstab 所有的行，添加类似下面的启动项尝试，也适用于系统盘快照创建云盘挂载后，uuid 一致导致的启动异常，改成非 UUID 的挂载即可。  

```shell
/dev/vda1 / ext4 defaults 1 1
```

5.	 根目录权限 777（部分目录 777）也会导致启动异常，或者 ssh 登陆异常。
	 可参考下面的文章仅限修复尝试。
https://yq.aliyun.com/articles/761371
	
6. 常见的关键目录缺失，有的是软链，也可以看看对应目录下面的文件数量（文件
   数量要跟同内核版本或者相差不大的版本对比），简单判断。

   ```shell
   /bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin /usr/lib /
   usr/lib64 等目录或文件缺失
   for i in /bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin /
   usr/lib /usr/lib64 ;do ls -l $i |wc -l ;done
   ```

7. 影响启动的参数。
   如果参数设置不当，是会导致启动异常的，如 /etc/sysctl.conf 以及检查 rc.local
   的配置，profile 的检查。

   ```text
   vm.nr_hugepages
   vm.min_free_kbytes 
   ```

8. CentOS 的 selinux 需要关闭。  

#### root登陆异常

1. /etc/passwd /etc/shadow ( 用户名 root polikt dbus 等关键用户存在与否，文
   件为空，格式乱（dos2unix)。

2. /etc/pam.d 目录下是否有为空的文件及参数设置是否正常，如常见的 system-auth passwd。

3. /etc/pam.d 下面所有文件里面涉及的 so 文件，看看文件是否存在，是否为空 /
   usr/lib64/security。

4. 查 /etc /lib64 /bin /sbin /usr/bin /usr/sbin 等目录有没有 size 为 0 的文件。

5. /etc/profile /etc/profile.d( 打 印 列 表 ) /etc/bashrc /root/.bash_profile /root/.
   bashrc 等涉及登陆环境设置的文件是否异常。

6. 注意内核版本，是否存在新老内核，多更换几个内核试下。

7. 系统日志也是一个比较重要的检查项（后面会介绍无法登陆怎么检查）。

8. Ubuntu 12.04 登陆异常 在 /etc/login.defs 里面配置了错误的 ERASECHAR
   导致，恢复默认 0177 即可。  

   ```text
   configuration error - cannot parse erasechar value  
   ```

9. 输入 root 后直接 login 失败三连，日志如下。  

   ![image-20210303103154421](https://gitee.com/c_honghui/picture/raw/master/img/20210303103200.png)

​     找个同内核版本的机器对比发现没有 /etc/pam.d/login。
​	 rpm 包校验一下，确认 login 文件没了，手动创建一个，内容拷贝过来，好了。  

```shell
[root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -V util-linux
missing c /etc/pam.d/login
[root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -ql util-linux|egrep -vi "gz|mo|share"
/etc/mtab
/etc/pam.d/chfn
/etc/pam.d/chsh
/etc/pam.d/login
/etc/pam.d/runuser
/etc/pam.d/runuser-l
/etc/pam.d/su
/etc/pam.d/su-l
```

10. /etc/ssh/sshd_config 相 关 参 数 如 LoginGraceTime/Allowusers/PermitRootLogin。  

11.	 问题不好确认的时候，可以将 shadow 密码字段清空，看看登陆是否正常，可以判断是否到密码验证阶段了。  

​       之前有过一篇关于 ssh 问题排查的文档，可参考：https://yq.aliyun.com/articles/540769  

系统登陆不进去了，不挂盘的情况下怎么操作？
上面的检查点很多是需要切换到另外的系统环境下去做检查，比如挂载 LiveCD 或者chroot 切换；但对于使用 ECS 的用户来说，阿里云暂还未提供实例挂载 ISO 镜像的功能，那么如何进行上面的操作呢？可以借助阿里云新推出的卸载系统盘功能，可以把系统盘卸载掉，作为数据盘挂载到一个新的机器，这样就可以执行上面的检查了。
详见： https://help.aliyun.com/document_detail/146752.html    

Linux 系统常见问题诊断覆盖以下场景：  

![image-20210303104549455](https://gitee.com/c_honghui/picture/raw/master/img/20210303104549.png)

Linux 系统常见启动问题修复覆盖以下场景：  

![image-20210303104615919](https://gitee.com/c_honghui/picture/raw/master/img/20210303104616.png)

OS 参数收集脚本： https://public-beijing.oss-cn-beijing.aliyuncs.com/oos/caiji.sh
OS 优化脚本 github 链接： https://github.com/huigher/os-performance-optimization
OS 优化脚本 OSS 链接： https://xiaoling-public.oss-cn-hangzhou.aliyuncs.com/os_performance_optimization.py
OS 离 线 修 复 脚 本： https://public-beijing.oss-cn-beijing.aliyuncs.com/oos/oos_noak.sh  

### PAM不让你登陆

问题描述： ssh 可以登陆，管理终端无法登陆 root， 提示 login in...  

先通过 ssh 方式登录系统，查看登录日志是否有异常。  

```shell
cat /var/log/secure
Jun 2 09:26:48 iZbp1begsz1x269nxhtip4Z login: FAILED LOGIN 1 FROM tty1 FOR root，Authentication failure
```

似乎是 login 验证模块的问题进一步查看对应的配置文件 /etc/pam.d/login。  

```shell
# cat /etc/pam.d/login
#%PAM-1.0
auth required pam_succeed_if.so user != root quiet
auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_
securetty.so
auth substack system-auth
auth include postlogin
account required pam_nologin.so
account include system-auth
password include system-auth
# pam_selinux.so close should be the first session rule
session required pam_selinux.so close
session required pam_loginuid.so
session optional pam_console.so
# pam_selinux.so open should only be followed by sessions to be executed in
the user context
session required pam_selinux.so open
session required pam_namespace.so
session optional pam_keyinit.so force revoke
session include system-auth
session include postlogin
-session optional pam_ck_connector.so
```

其中一行的作用为禁止本地登录，可以将其注释掉即可  

```shell
auth required pam_succeed_if.so user != root quiet
```

### CentOS登陆卡住

问题描述：系统登陆卡住，需要 ctrl +c 才能进去，如图

![image-20210303110730675](https://gitee.com/c_honghui/picture/raw/master/img/20210303110730.png)

如果一直等的话，会提示如下截图：  

![image-20210303111152869](https://gitee.com/c_honghui/picture/raw/master/img/20210303111153.png)

原因：

/etc/profile 里面有 source /etc/profile 引起死循环，注释即可。  

## Linux性能问题

### 如何找出系统中 load 高时处于运行队列的进程  

有可能系统有很高的负载但是 CPU 使用率却很低，或者负载很低而 CPU 利用率很高  

每隔 1s 统计一次：  

```shell
#!/bin/bash
LANG=C
PATH=/sbin:/usr/sbin:/bin:/usr/bin
interval=1
length=86400
for i in $(seq 1 $(expr ${length} / ${interval}));do
date
LANG=C ps -eTo stat,pid,tid,ppid,comm --no-header | sed -e 's/^ \*//' |
perl -nE 'chomp;say if (m!^\S*[RD]+\S*!)'
date
cat /proc/loadavg
echo -e "\n"
sleep ${interval}
done
```

从统计出来的结果可以看到：  

```shell
at Jan 20 15:54:12 CST 2018
D 958 958 957 nginx
D 959 959 957 nginx
D 960 960 957 nginx
D 961 961 957 nginx
R 962 962 957 nginx
D 963 963 957 nginx
D 964 964 957 nginx
D 965 965 957 nginx
D 966 966 957 nginx
D 967 967 957 nginx
D 968 968 957 nginx
D 969 969 957 nginx
D 970 970 957 nginx
D 971 971 957 nginx
D 972 972 957 nginx
D 973 973 957 nginx
D 974 974 957 nginx
R 975 975 957 nginx
D 976 976 957 nginx
D 977 977 957 nginx
D 978 978 957 nginx
D 979 979 957 nginx
R 980 980 957 nginx
D 983 983 957 nginx
D 984 984 957 nginx
D 985 985 957 nginx
D 986 986 957 nginx
D 987 987 957 nginx
D 988 988 957 nginx
D 989 989 957 nginx
R 11908 11908 18870 ps
Sat Jan 20 15:54:12 CST 2018
25.76 20.60 19.00 12/404 11912
注： R 代表运行中的队列， D 是不可中断的睡眠进程
```

在 load 比较高的时候，有大量的 nginx 处于 R 或者 D 状态，他们才是造成 load 上升的元凶，和我们底层的负载确实是没有关系的。  

查 CPU 使用率比较高的线程小脚本：  

```shell
#!/bin/bash
LANG=C
PATH=/sbin:/usr/sbin:/bin:/usr/bin
interval=1
length=86400
for i in $(seq 1 $(expr ${length} / ${interval}));do
date
LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | grep -v CPU | sort -n -r | head -20
date
LANG=C cat /proc/loadavg
{ LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | sed -e 's/^ *//' | tr -s ' ' |
grep -v CPU | sort -n -r | cut -d ' ' -f 1 | xargs -I{} echo -n "{} + " &&
echo '0'; } | bc -l
sleep ${interval}
done
fuser -k $0
```

### 内存去哪了

背景： 收到报警，系统的内存使用率触发阈值  

![image-20210303113031265](https://gitee.com/c_honghui/picture/raw/master/img/20210303113031.png)

1. 登陆系统，使用命令查看内存分配  

   top 按M

   ![image-20210303113351708](https://gitee.com/c_honghui/picture/raw/master/img/20210303113351.png)

   free -m

   ![image-20210303113442724](https://gitee.com/c_honghui/picture/raw/master/img/20210303113442.png)

   atop看下内存分配（cat /proc/meminfo 也可以看到一些细化的内存使用信息）。  

   ![image-20210303114359952](https://gitee.com/c_honghui/picture/raw/master/img/20210303114400.png)

   

2. 发现 cache 才 1.7G，slab 非常高，4.4G，slab 内存简单理解为是系统占用的。使用 slabtop 继续分析。  

![image-20210303114730778](https://gitee.com/c_honghui/picture/raw/master/img/20210303114730.png)

3.	 看到 proc_inode_cache 使用的最多，这个代表是 proc 文件系统的 inode 的占用的。  

4. 查进程，但是进程不多，再查线程，可以通过如下命令进行检查。

   ps -eLf  

   ![image-20210303115214482](https://gitee.com/c_honghui/picture/raw/master/img/20210303115214.png)

​        计算 socket。  

```shell
ll /proc/22360/task/*/fd/ |grep socket |wc -l
140
```

​        计算有多少fd

```shell
ll /proc/22360/task/*/fd/ |wc -l
335
```

5. 每个 socket 的 inode 也不一样。  

   当时看到的现场有几万个 fd，基本全是 socket，每个 inode 都是占用空间的，且 proc 文件系统是全内存的。 所以我们才会看到 slab 中 proc_inode_cache内存占用高。  

### IO异常

简介： 遇到一个 IO 异常飙升的问题，IO 起飞后系统响应异常缓慢，看不到现场一直无法定位问题，检查对应时间点应用日志也没有发现异常的访问  

1. 确认IO发生在系统盘还是数据盘

   ```shell
   # iostat -d 3 -k -x -t 30
   06/12/2018 09:52:33 AM
   Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz
   avgqu-sz await svctm %util
   xvda 0.00 0.39 0.08 0.70 1.97 5.41 18.81
   0.03 44.14 1.08 0.08
   xvdb 0.00 0.00 0.00 0.00 0.00 0.00 8.59
   0.00 1.14 1.09 0.00
   06/12/2018 09:52:36 AM
   
   Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz
   avgqu-sz await svctm %util
   xvda 0.00 0.00 0.00 0.67 0.00 2.68 8.00
   0.00 1.00 0.50 0.03
   xvdb 0.00 0.00 0.00 0.00 0.00 0.00 0.00
   0.00 0.00 0.00 0.00
   ```

   每隔 3 秒采集一次磁盘 io，输出时间，一共采集 30 次，想一直抓的话把 30 去掉即可，注意磁盘空余量。  

   通过这个命令我们可以确认如下信息：
   \- 问题发生的时间
   \- 哪块盘发生的 io
   \- 磁盘的 IOPS（ r/s w/s）以及吞吐量（ rkB/s wkB/s ）  

2. 确认哪块盘发生了 IO 还不够，再抓一下发生 IO 的进程，需要安装 iotop 进行捕获  

   ```shell
   # iotop -b -o -d 3 -t -qqq -n 30
   10:18:41 7024 be/4 root 0.00 B/s 2.64 M/s 0.00 % 93.18 % fio
   -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G
   -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_
   Write_Testing
   ```

   每隔 3 秒采集一次，一共采集 30 次，静默模式，只显示有 io 发生的进程
   通过这个命令我们可以确认如下信息：
   \- 问题发生的时间
   \- 产生 IO 的进程 id 以及进程参数（ command）
   \- 进程产生的吞吐量（如果有多个可以把 qqq 去掉可显示总量）
   \- 进程占用当前 IO 的百分比  

3. 使用 fio 进行 IO 压测，具体参数可以参考块存储性能

   ```shell
   fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G
   -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_
   Write_Testing
   Rand_Write_Testing: (g=0): rw=randwrite， bs=1K-1K/1K-1K/1K-1K，
   ioengine=libaio， iodepth=128
   fio-2.0.13
   Starting 1 process
   ^Cbs: 1 (f=1): [w] [8.5% done] [0K/2722K/0K /s] [0 /2722 /0 iops] [eta
   05m:53s]
   fio: terminating on signal 2
   Rand_Write_Testing: (groupid=0， jobs=1): err= 0: pid=11974: Tue Jun 12
   10:36:30 2018
   write: io=88797KB， bw=2722.8KB/s， iops=2722 ， runt= 32613msec
   ......
   ```

   通过输出结果的时间点进行对比分析，相对于 fio 的 IOPS，吞吐量跟 iotop 以及iostat 监控到的数据是一致。

## Linux网络问题