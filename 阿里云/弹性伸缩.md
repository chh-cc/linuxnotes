# 弹性伸缩

弹性伸缩具备几分钟内交付上千台ECS实例的能力

## 功能

根据需求自动调整ecs数量

**自动向SLB的后端服务器组添加或移除相应的ecs实例**

**自动向RDS的白名单添加或移除ecs实例**

## 应用场景

固定时间负载激增，需自动扩展云计算资源

负载变化难以预测，需要自动根据CPU利用率、应用负载、带宽利用率作为指标进行弹性伸缩

固定时间需求增长，需要定时扩容

临时增大服务器需求，需要数分钟内实现从创建到可用

## 工作流程

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210416094306.png" alt="img" style="zoom:67%;" />

创建好伸缩组、伸缩配置、伸缩规则、伸缩触发任务后，系统会自动化执行以下流程（以增加 ECS 实例为例）：

1. 伸缩触发任务会按照各自触发生效的条件来触发伸缩活动。

- **云监控任务**会实时监控伸缩组内 ECS 实例的性能，并根据用户配置的报警规则（如伸缩组内所有 ECS 实例的 CPU 平均值大于 60%）触发执行伸缩规则请求。
- **定时任务**会根据用户配置的时间来触发执行伸缩规则请求。
- 您可以根据自己的监控系统及相应的报警规则（如在线人数、作业队列）来触发执行伸缩规则请求。
- **健康检查任务**会定期检查伸缩组和 ECS 实例的健康情况，如发现有不健康的 ECS 实例（如 ECS 为非 **Running** 状态）会触发执行 **移出该 ECS 实例** 的请求。

2. 根据**伸缩规则**、伸缩组、**伸缩配置**的相关信息，**并创建伸缩活动**。

3. 在伸缩活动中，**自动创建 ECS 实例并配置负载均衡和 RDS**。

- 按照实例配置信息创建指定数量的 ECS 实例。


- 将创建好的 ECS 实例的内网 IP 添加到指定的 RDS 实例的访问白名单当中，将创建好的 ECS 实例添加到指定的负载均衡实例当中。

4. 伸缩活动完成后，启动伸缩组的**冷却功能**。待冷却时间完成后，该伸缩组才能接收新的执行伸缩规则请求。

## 费用

伸缩组本身不收费，但是您需要为伸缩组内的ECS实例付费。停用伸缩组后，如果伸缩组内的ECS实例还存在，则需要继续为ECS实例付费。

## 使用流程

### 伸缩组

伸缩组是具有**相同应用场景的ECS实例的集合**。伸缩组定义了组内可容纳ECS实例数的最大最小值、关联负载均衡实例、关联RDS实例等属性。

ECS不支持加入多个伸缩组

停用伸缩组后不会自动释放伸缩组内的ECS

一个伸缩组可以添加多种规格的ECS实例

创建伸缩组:

1. 单击**伸缩组管理**
2. 选择地域
3. 单击**创建伸缩组**
4. 配置举例
   - **来源类型**设置为**从零开始创建**。
   - **组内最小实例数**设置为**0**。
   - **网络类型**设置为**专有网络**。
   - **多可用扩缩容策略**设置为**均衡分布策略**。
   - **实例回收模式**设置为**释放模式**。
   - 绑定当前业务模块所使用的SLB实例和RDS实例。

| 伸缩组属性               | 说明                                                         |
| :----------------------- | :----------------------------------------------------------- |
| **组内实例配置信息来源** | **启动模板**：扩容时使用实例启动模板中的实例配置信息。<br />**选择已有实例**：提取已有ECS实例的配置信息创建一个默认伸缩配置，作为自动创建ECS实例的模板。提取的配置信息包括实例的实例规格、镜像、网络类型、安全组、登录密码、标签等。<br />**从零开始创建**：不指定自动创建ECS实例的模板，伸缩组创建完成后进入停用状态。您需要继续创建伸缩配置或指定启动模板作为自动创建ECS实例的模板，然后才能启用伸缩组。 |
| **实例移出策略**         | 如果按策略筛选后仍有多台ECS实例满足要求，则随机移出一台。支持两段设置**先筛选**和**再从结果中移出**，但不支持为这两段设置相同的选项。<br />**最早伸缩配置对应的实例**：筛选添加时间最早的伸缩配置和启动模板对应的实例。手动添加的实例没有关联伸缩配置或启动模板，因此不会首先选出手动添加的实例。如果已移出全部关联的实例，仍需要继续移出实例，则随机移出手动添加的实例。<br />**最早创建的实例**：筛选创建时间最早的实例。<br />**最新创建的实例**：筛选创建时间最新的实例。<br />**无策略**：仅在设置**再从结果中移出**时可选，表示不进行第二段筛选。<br />例如，如果第一段设置为先筛选**最早伸缩配置对应的实例**，则第二段设置仅支持以下选项：<br />**无策略**：不进行第二段筛选。<br />**最早创建的实例**：在第一段筛选出的实例中，再筛选创建时间最早的实例。<br />**最新创建的实例**：在第一段筛选出的实例中，再筛选创建时间最新的实例。 |
| 暂停的流程               | 例如暂停健康检查流程后再去停止ECS实例，避免ECS实例被视为不健康而自动移出伸缩组。<br />**扩容流程**：伸缩组拒绝所有扩容动作。<br />**缩容流程**：伸缩组拒绝所有缩容动作。<br />**健康检查**：暂停将实例标记为不健康状态，并暂停移出不健康的ECS实例。<br />**定时任务**：到定时任务的执行时间后，不会触发关联的伸缩规则。<br />**报警任务**：报警任务进入报警状态后，不会触发关联的伸缩规则。 |
| 开启伸缩组保护           | 开启伸缩组保护后，您不能在控制台或者通过API删除该伸缩组，有效避免误删除伸缩组。 |
| **实例的健康检查**       | 开启健康检查后，伸缩组会定期检查ECS实例的运行状态，如果发现一台ECS实例未处于运行中状态，则判定为不健康并移出该ECS实例。 |
| **组内最小实例数**       | 当前ECS实例数量低于下限时，伸缩组会自动添加ECS实例，使得伸缩组内的ECS实例数量等于下限。 |
| **组内最大实例数**       | 当前ECS实例数量超过上限时，伸缩组会自动移出ECS实例，使得伸缩组内的ECS实例数量等于上限。 |
| 组内期望实例数           | 当伸缩组内实例数不等于期望实例数时，弹性伸缩服务会自动进行扩缩容，确保伸缩组内始终保持该数量的实例数 |
| **默认冷却时间（秒）**   | 冷却时间是指同一伸缩组内成功**完成一个伸缩活动后的一段锁定时间**。在冷却时间内，伸缩组会拒绝云监控报警任务触发伸缩活动的请求，避免因监控指标值波动导致频繁触发伸缩活动。 |
| **扩缩策略**             | **优先级策略<br />**根据您定义的虚拟交换机扩缩容。当优先级较高的虚拟交换机所在可用区无法创建ECS实例时，自动使用下一优先级的虚拟交换机创建ECS实例<br />**均衡分布策略<br />**在伸缩组指定的多可用区（即指定多个专有网络交换机）之间均匀分配ECS实例。如果由于库存不足等原因可用区之间变得不平衡，您可以进行再均衡操作来平衡资源的可用区分步。 |

#### 伸缩配置(还有另一个选项是启动模板)

伸缩配置是弹性伸缩自动创建ECS实例时所使用的**实例模板**，包含了**ECS实例的配置信息**。

一个伸缩组支持创建多个伸缩配置，但**同一时间只允许一个伸缩配置处于生效状态**。

自动扩容时，伸缩组根据组内实例配置信息来源创建ECS实例，并将ECS实例添加到伸缩组

创建伸缩配置:

1. 打开伸缩组详情页面

2. 在页面上方，单击**配置来源**。

3. 单击**伸缩配置**

4. 单击**创建伸缩配置**

   **镜像**可设置为自定义镜像

5. 启用伸缩组和伸缩配置

#### 伸缩规则

伸缩规则用于指定扩缩容ECS实例的数量等信息或者智能地设置伸缩组边界值

- 步进规则、目标追踪规则、简单规则：用于在触发伸缩活动时控制增加、减少ECS实例的数量。
- 预测规则：基于历史监控数据预测未来的指标值，并智能设置伸缩组边界值。

弹性伸缩支持的伸缩规则类型如下:

| 伸缩规则类型 | 用途                   | 说明                                                         |
| :----------- | :--------------------- | :----------------------------------------------------------- |
| 步进规则     | 触发伸缩活动。         | 基于云监控报警服务的分段扩缩容策略，在简单规则的基础上增加了分步定义，可以通过一组策略集合精细地控制扩缩容。 |
| 预测规则     | 智能设置伸缩组边界值。 | 基于机器学习，可以通过分析伸缩组的历史监控数据预测未来监控指标值，并支持自动创建定时任务，智能设置伸缩组边界值。在创建伸缩组时，如果您并不了解业务运行情况，设置的伸缩组边界值可能与实际需求存在偏差。伸缩组内最小实例数过高可能会导致购入过多计算资源，伸缩组内最大实例数过低又可能导致计算资源不足，影响服务稳定。预测规则会获取至少24小时的历史监控数据，利用机器学习能力预测未来48小时的监控指标值，然后计算出伸缩组每小时需要的实例数，即预测值。预测结果每天更新一次，并为未来48小时创建48个预测任务。**说明** 预测规则用于调整伸缩组的边界值，即伸缩组最大实例数和伸缩组最小实例数，不能直接扩缩容。 |
| 目标追踪规则 | 触发伸缩活动。         | 您需要选择一项云监控指标，并指定目标值。弹性伸缩会自动计算所需的实例数量并进行扩缩容，从而将云监控指标维持在目标值附近。<br />**说明** 创建目标追踪规则后，伸缩组会自动创建关联的报警任务。当伸缩组的数据指标达到您设定的目标时，触发此报警任务执行关联的目标追踪规则。如果您不再需要此报警任务，您必须删除关联的目标追踪规则，伸缩组会同步删除报警任务。 |
| 简单规则     | 触发伸缩活动。         | 支持增加或减少指定数量的实例，或者将实例数量调整至指定值。   |

创建伸缩规则步骤:

1. 打开伸缩组详情页面
2. 单击**伸缩规则**页签
3. 单击**创建伸缩规则**
4. 完成伸缩规则的相关参数配置
   - **伸缩规则类型**设置为**目标追踪规则**。
   - **指标类型**设置为**（ECS）平均CPU使用率**。
   - **目标值**设置为**50%**。

#### 伸缩活动

伸缩活动用于记录伸缩组内ECS实例数、伸缩组边界值、期望实例数等数量的变化情况。

执行伸缩规则、修改伸缩组边界值、修改期望实例数等操作均会触发伸缩活动。