# 弹性伸缩

弹性伸缩可以实现计算资源随业务峰谷自动伸缩，无需您提前预估和手动干预即可确保应用可用性。尤其针对双十一等大促活动，弹性伸缩具备几分钟内交付上千台ECS实例的能力，自动及时地应对突增流量，提升业务的可靠性。

您可以采用以下方案：

- 针对日常业务流量，购买包年包月ECS实例。
- 针对计划外突增流量，通过弹性伸缩监控负载变化并实现自动创建ECS实例。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210416143638.png" alt="img" style="zoom:67%;" />

## 功能概述

- 根据客户业务需求自动调整ECS实例数量。
- 自动向负载均衡的后端服务器组中添加或移除相应的ECS实例。
- 自动向RDS访问白名单中添加或移除ECS实例的IP。

## 工作流程

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210416094306.png" alt="img" style="zoom:67%;" />

伸缩触发任务会按照各自触发生效的条件来触发伸缩活动。

- 云监控任务会实时监控伸缩组内 ECS 实例的性能，并根据用户配置的报警规则（如伸缩组内所有 ECS 实例的 CPU 平均值大于 60%）触发执行伸缩规则请求。
- 定时任务会根据用户配置的时间来触发执行伸缩规则请求。
- 您可以根据自己的监控系统及相应的报警规则（如在线人数、作业队列）来触发执行伸缩规则请求。
- 健康检查任务会定期检查伸缩组和 ECS 实例的健康情况，如发现有不健康的 ECS 实例（如 ECS 为非 **Running** 状态）会触发执行 **移出该 ECS 实例** 的请求。

2. 系统自动通过 ExecuteScalingRule 接口触发伸缩活动，并在该接口中指定需要执行的伸缩规则的阿里云资源唯一标识符（Ari）。

   如果是用户自定义的任务，则需要用户在自己的程序中调用 ExecuteScalingRule 接口来实现。

3. 根据步骤 2 传入的伸缩规则 Ari（Rule Ari）获取伸缩规则、伸缩组、伸缩配置的相关信息，并创建伸缩活动。

   通过伸缩规则 Ari 查询伸缩规则以及相应的伸缩组信息，计算出需要增加的 ECS 实例数量，并获得需要配置的负载均衡和 RDS 信息。

   通过伸缩组查询到相应的伸缩配置信息，即获得了需要创建的ECS实例的配置信息（CPU、内存、带宽等）

   根据需要增加的 ECS 实例数量、ECS 实例配置信息、需要配置的负载均衡实例和 RDS 实例创建伸缩活动。

4. 在伸缩活动中，自动创建 ECS 实例并配置负载均衡和 RDS。

   按照实例配置信息创建指定数量的 ECS 实例。

   将创建好的 ECS 实例的内网 IP 添加到指定的 RDS 实例的访问白名单当中，将创建好的 ECS 实例添加到指定的负载均衡实例当中。

5. 伸缩活动完成后，启动伸缩组的冷却功能。待冷却时间完成后，该伸缩组才能接收新的执行伸缩规则请求。

## 伸缩模式

用来指定伸缩组何时增加或者减少指定数量的ECS实例。

- 定时模式：您可以创建定时任务，在指定时间执行指定伸缩规则。
- 动态模式：您可以基于云监控性能指标（如CPU利用率）创建报警任务，当伸缩组的指标数据满足您指定的报警条件时，触发报警并执行您指定的伸缩规则。
- 固定数量模式：
  - 您在伸缩组设置了**最小实例数**，当伸缩组的ECS实例数量低于下限时，伸缩组会自动添加ECS实例，使得伸缩组内的ECS实例数量等于下限。
  - 您在伸缩组设置了**最大实例数**，当伸缩组的ECS实例数量超过上限时，伸缩组会自动移出ECS实例，使得伸缩组内的ECS实例数量等于上限。
  - 您可以在创建伸缩组时设置**期望实例数**，伸缩组会自动将ECS实例数量维持在期望实例数。
- 健康模式：您可以在伸缩组开启健康检查功能，伸缩组会定期检查ECS实例的运行状态，如果发现一台ECS实例未处于运行中状态，则判定为不健康并移出该ECS实例。
- 自定义模式：您可以手动进行弹性伸缩，包括手动执行伸缩规则，或者手动添加、移出或者删除已有的ECS实例。
- 多模式并行：以上所有模式都可以组合配置。例如，在每天中午12点开始，业务需求明显增加，您可以设置定时任务，在每天12点创建20台ECS实例以应对业务高峰。但创建的ECS实例台数不一定能满足需求， 则您可以选择其他伸缩模式，如动态模式、自定义模式等，与定时模式配合一起使用。

## 使用流程

### 创建伸缩组

为需要弹性扩缩容的业务模块创建伸缩组，并为伸缩配置选择Web应用实例的自定义镜像，确保自动创建出的ECS实例符合Web应用的要求。

- 创建一个伸缩组。
  - **来源类型**设置为**从零开始创建**。
  - **组内最小实例数**设置为**0**。
  - **网络类型**设置为**专有网络**。
  - **多可用扩缩容策略**设置为**均衡分布策略**。
  - **实例回收模式**设置为**释放模式**。
  - 绑定当前业务模块所使用的SLB实例和RDS实例。

### 创建伸缩配置

1. 单击**查看伸缩组详情**。

2. 在页面上方，单击**配置来源**。

3. 创建一个伸缩配置。

   **镜像**设置为Web应用实例的自定义镜像。

4. 启用伸缩组

### 创建伸缩规则

将包年包月ECS实例添加至伸缩组，并创建目标追踪规则，实现根据业务峰谷自动伸缩，应对突增流量。

1. 前往**实例列表**界面，将创建好的包年包月ECS实例添加至伸缩组。
2. 将包年包月ECS实例转为保护状态，保证日常业务正常运行。
3. 前往**基本信息**界面，根据业务需求，修改伸缩组的最小实例数和最大实例数。
4. 前往**伸缩规则**界面，创建一条目标追踪规则。
   - **伸缩规则类型**设置为**目标追踪规则**。
   - **指标类型**设置为**（ECS）平均CPU使用率**。
   - **目标值**设置为**50%**。



