# 负载均衡

## 产品概述

负载均衡SLB（Server Load Balancer）是一种对流量进行按需分发的服务，通过将流量分发到不同的后端服务来扩展应用系统的服务吞吐能力，并且可以消除系统中的单点故障，提升应用系统的可用性。

负载均衡负责HTTPS流量的加密与解密，后端服务器仅需处理普通HTTP流量，可以极大的节省后端服务在数据加解密上的算力，有效控制后端服务器的规模与成本。

与传统的硬件型负载均衡自建方案相比，阿里云负载均衡具备按量付费和弹性伸缩能力，无需一次性大额投入，便可拥有天猫双十一级别的海量流量分发处理能力。

## CLB

随着**应用型负载均衡ALB（Application Load Balancer）**的引入，原**负载均衡SLB（Server Load Balancer）**现称为**传统型负载均衡CLB（Classic Load Balancer）**，**负载均衡SLB**为负载均衡产品家族的总称。

组成：

- 负载均衡实例 （Instances）

  一个负载均衡实例是一个运行的负载均衡服务，用来接收流量并将其分配给后端服务器。要使用负载均衡服务，您必须创建一个负载均衡实例，并至少添加一个监听和两台ECS实例。

- 监听 （Listeners）

  监听用来检查客户端请求并将请求转发给后端服务器。监听也会对后端服务器进行健康检查。

- 后端服务器（Backend Servers）

  后端服务器是一组接收前端请求的ECS实例。您可以单独添加ECS实例到后端服务器池，也可以通过虚拟服务器组或主备服务器组来批量添加和管理。

高可用：

四层负载均衡通过LVS（Linux Virtual Server）+ keepalived的方式实现，七层负载均衡通过Tengine（淘宝网发起的Web服务器项目，在Nginx的基础上，针对有大访问量的网站需求进行了优化）实现。

负载均衡通过健康检查来判断后端ECS实例的可用性。开启健康检查功能后，当后端某个ECS实例健康检查出现异常时，负载均衡会自动将新的请求分发到其他健康检查正常的ECS实例上，而当该ECS实例恢复正常运行时，负载均衡会将其自动恢复到负载均衡服务中。

选择地域:

- 由于负载均衡不支持跨地域部署，因此应选择与后端ECS实例相同的地域。

### 实例

- 对于按量付费实例，建议您直接选择可以买到的最大规格，这样可以保证业务的灵活性（弹性），且不会让您额外多付出成本。但如果您认为您的业务量不太可能到达超强型I（slb.s3.large），也可以设置一个合理的弹性上限，比如高阶型II（slb.s3.medium）。
- 对于预付费实例，您需要评估您的实际业务量，然后选择一个较合适的规格，对于业务量评估来说，主要参考下面几个原则：
  - 如果是四层监听，关注的重点是长连接的并发连接数，那么最大（并发）连接数应当作为一个关键指标来参考。根据不同的业务场景，您需要预估一个负载均衡实例需要承载的最大并发连接数，并选择相应的规格。
  - 如果是七层监听，关注的重点是QPS的性能，QPS决定了一个七层应用系统的吞吐量。同样，您也需要根据经验对QPS进行预估。在初步选定一个规格后，在业务压测和实测过程中对规格进行微调。

#### 配置CLB实例

1. 在**实例管理**页面，单击要配置监听的实例**操作**列的**监听配置向导**。
2. 在**协议&监听**配置向导下，根据以下信息，配置监听规则，其它配置保持默认选项。

| 监听配置              | 说明                                                         |
| :-------------------- | :----------------------------------------------------------- |
| **选择负载均衡协议**  | 选择监听的协议类型。本示例选择**TCP**协议。                  |
| **监听端口**          | 用来接收请求并向后端服务器进行请求转发的负载均衡系统的前端协议和端口，本示例端口设置为**80**。<br />**说明** 在同一个负载均衡实例内，监听端口不可重复。 |
| **监听名称**          | 监听对外显示的名称。长度为2~256个字符，必须是中文和以下字符串中的字符：`/^([^\x00-\xff]|[\w.,;/@-]){2,256}$/`。如不填写，系统默认为**协议_端口**。 |
| **高级配置**          |                                                              |
| **调度算法**          | 选择调度算法，本教程选择**轮询（RR）**。<br />**加权轮询 (WRR)**：将访问请求依序分发后端服务器，后端服务器的权重越高，被分发的几率也越大。<br />**轮询 (RR)**：按照访问顺序将访问请求分发给后端服务器。<br />**一致性哈希 (CH)**：仅性能保障型实例支持一致性哈希（CH）调度算法。 |
| **开启会话保持**      | 开启后，将同一IP地址的请求转发至同一台后端服务器进行处理。   |
| **启用访问控制**      | 启用后，可通过配置白名单或黑名单，允许或禁止某些特定的IP地址访问负载均衡。 |
| **开启监听带宽限速**  | 设定不同的带宽峰值来限定后端ECS实例的不同应用所能对外提供的服务能力。本教程创建的公网负载均衡实例是按流量计费的，不受带宽峰值限制，所以不进行配置。 |
| **连接超时时间**      | 连接空闲时间超过该设定时长后，负载均衡会自动断开连接。取值范围为10~900秒。 |
| **ProxyProtocol配置** | 通过ProxyProtocol协议将客户端源IP地址或VPC ID转发到后端服务器。 |
| **获取客户端真实IP**  | 默认开启。                                                   |

3. 单击**下一步**，配置后端服务器，本教程以默认服务器组为例。
4. 在**后端服务器**页签下，选择**默认服务器组**，单击**继续添加**，添加后端服务器。

​       在**我的服务器**面板，勾选之前创建的ECS01和ECS02实例，单击**下一步**。

​       配置权重，权重越大转发的请求越多，默认为100，保持默认值即可。

​       单击**添加**。

​       在**默认服务器**页签下，配置后端协议端口，ECS实例上开放的用来接收请求的后端端口，在同一个负载均衡实例内可重复。本教程端口设置为**80**。

5. 单击**下一步**，配置健康检查，本教程使用默认值。

​       开启健康检查功能后，当后端某个ECS健康检查出现问题时，负载均衡服务会将请求转发到其它健康检查正常的ECS上，而当该ECS恢复正常运行时，负载均衡会自动恢复它的请求转发。

### 监听

- 四层监听将请求直接转发给后端服务器，不会修改报头。客户端请求到达负载均衡监听后，负载均衡服务器会使用监听中配置的后端端口与后端服务器建立TCP连接。

- 七层监听原理上是反向代理的一种实现。客户端请求到达负载均衡监听后，负载均衡服务器会通过与后端服务器建立TCP连接，即再次通过新TCP连接HTTP协议访问后端，而不是直接转发报文到后端ECS。

  由于七层监听比四层监听在底层实现上多了一个Tengine处理环节，因此，七层监听性能没有四层好。此外，客户端端口不足、后端服务器连接过多等场景也可能导致七层服务性能不高，如果您对性能有很高的要求，建议您使用四层监听。

- 可根据应用场景选择监听协议：tcp udp http https

### 后端服务器

- 确保ECS实例的地域和负载均衡实例的地域相同。此外，建议您将ECS部署在不同的可用区内，提高可用性
- 在ECS上部署好应用后，不需要再进行特别的配置。但如果您要配置一个四层监听（TCP协议或UDP协议），并且ECS使用的是Linux系统，确保ECS实例上/etc/sysctl.conf目录下net.ipv4.conf文件中的以下三个参数的值为零：

```
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```

#### 默认服务器组

用来接收前端请求的ECS实例。如果监听没有设置虚拟服务器组或主备服务器组，默认将请求转发至默认服务器组中的ECS。

在使用负载均衡服务前，必须至少添加一台默认服务器接收负载均衡转发的客户端请求。

#### 虚拟服务器组

虚拟服务器组 （VServer group）是一组 ECS 实例。将虚拟服务器组和一个监听关联后，监听只会将流量转发给关联的虚拟服务器组的后端服务器，不会再将流量转发给其他后端服务器。

#### 主备服务器组

一个主备服务器组只包括两台ECS实例，一台作为主服务器，一台作为备服务器。由于备服务器不会做健康检查，所以只要主服务器健康检查失败，系统会直接将流量切到备机。当主服务器健康检查成功恢复服务后，流量会自动切到主服务器。

### 健康检查

#### 配置健康检查

1. 单击负载均衡实例的ID。

2. 单击**监听**页签。

3. 单击**添加监听**或目标监听**操作**列的**修改监听配置**。

4. 单击**下一步**至**健康检查**页签，配置健康检查。

   在配置健康检查时，建议您使用默认值。

#### 健康检查探测

### 证书管理

#### 部署https业务(单向认证)

1. 购买服务器证书并上传到负载均衡的证书管理系统,上传后无需在后端ecs上进行其他证书配置,上传的证书必须是PEM格式
2. 配置负载均衡实例

- 在**监听**页签下，单击**添加监听**。
- 在**协议&监听**页签下，完成如下配置。
  - **选择负载均衡协议**：HTTPS。
  - **监听端口**：443。
  - **调度算法**：轮询（RR）。
- 单击**下一步**，在**SSL证书**页签下，选择已经上传的服务器证书和TLS安全策略。
- 单击**下一步**，选择**默认服务器组**，单击**继续添加**，添加ECS服务器，后端协议监听端口设置为80。

### 实践

#### 单SLB实例配置多域名https网站

场景：将来自域名为*.example1.com的前端请求转发至虚拟服务器组test1上，将来自域名为www.example2.com的前端请求转发至虚拟服务器组test2上。

前提：创建负载均衡实例并上传所需证书

操作：

1. 添加https监听
2. 配置转发规则

- 找到已创建的HTTPS监听，单击***\*配置转发策略\****。
- 配置域名转发规则，URL不进行设置
  - 设置规则名称，在**域名**操作列输入*.example1.com，选择test1虚拟服务器组，单击**添加转发策略**。
  - 设置规则名称，在**域名**操作列输入www.example2.com，选择test2虚拟服务器组，单击**添加转发策略**。

3. 添加扩展域名

#### 将http访问重定向到https

前提:已创建https监听

操作:

1. 在**监听**页签下，单击**添加监听**。
2. 在**协议&监听**页签下，负载均衡协议选择**HTTP**， 监听端口输入**80**。
3. 单击**高级配置**后的**修改**。
4. 开启**监听转发**，选择目的监听为**HTTPS:443**。

#### 相同域名不同路径的流量转发

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210415145254.png" alt="img" style="zoom:67%;" />

### 压力测试

四层监听经过LVS后直接到达后端服务器，而七层监听经过LVS后，还需要再经过Tengine，最后到达后端服务器。七层监听比四层监听多了一个处理环节，因此，七层性能没有四层性能好。

以下情况也可能会造成七层压测性能低：

- 客户端端口不足 。

  在进行压力测试时，客户端端口不足会导致建立连接失败。负载均衡会默认抹除TCP连接的timestamp属性，Linux协议栈的tw_reuse（time_wait 状态连接复用）无法生效，time_wait状态连接堆积导致客户端端口不足。

  解决方法：客户端使用长连接代替短连接。使用RST报文断开连接，即socket设置SO_LINGER属性。

- 后端服务器accept队列满 。

  后端服务器accept队列满，导致后端服务器不回复syn_ack报文，客户端超时。

  解决方法：默认net.core.somaxconn的值为128，执行`sysctl -w net.core.somaxconn=1024`命令更改net.core.somaxconn的值，并重启后端服务器上的应用。

- 后端服务器连接过多。

  由于架构设计的原因，使用七层负载均衡时，用户长连接经过Tengine后变成短连接，可能导致后端服务器连接过多，从而表现为压测性能低。

- 后端服务器依赖的应用成为瓶颈。

  请求经过负载均衡到达后端服务器后，后端服务器本身负载正常，但由于所有的后端服务器上的应用又依赖其它应用，例如数据库，当数据库成为瓶颈时，也会引起性能降低。

- 后端服务器的健康检查状态异常。

  在压测时，容易忽略后端服务器的健康检查状态，如果有后端服务器健康检查失败或者健康检查状态经常跳跃（好到坏，又从坏到好，反复变化），也会导致压测性能低。

压测建议:

- 压测负载均衡转发能力建议使用短连接 。

  一般来说压测除了验证会话保持和均衡性等功能外，主要想验证负载均衡的转发能力，因此使用短连接比较合适，用于测试负载均衡和后端服务器的处理能力。使用短连接测试时，需要注意客户端端口不足的问题。

- 压测负载均衡吞吐量建议使用长连接，用于测试带宽上限或特殊业务。

  压测工具的超时时间建议设置为一个较小值，如5秒。超时时间太大的话，测试结果会体现在平均响应时间加长，不利于判断压测水位是否已到达。超时时间调小，测试结果会体现在成功率上，便于快速判断压测水位。

- 后端服务器提供一个静态网页用于压测，以避免应用逻辑带来的损耗。

- 压测时，监听配置建议如下：

  - 不开启会话保持功能，否则压力会集中在个别后端服务器。
  - 关闭健康检查功能，减少健康检查对后端服务器的访问请求。
  - 性能测试服务的5000并发规格能够提供5个及5个以上的公网IP。

不建议您使用Apache ab作为压力测试工具。

Apache ab在大量并发场景下存在3s、6s、9s阶梯式停顿的现象。Apache ab会通过判断content length来确定请求是否成功，而负载均衡挂载多台后端服务器时，返回的content length会不一致，导致测试结果有误。

建议使用阿里云[PTS](https://pts.aliyun.com/)。

可以设置足够高的并发，PTS会分配来自全国各地的公网IP，压力来源足够分散，并且可以在PTS中集成云监控，实时查看端到端的全部性能数据。

## ALB

专门面向七层，提供超强的业务处理性能，例如HTTPS卸载能力。单实例每秒查询数QPS（Query Per Second）可达100万次。

### 服务器组

#### 创建服务器组

1. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。
2. 在**服务器组**页面，单击**创建服务器组**。
3. 完成以下配置，然后单击**创建**。

| 配置                                                     | 说明                                                         |
| :------------------------------------------------------- | :----------------------------------------------------------- |
| **服务器组名称**                                         | 输入服务器组名称。长度为2~128个字符，必须以大小写字母或中文开头，可包含数字、英文句点（.）、下划线（_）和短划线（-）。 |
| **VPC**                                                  | 从VPC下拉列表中选择一个VPC。只有该VPC下的服务器可以加入到该服务器组。 |
| **选择后端协议**                                         | 选择一种后端协议：<br />**HTTP**（默认）：关联HTTPS、HTTP和QUIC监听。<br />**HTTPS**：关联HTTPS监听。 |
| **选择调度算法**                                         | 选择一种调度算法：<br />**加权轮询**：权重值越高的后端服务器，被轮询到的次数（概率）也越高。<br />**源IP一致性哈希**：相同的源地址会调度到相同的后端服务器。 |
| **开启会话保持**                                         | 开启或关闭会话保持。开启会话保持功能后，负载均衡会把来自同一客户端的访问请求分发到同一台后端服务器上进行处理。 |
| **Cookie处理方式**                                       | 选择一种Cookie处理方式：<br />**植入Cookie**：客户端第一次访问时，负载均衡会在返回请求中植入Cookie（即在HTTP或HTTPS响应报文中插入SERVERID），下次客户端携带此Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器上。<br />**重写Cookie**：负载均衡发现用户自定义了Cookie，将会对原来的Cookie进行重写，下次客户端携带新的Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器。 |
| **会话保持超时时间**                                     | 输入会话保持的超时时间，取值范围为1~86400秒。                |
| **配置健康检查**                                         | 开启或关闭健康检查。                                         |
| 高级配置                                                 |                                                              |
| **选择并加载健康检查**                                   | 选择并加载一个健康检查。**说明** 您可以创建健康检查，不与服务器组及监听关联，方便下次复用。 |
| **健康检查协议**                                         | 选择健康检查协议类型：**HTTP**：通过发送HEAD/GET请求模拟浏览器的访问行为来检查服务器应用是否健康。**TCP**：通过发送SYN握手报文来检测服务器端口是否存活。 |
| **健康检查方法**                                         | 选择一种健康检查方法：HEAD或GET。**HEAD**：HTTP监听健康检查默认采用HEAD方法。请确保您的后端服务器支持HEAD请求。如果您的后端应用服务器不支持HEAD方法或HEAD方法被禁用，则可能会出现健康检查失败，此时可以使用GET方法来进行健康检查。**GET**：如果响应报文长度超过8K，会被截断，但不会影响健康检查结果的判定。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查协议版本**                                     | 选择一个HTTP协议版本：**HTTP1.0**或**HTTP1.1**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查端口**                                         | 选择健康检查服务访问后端时的探测端口。**后端服务器组端口**：默认使用后端服务器的端口进行健康检查。**指定特定端口**：指定一个特定的端口进行健康检查。取值范围为1~65535。 |
| **健康检查路径**                                         | 输入健康检查页面的URL。长度限制为1~80个字符，支持使用字母、数字和短划线（-）、正斜线（/）、英文句点（.）、百分号（%）、问号（?）、井号（#）和and（&）以及扩展字符集`_;~!（)*[]@$^:',+`。URL必须以正斜线（/）开头。 |
| **健康检查域名**                                         | 输入健康检查的域名。**使用后端服务器的内网IP**（默认）：使用后端服务器的内网IP地址作为健康检查的域名。**指定特定域名**：输入一个域名。长度为1~80个字符，只能使用小写字母、数字、英文句点（.）和短划线（-）。域名中至少包含一个英文句点（.）。英文句点（.）不能出现在开头或结尾。 |
| **健康状态返回码**                                       | 选择健康检查正常的HTTP状态码：**http_2xx**（默认）、 **http_3xx**、**http_4xx**或**http_5xx**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **响应超时时间**                                         | 输入接收来自运行状况检查的响应需要等待的时间。如果后端ECS在指定的时间内没有正确响应，则判定为健康检查失败。取值范围是1~300秒，默认为5秒。 |
| **间隔时间**                                             | 输入进行健康检查的时间间隔。取值范围1~50秒，默认为2秒。      |
| **健康阈值**                                             | 健康检查连续成功多少次后，将后端服务器的健康检查状态由失败判定为成功的次数。可选值2~10，默认为3次。 |
| **不健康阈值**                                           | 健康检查连续失败多少次后，将后端服务器的健康检查状态由成功判定为失败的次数。可选值 2~10，默认为2次。 |
| **将新的配置保存为健康检查模板，方便下次快速复制使用。** | 选择将新的配置保存为健康检查模板。                           |

#### 添加后端服务器

1. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。

2. 在**服务器组**页面，单击刚创建的服务器组**操作**列下的**编辑后端服务器**。

3. 单击**后端服务器**页签下的**添加后端服务器**。

4. 在**我的服务器**面板，选择后端服务器类型，选中目标服务器，然后单击**下一步**。

5. 在**配置端口和权重**面板，指定添加的服务器的端口和权重，然后单击**添加**。

   权重默认为100，权重越高的服务器将被分配到更多的访问请求。如开启会话保持，可能会造成后端服务器的请求不均匀。

### 实例

#### 创建实例

### 监听

#### 创建监听

1. 在**实例**页面，单击目标实例**操作**列下的**创建监听**。
2. 在**配置监听**配置向导，完成以下配置，然后单击**下一步**。

| 监听配置             | 说明                                                         |
| :------------------- | :----------------------------------------------------------- |
| **选择负载均衡协议** | 选择监听的协议类型。本示例选择**HTTPS**。                    |
| **监听端口**         | 输入用来接收请求并向后端服务器进行请求转发的监听端口，本示例输入**443**。通常HTTP协议使用80端口，HTTPS协议使用443端口。端口范围为1~65535。**说明** 在同一个负载均衡实例内，监听端口不可重复。 |
| **监听名称**         | 输入监听名称。长度为2~256个字符，必须是中文和以下字符串中的字符：`/^([^\x00-\xff]|[\w.,;/@-]){2,256}$/`。 |
| **高级配置**         | 单击**修改**展开高级配置。                                   |
| **启用HTTP 2.0**     | 选择是否开启HTTP 2.0。                                       |
| **连接空闲超时时间** | 指定连接空闲超时时间，取值范围为1~60秒。在超时时间内一直没有访问请求，负载均衡会暂时中断当前连接，直到下一次请求来临时重新建立新的连接。**说明** 该功能对使用HTTP 2.0的请求暂不生效。 |
| **连接请求超时时间** | 指定请求超时时间，取值范围为1~180秒。在超时时间内后端服务器一直没有响应，负载均衡将放弃等待，给客户端返回HTTP 504错误码。 |
| **Gzip数据压缩**     | 开启该配置对特定文件类型进行压缩。目前Gzip支持压缩的类型包括：`text/xml`、`text/plain`、`text/css`、`application/javascript`、`application/x-javascript`、`application/rss+xml`、`application/atom+xml`、`application/xml`和`application/json`。 |
| **附加HTTP头字段**   | 选择您要添加的自定义HTTP header字段：<br />添加`X-Forwarded-For`头字段获取来访者真实IP。<br />添加`SLB-ID`头字段获取负载均衡实例的ID。<br />添加`X-Forwarded-Proto`头字段获取实例的监听协议。<br />添加`X-Forwarded-Clientcert-subjectdn`头字段获取访问负载均衡实例客户端证书的所有者信息。<br />添加`X-Forwarded-Clientcert-issuerdn`头字段获取访问负载均衡实例客户端证书的所发行者信息。<br />添加`X-Forwarded-Clientcert-fingerprint`头字段获取访问负载均衡实例客户端证书的指纹取值。<br />添加`X-Forwarded-Clientcert-clientverify`头字段获取访问负载均衡实例客户端证书的校验结果。<br />添加`X-Forwarded-Port`头字段获取实例的监听端口。<br />添加`X-Forwarded-Client-Port`头字段获取访问负载均衡实例客户端的端口。 |
| **开启QUIC升级**     | 选择是否开启QUIC升级，如果开启QUIC升级，请选择一个关联的QUIC监听。 |

#### 配置SSL证书

#### 选择服务器组

### 安全管理

#### 访问控制

| 配置                   | 说明                                                         |
| :--------------------- | :----------------------------------------------------------- |
| **访问控制方式**       | 选择一种访问控制方式：**白名单**：仅转发来自所选访问控制策略组中设置的IP地址或地址段的请求。**黑名单**：来自所选访问控制策略组中设置的IP地址或地址段的所有请求都不会转发。 |
| **选择访问控制策略组** | 选择一个访问控制策略组。                                     |

#### 健康检查

| 健康检查配置             | 说明                                                         |
| :----------------------- | :----------------------------------------------------------- |
| **名称**                 | 输入健康检查名称。长度为2~128个英文或中文字符，必须以大小字母或中文开头，可包含数字、英文句点（.）、下划线（_）和短划线（-）。 |
| **健康检查协议**         | 选择健康检查协议类型。<br />**HTTP**：通过发送HEAD或GET请求模拟浏览器的访问行为来检查服务器应用是否健康。<br />**TCP**：通过发送SYN握手报文来检测服务器端口是否存活。 |
| **健康检查方法**         | 选择一种健康检查方法：HEAD或GET。<br />**HEAD**：HTTP监听健康检查默认采用HEAD方法。请确保您的后端服务器支持HEAD请求。如果您的后端应用服务器不支持HEAD方法或HEAD方法被禁用，则可能会出现健康检查失败，此时可以使用GET方法来进行健康检查。<br />**GET**：如果响应报文长度超过8K，会被截断，但不会影响健康检查结果的判定。 |
| **健康检查HTTP协议版本** | 选择一个HTTP协议版本：**HTTP1.0**或**HTTP1.1**。             |
| **端口**                 | 选择健康检查服务访问后端时的探测端口。<br />**后端服务器组端口**：默认使用后端服务器的端口进行健康检查。<br />**指定特定端口**：指定一个特定的端口进行健康检查。取值范围为1~65535。 |
| **路径**                 | 输入健康检查页面的URL，建议对静态页面进行检查。长度限制为1~80个字符，支持使用字母、数字和短划线（-）、正斜线（/）、英文句点（.）、百分号（%）、问号（?）、井号（#）和and（&）以及扩展字符集`_;~!（)*[]@$^:',+`。URL必须以正斜线（/）开头。HTTP健康检查默认由负载均衡系统通过后端ECS内网IP地址向该服务器应用配置的缺省首页发起HTTP Head请求。如果您用来进行健康检查的页面并不是应用服务器的缺省首页，需要指定具体的检查路径。 |
| **域名**（可选）         | 输入健康检查的域名。**使用后端服务器的内网IP**（默认）：使用后端服务器的内网IP地址作为健康检查的域名。**指定特定域名**：输入一个域名。长度为1~80个字符，只能使用小写字母、数字、英文句点（.）和短划线（-）。域名中至少包含一个英文句点（.）。英文句点（.）不能出现在开头或结尾。 |
| **正常状态码**           | 选择健康检查正常的HTTP状态码：**http_2xx**（默认）、 **http_3xx**、**http_4xx**或**http_5xx**。 |
| **健康检查响应超时时间** | 接收来自运行状况检查的响应需要等待的时间。如果后端ECS在指定的时间内没有正确响应，则判定为健康检查失败。范围是1~300秒，默认值为5秒。 |
| **健康检查间隔时间**     | 输入进行健康检查的时间间隔。取值范围1~50秒，默认值为2秒。    |
| **健康检查健康阈值**     | 健康检查连续成功多少次后，将后端服务器的健康检查状态由失败判定为成功的次数。取值范围2~10，默认为3次。 |
| **健康检查不健康阈值**   | 健康检查连续失败多少次后，将后端服务器的健康检查状态由成功判定为失败的次数。取值范围 2~10，默认为3次。 |

### 设置CNAME解析

ALB对外提供域名，只支持CNAME域名解析。

操作:

选择要进行域名解析的ALB实例，复制其对应的DNS名称。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210413155929.png" alt="image-20210413155922961" style="zoom:67%;" />

| 配置         | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| **记录类型** | 在下拉列表中选择CNAME。                                      |
| **主机记录** | 您的域名的前缀。                                             |
| **解析线路** | 选择默认。                                                   |
| **记录值**   | 输入加速域名对应的CNAME地址，即您复制的ALB实例的DNS名称。    |
| **TTL**      | 全称Time To Live，表示DNS记录在DNS服务器上缓存时间，本文使用默认值。 |

