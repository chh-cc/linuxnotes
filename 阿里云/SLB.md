# 负载均衡

随着**应用型负载均衡ALB（Application Load Balancer）**的引入，原**负载均衡SLB（Server Load Balancer）**现称为**传统型负载均衡CLB（Classic Load Balancer）**

SLB的

SLB不会自动将不健康的后端服务器移出SLB，只是不会分发请求给不健康的实例

负载均衡服务监听规定了如何将请求转发给后端服务器。一个负载均衡实例至少添加一个监听。

后端多台云服务器ECS实例配置的权重都一样，但是实际上ECS实例负载却不一样。可能是开启了会话保持功能(（ 4层通过源IP、 7层通过cookie），会造成负载不一样;长连接应用， 新增后端服务器后， 由于客户端不主动断开连接， 因此已有连接会继续维持在原有服务器上  

更改SLB设置是不会更改ip的

某些特殊应用场景下需要关闭健康检查,七层服务(HTTP和HTTPS监听)可以关闭健康检查，四层服务(UDP和TCP监听)无法关闭健康检查

主备服务器组只支持四层监听（TCP和UDP协议）。

负载均衡SLB实例可以通过配置不同的healthcheck路径（站点URL）来实现对同一台ECS实例上不同站点的健康检查。

7层服务可以通过HttpHeader:X-Forwarded-For获取来访者真实IP，并保证配置负载均衡SLB监听时开启“获取真实访问IP”，4层服务可以直接获取，无需额外配置

SLB怎么实现HTTP到跳转HTTPS？  

```text
1. 创建一个80端口的监听， 协议使用TCP/HTTP均可（ 如果不需要域名URL转发建议使用TCP监听， 性能更优）
2. 创建一个443端口的HTTPS协议的监听
3. 在后端服务器上配置跳转规则， 将80端口的访问进行重定向， 重定向至HTTPS监听即可
```

为什么没有业务的时候也有很多IP在频繁访问后端服务器， 会占用很多服务器的资源吗？  

```text
这些访问是LVS集群发起的4层健康检查
可能的网段有100.64.0.0/10， 10.158.0.0/16， 10.159.0.0/16和10.49.0.0/16。
该健康检查访问并不会实例建立链接， 只是探测端口的存活与否， 因此对后端服务器资源的消耗是非常有限的
```

负载均衡如何使用能充分利用其高可用性 ？  

```text
1. 用好健康检查， 做好应用级别的容灾
2. 保证每个SLB实例后端都挂在不同可用区的ECS
3. 针对重要业务在不同可用区分别购买实例， 使用GSLB（ 云解析DNS） 进行SLB实例级别的调度和负载均衡
```

健康检查的原理？  

```text
1. TCP健康检查通过发送SYN报文探测目标端口是否存活， 收到后端服务器返回的SYN ACK后即认为服务健康， 同时
主动发起RST终止TCP握手过程
2. HTTP健康检查使用HEAD方法请求目标URL， 当服务器返回预期中的返回码（ 2xx,3xx,4xx,5xx） 后即认为服务健康
3. UDP健康检查是SLB定期给后端端口发送UDP探测报文给后端服务器， 后端服务器如果正常则不会返回任何消息，
如果服务不正常则回应ICMP不可达报文
```

## CLB

CLB通过设置虚拟服务地址，将添加的同一地域的多台ECS实例虚拟成一个高性能和高可用的后端服务池，并根据转发规则，将来自客户端的请求分发给后端服务器池中的ECS实例。

CLB**默认检查**云服务器池中的ECS实例的健康状态，**自动隔离**异常状态的ECS实例

四层负载均衡通过**LVS（Linux Virtual Server）+ keepalived**的方式实现

七层负载均衡通过**Tengine**（淘宝网发起的Web服务器项目，在Nginx的基础上，针对有大访问量的网站需求进行了优化）实现

负载均衡基础架构是采用集群部署,只有当主可用区整体不可用时，如机房整体断电或者机房出口光缆中断等，负载均衡才会切换到备可用区

TCP/UDP协议和HTTP/HTTPS协议的流量**都需要经过LVS集群**进行转发:

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210415221546.png)

### 实例

把鼠标移至性能保障型实例的问号图标，可查看具体的性能指标:

- 最大连接数-Max Connection

  最大连接数定义了一个负载均衡实例能够承载的最大连接数量。当实例上的连接超过规格定义的最大连接数时，新建连接请求将被丢弃。

- 每秒新建连接数-Connection Per Second（CPS）

  每秒新建连接数定义了新建连接的速率。当新建连接的速率超过规格定义的每秒新建连接数时，新建连接请求将被丢弃。

- 每秒查询数-Query Per Second（QPS）

  每秒请求数是七层监听特有的概念，指的是每秒可以完成的HTTP或HTTPS的查询（请求）的数量。当请求速率超过规格所定义的每秒查询数时，新建连接请求将被丢弃。

### 监听

创建完实例后,要为实例配置监听

- 四层监听将请求**直接转发给后端服务器，不会修改报头**。客户端请求到达负载均衡监听后，负载均衡服务器会使用监听中配置的后端端口与后端服务器建立TCP连接。

- 七层监听原理上是反向代理的一种实现。客户端请求到达负载均衡监听后，负载均衡服务器会通过与后端服务器建立TCP连接，即**再次通过新TCP连接HTTP协议访问后端**，而不是直接转发报文到后端ECS。

  由于七层监听比四层监听在底层实现上多了一个Tengine处理环节，因此，七层监听性能没有四层好。此外，客户端端口不足、后端服务器连接过多等场景也可能导致七层服务性能不高，如果您对性能有很高的要求，建议您使用四层监听。

- 可根据应用场景选择监听协议：tcp udp http https

支持监听转发,前提是配置http监听

单个连接下载的流量上限计算方法为：单个连接下载峰值=设置的负载均衡总带宽/(N-1)。N为流量转发分组个数，当前值固定为4。例如您在控制台上设置的是10Mb带宽上限，那么单个客户端可下载的最大流量为10/(4-1)=3.33Mb。

### 后端服务器

- 确保ECS实例的地域和负载均衡实例的地域相同。此外，建议您将ECS部署在不同的可用区内，提高可用性
- 可以**在任意时刻增加或减少**负载均衡的后端ECS实例数量并且支持不同ECS实例之间的切换
- 后端服务器是**可以不同操作系统**
- 在ECS上部署好应用后，不需要再进行特别的配置。但如果您要配置一个四层监听（TCP协议或UDP协议），并且ECS使用的是Linux系统，确保ECS实例上/etc/sysctl.conf目录下net.ipv4.conf文件中的以下三个参数的值为零：

```
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```

#### 默认服务器组

用来接收前端请求的ECS实例。如果监听没有设置虚拟服务器组或主备服务器组，默认将请求转发至默认服务器组中的ECS。

在使用负载均衡服务前，必须至少添加一台默认服务器接收负载均衡转发的客户端请求。

#### 虚拟服务器组

虚拟服务器组 （VServer group）是一组 ECS 实例。将虚拟服务器组和一个监听关联后，监听只会将流量转发给关联的虚拟服务器组的后端服务器，不会再将流量转发给其他后端服务器。

一个ECS实例可以属于多个虚拟服务器组

一个虚拟服务器组可绑定在一个实例的多个监听上

#### 主备服务器组

一个主备服务器组只包括两台ECS实例，一台作为主服务器，一台作为备服务器。由于备服务器不会做健康检查，所以**只要主服务器健康检查失败**，系统会直接将流量切到备机。当主服务器健康检查成功恢复服务后，流量会自动切到主服务器。

### 健康检查

负载均衡健康检查使用的地址段是100.64.0.0/10，后端服务器务必不能屏蔽该地址段

只可能关闭HTTP和HTTPS监听的健康检查，不能关闭TCP和UDP监听的健康检查

TCP健康检查方式对服务器的性能资源**消耗相对要少**一些。如果您对后端服务器的负载高度敏感，则选择TCP健康检查；如果负载不是很高，则选择HTTP健康检查。

#### HTTP/HTTPS监听健康检查机制

健康检查通过HTTP HEAD探测来获取状态信息

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210719165345.png)

1. Tengine节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】+【检查路径】发送**HTTP HEAD或GET请求**（包含设置的【域名】），模拟浏览器的访问行为来检查服务器应用是否健康。
2. 后端ECS收到请求后，根据相应服务的运行情况，返回HTTP状态码。

如果后端ECS实例的服务关闭HEAD方法，会导致健康检查失败。建议在ECS实例上用HEAD方法访问自已IP地址进行测试：

```
curl -v -0 -I -H "Host:" -X HEAD http://IP:port
```

#### TCP监听健康检查机制

1. LVS节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】发送TCP **SYN数据包**检测服务器端口是否存活。
2. 后端ECS收到请求后，如果相应端口正在正常监听，则会返回SYN+ACK数据包。

#### 配置健康检查

2. 单击**监听**页签。

3. 单击**添加监听**或目标监听**操作**列的**修改监听配置**。

4. 单击**下一步**至**健康检查**页签，配置健康检查。

   在配置健康检查时，建议您使用默认值。

TCP/HTTP/HTTPS监听建议使用的健康检查配置：

| 配置             | 推荐值 |
| :--------------- | :----- |
| **响应超时时间** | 5秒    |
| **健康检查间隔** | 2秒    |
| **不健康阈值**   | 3      |

#### 健康检查探测

### 证书管理

#### 部署https业务(单向认证)

1. 购买服务器证书并上传到负载均衡的证书管理系统,上传后无需在后端ecs上进行其他证书配置,上传的证书必须是PEM格式
2. 配置负载均衡实例

- 在**监听**页签下，单击**添加监听**。
- 在**协议&监听**页签下，完成如下配置。
  - **选择负载均衡协议**：HTTPS。
  - **监听端口**：443。
  - **调度算法**：轮询（RR）。
- 单击**下一步**，在**SSL证书**页签下，选择已经上传的服务器证书和TLS安全策略。
- 单击**下一步**，选择**默认服务器组**，单击**继续添加**，添加ECS服务器，后端协议监听端口设置为80。

### 实践

#### 单SLB实例配置多域名https网站

场景：将来自域名为*.example1.com的前端请求转发至虚拟服务器组test1上，将来自域名为www.example2.com的前端请求转发至虚拟服务器组test2上。

前提：创建负载均衡实例并上传所需证书

操作：

1. 添加https监听
2. 配置转发规则

- 找到已创建的HTTPS监听，单击***\*配置转发策略\****。
- 配置域名转发规则，URL不进行设置
  - 设置规则名称，在**域名**操作列输入*.example1.com，选择test1虚拟服务器组，单击**添加转发策略**。
  - 设置规则名称，在**域名**操作列输入www.example2.com，选择test2虚拟服务器组，单击**添加转发策略**。

3. 添加扩展域名

<<<<<<< HEAD
#### 将http访问重定向到https

前提:已创建https监听

操作:

1. 在**监听**页签下，单击**添加监听**。
2. 在**协议&监听**页签下，负载均衡协议选择**HTTP**， 监听端口输入**80**。
3. 单击**高级配置**后的**修改**。
4. 开启**监听转发**，选择目的监听为**HTTPS:443**。

#### 相同域名不同路径的流量转发

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210415145254.png" alt="img" style="zoom:67%;" />

### 压力测试

四层监听经过LVS后直接到达后端服务器，而七层监听经过LVS后，还需要再经过Tengine，最后到达后端服务器。七层监听比四层监听多了一个处理环节，因此，七层性能没有四层性能好。

以下情况也可能会造成七层压测性能低：

- 客户端端口不足 。

  在进行压力测试时，客户端端口不足会导致建立连接失败。负载均衡会默认抹除TCP连接的timestamp属性，Linux协议栈的tw_reuse（time_wait 状态连接复用）无法生效，time_wait状态连接堆积导致客户端端口不足。

  解决方法：客户端使用长连接代替短连接。使用RST报文断开连接，即socket设置SO_LINGER属性。

- 后端服务器accept队列满 。

  后端服务器accept队列满，导致后端服务器不回复syn_ack报文，客户端超时。

  解决方法：默认net.core.somaxconn的值为128，执行`sysctl -w net.core.somaxconn=1024`命令更改net.core.somaxconn的值，并重启后端服务器上的应用。

- 后端服务器连接过多。

  由于架构设计的原因，使用七层负载均衡时，用户长连接经过Tengine后变成短连接，可能导致后端服务器连接过多，从而表现为压测性能低。

- 后端服务器依赖的应用成为瓶颈。

  请求经过负载均衡到达后端服务器后，后端服务器本身负载正常，但由于所有的后端服务器上的应用又依赖其它应用，例如数据库，当数据库成为瓶颈时，也会引起性能降低。

- 后端服务器的健康检查状态异常。

  在压测时，容易忽略后端服务器的健康检查状态，如果有后端服务器健康检查失败或者健康检查状态经常跳跃（好到坏，又从坏到好，反复变化），也会导致压测性能低。

压测建议:

- 压测负载均衡转发能力建议使用短连接 。

  一般来说压测除了验证会话保持和均衡性等功能外，主要想验证负载均衡的转发能力，因此使用短连接比较合适，用于测试负载均衡和后端服务器的处理能力。使用短连接测试时，需要注意客户端端口不足的问题。

- 压测负载均衡吞吐量建议使用长连接，用于测试带宽上限或特殊业务。

  压测工具的超时时间建议设置为一个较小值，如5秒。超时时间太大的话，测试结果会体现在平均响应时间加长，不利于判断压测水位是否已到达。超时时间调小，测试结果会体现在成功率上，便于快速判断压测水位。

- 后端服务器提供一个静态网页用于压测，以避免应用逻辑带来的损耗。

- 压测时，监听配置建议如下：

  - 不开启会话保持功能，否则压力会集中在个别后端服务器。
  - 关闭健康检查功能，减少健康检查对后端服务器的访问请求。
  - 性能测试服务的5000并发规格能够提供5个及5个以上的公网IP。

不建议您使用Apache ab作为压力测试工具。

Apache ab在大量并发场景下存在3s、6s、9s阶梯式停顿的现象。Apache ab会通过判断content length来确定请求是否成功，而负载均衡挂载多台后端服务器时，返回的content length会不一致，导致测试结果有误。

建议使用阿里云[PTS](https://pts.aliyun.com/)。

可以设置足够高的并发，PTS会分配来自全国各地的公网IP，压力来源足够分散，并且可以在PTS中集成云监控，实时查看端到端的全部性能数据。
=======
#### 将http重定向到https

前提：已经创建https监听

操作：

1. 在**协议&监听**页签下，负载均衡协议选择**HTTP**， 监听端口输入**80**。
2. 单击**高级配置**后的**修改**。
3. 开启**监听转发**，选择目的监听为**HTTPS:443**。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210415212616.png" alt="img" style="zoom:67%;" />

#### 相同域名不同路径的流量转发

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210415215424.png" alt="img" style="zoom:67%;" />
>>>>>>> 85a892c984ed3ec2b6bcc71fe1dbaedd7466d5c6

## ALB

专门面向七层，提供超强的业务处理性能，例如HTTPS卸载能力。单实例每秒查询数QPS（Query Per Second）可达100万次。

### 服务器组

#### 创建服务器组

1. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。
2. 在**服务器组**页面，单击**创建服务器组**。
3. 完成以下配置，然后单击**创建**。

| 配置                                                     | 说明                                                         |
| :------------------------------------------------------- | :----------------------------------------------------------- |
| **服务器组名称**                                         | 输入服务器组名称。长度为2~128个字符，必须以大小写字母或中文开头，可包含数字、英文句点（.）、下划线（_）和短划线（-）。 |
| **VPC**                                                  | 从VPC下拉列表中选择一个VPC。只有该VPC下的服务器可以加入到该服务器组。 |
| **选择后端协议**                                         | 选择一种后端协议：<br />**HTTP**（默认）：关联HTTPS、HTTP和QUIC监听。<br />**HTTPS**：关联HTTPS监听。 |
| **选择调度算法**                                         | 选择一种调度算法：<br />**加权轮询**：权重值越高的后端服务器，被轮询到的次数（概率）也越高。<br />**源IP一致性哈希**：相同的源地址会调度到相同的后端服务器。 |
| **开启会话保持**                                         | 开启或关闭会话保持。开启会话保持功能后，负载均衡会把来自同一客户端的访问请求分发到同一台后端服务器上进行处理。 |
| **Cookie处理方式**                                       | 选择一种Cookie处理方式：<br />**植入Cookie**：客户端第一次访问时，负载均衡会在返回请求中植入Cookie（即在HTTP或HTTPS响应报文中插入SERVERID），下次客户端携带此Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器上。<br />**重写Cookie**：负载均衡发现用户自定义了Cookie，将会对原来的Cookie进行重写，下次客户端携带新的Cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器。 |
| **会话保持超时时间**                                     | 输入会话保持的超时时间，取值范围为1~86400秒。                |
| **配置健康检查**                                         | 开启或关闭健康检查。                                         |
| 高级配置                                                 |                                                              |
| **选择并加载健康检查**                                   | 选择并加载一个健康检查。**说明** 您可以创建健康检查，不与服务器组及监听关联，方便下次复用。 |
| **健康检查协议**                                         | 选择健康检查协议类型：**HTTP**：通过发送HEAD/GET请求模拟浏览器的访问行为来检查服务器应用是否健康。**TCP**：通过发送SYN握手报文来检测服务器端口是否存活。 |
| **健康检查方法**                                         | 选择一种健康检查方法：HEAD或GET。**HEAD**：HTTP监听健康检查默认采用HEAD方法。请确保您的后端服务器支持HEAD请求。如果您的后端应用服务器不支持HEAD方法或HEAD方法被禁用，则可能会出现健康检查失败，此时可以使用GET方法来进行健康检查。**GET**：如果响应报文长度超过8K，会被截断，但不会影响健康检查结果的判定。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查协议版本**                                     | 选择一个HTTP协议版本：**HTTP1.0**或**HTTP1.1**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **健康检查端口**                                         | 选择健康检查服务访问后端时的探测端口。**后端服务器组端口**：默认使用后端服务器的端口进行健康检查。**指定特定端口**：指定一个特定的端口进行健康检查。取值范围为1~65535。 |
| **健康检查路径**                                         | 输入健康检查页面的URL。长度限制为1~80个字符，支持使用字母、数字和短划线（-）、正斜线（/）、英文句点（.）、百分号（%）、问号（?）、井号（#）和and（&）以及扩展字符集`_;~!（)*[]@$^:',+`。URL必须以正斜线（/）开头。 |
| **健康检查域名**                                         | 输入健康检查的域名。**使用后端服务器的内网IP**（默认）：使用后端服务器的内网IP地址作为健康检查的域名。**指定特定域名**：输入一个域名。长度为1~80个字符，只能使用小写字母、数字、英文句点（.）和短划线（-）。域名中至少包含一个英文句点（.）。英文句点（.）不能出现在开头或结尾。 |
| **健康状态返回码**                                       | 选择健康检查正常的HTTP状态码：**http_2xx**（默认）、 **http_3xx**、**http_4xx**或**http_5xx**。**说明** 此参数仅在健康检查协议为**HTTP协议**时生效。 |
| **响应超时时间**                                         | 输入接收来自运行状况检查的响应需要等待的时间。如果后端ECS在指定的时间内没有正确响应，则判定为健康检查失败。取值范围是1~300秒，默认为5秒。 |
| **间隔时间**                                             | 输入进行健康检查的时间间隔。取值范围1~50秒，默认为2秒。      |
| **健康阈值**                                             | 健康检查连续成功多少次后，将后端服务器的健康检查状态由失败判定为成功的次数。可选值2~10，默认为3次。 |
| **不健康阈值**                                           | 健康检查连续失败多少次后，将后端服务器的健康检查状态由成功判定为失败的次数。可选值 2~10，默认为2次。 |
| **将新的配置保存为健康检查模板，方便下次快速复制使用。** | 选择将新的配置保存为健康检查模板。                           |

#### 添加后端服务器

1. 在左侧导航栏，选择***\*应用型负载均衡ALB\** > \**服务器组\****。

2. 在**服务器组**页面，单击刚创建的服务器组**操作**列下的**编辑后端服务器**。

3. 单击**后端服务器**页签下的**添加后端服务器**。

4. 在**我的服务器**面板，选择后端服务器类型，选中目标服务器，然后单击**下一步**。

5. 在**配置端口和权重**面板，指定添加的服务器的端口和权重，然后单击**添加**。

   权重默认为100，权重越高的服务器将被分配到更多的访问请求。如开启会话保持，可能会造成后端服务器的请求不均匀。

### 实例

#### 创建实例

### 监听

#### 创建监听

1. 在**实例**页面，单击目标实例**操作**列下的**创建监听**。
2. 在**配置监听**配置向导，完成以下配置，然后单击**下一步**。

| 监听配置             | 说明                                                         |
| :------------------- | :----------------------------------------------------------- |
| **选择负载均衡协议** | 选择监听的协议类型。本示例选择**HTTPS**。                    |
| **监听端口**         | 输入用来接收请求并向后端服务器进行请求转发的监听端口，本示例输入**443**。通常HTTP协议使用80端口，HTTPS协议使用443端口。端口范围为1~65535。**说明** 在同一个负载均衡实例内，监听端口不可重复。 |
| **监听名称**         | 输入监听名称。长度为2~256个字符，必须是中文和以下字符串中的字符：`/^([^\x00-\xff]|[\w.,;/@-]){2,256}$/`。 |
| **高级配置**         | 单击**修改**展开高级配置。                                   |
| **启用HTTP 2.0**     | 选择是否开启HTTP 2.0。                                       |
| **连接空闲超时时间** | 指定连接空闲超时时间，取值范围为1~60秒。在超时时间内一直没有访问请求，负载均衡会暂时中断当前连接，直到下一次请求来临时重新建立新的连接。**说明** 该功能对使用HTTP 2.0的请求暂不生效。 |
| **连接请求超时时间** | 指定请求超时时间，取值范围为1~180秒。在超时时间内后端服务器一直没有响应，负载均衡将放弃等待，给客户端返回HTTP 504错误码。 |
| **Gzip数据压缩**     | 开启该配置对特定文件类型进行压缩。目前Gzip支持压缩的类型包括：`text/xml`、`text/plain`、`text/css`、`application/javascript`、`application/x-javascript`、`application/rss+xml`、`application/atom+xml`、`application/xml`和`application/json`。 |
| **附加HTTP头字段**   | 选择您要添加的自定义HTTP header字段：<br />添加`X-Forwarded-For`头字段获取来访者真实IP。<br />添加`SLB-ID`头字段获取负载均衡实例的ID。<br />添加`X-Forwarded-Proto`头字段获取实例的监听协议。<br />添加`X-Forwarded-Clientcert-subjectdn`头字段获取访问负载均衡实例客户端证书的所有者信息。<br />添加`X-Forwarded-Clientcert-issuerdn`头字段获取访问负载均衡实例客户端证书的所发行者信息。<br />添加`X-Forwarded-Clientcert-fingerprint`头字段获取访问负载均衡实例客户端证书的指纹取值。<br />添加`X-Forwarded-Clientcert-clientverify`头字段获取访问负载均衡实例客户端证书的校验结果。<br />添加`X-Forwarded-Port`头字段获取实例的监听端口。<br />添加`X-Forwarded-Client-Port`头字段获取访问负载均衡实例客户端的端口。 |
| **开启QUIC升级**     | 选择是否开启QUIC升级，如果开启QUIC升级，请选择一个关联的QUIC监听。 |

#### 配置SSL证书

#### 选择服务器组

### 安全管理

#### 访问控制

| 配置                   | 说明                                                         |
| :--------------------- | :----------------------------------------------------------- |
| **访问控制方式**       | 选择一种访问控制方式：**白名单**：仅转发来自所选访问控制策略组中设置的IP地址或地址段的请求。**黑名单**：来自所选访问控制策略组中设置的IP地址或地址段的所有请求都不会转发。 |
| **选择访问控制策略组** | 选择一个访问控制策略组。                                     |

#### 健康检查

| 健康检查配置             | 说明                                                         |
| :----------------------- | :----------------------------------------------------------- |
| **名称**                 | 输入健康检查名称。长度为2~128个英文或中文字符，必须以大小字母或中文开头，可包含数字、英文句点（.）、下划线（_）和短划线（-）。 |
| **健康检查协议**         | 选择健康检查协议类型。<br />**HTTP**：通过发送HEAD或GET请求模拟浏览器的访问行为来检查服务器应用是否健康。<br />**TCP**：通过发送SYN握手报文来检测服务器端口是否存活。 |
| **健康检查方法**         | 选择一种健康检查方法：HEAD或GET。<br />**HEAD**：HTTP监听健康检查默认采用HEAD方法。请确保您的后端服务器支持HEAD请求。如果您的后端应用服务器不支持HEAD方法或HEAD方法被禁用，则可能会出现健康检查失败，此时可以使用GET方法来进行健康检查。<br />**GET**：如果响应报文长度超过8K，会被截断，但不会影响健康检查结果的判定。 |
| **健康检查HTTP协议版本** | 选择一个HTTP协议版本：**HTTP1.0**或**HTTP1.1**。             |
| **端口**                 | 选择健康检查服务访问后端时的探测端口。<br />**后端服务器组端口**：默认使用后端服务器的端口进行健康检查。<br />**指定特定端口**：指定一个特定的端口进行健康检查。取值范围为1~65535。 |
| **路径**                 | 输入健康检查页面的URL，建议对静态页面进行检查。长度限制为1~80个字符，支持使用字母、数字和短划线（-）、正斜线（/）、英文句点（.）、百分号（%）、问号（?）、井号（#）和and（&）以及扩展字符集`_;~!（)*[]@$^:',+`。URL必须以正斜线（/）开头。HTTP健康检查默认由负载均衡系统通过后端ECS内网IP地址向该服务器应用配置的缺省首页发起HTTP Head请求。如果您用来进行健康检查的页面并不是应用服务器的缺省首页，需要指定具体的检查路径。 |
| **域名**（可选）         | 输入健康检查的域名。**使用后端服务器的内网IP**（默认）：使用后端服务器的内网IP地址作为健康检查的域名。**指定特定域名**：输入一个域名。长度为1~80个字符，只能使用小写字母、数字、英文句点（.）和短划线（-）。域名中至少包含一个英文句点（.）。英文句点（.）不能出现在开头或结尾。 |
| **正常状态码**           | 选择健康检查正常的HTTP状态码：**http_2xx**（默认）、 **http_3xx**、**http_4xx**或**http_5xx**。 |
| **健康检查响应超时时间** | 接收来自运行状况检查的响应需要等待的时间。如果后端ECS在指定的时间内没有正确响应，则判定为健康检查失败。范围是1~300秒，默认值为5秒。 |
| **健康检查间隔时间**     | 输入进行健康检查的时间间隔。取值范围1~50秒，默认值为2秒。    |
| **健康检查健康阈值**     | 健康检查连续成功多少次后，将后端服务器的健康检查状态由失败判定为成功的次数。取值范围2~10，默认为3次。 |
| **健康检查不健康阈值**   | 健康检查连续失败多少次后，将后端服务器的健康检查状态由成功判定为失败的次数。取值范围 2~10，默认为3次。 |

### 设置CNAME解析

ALB对外提供域名，只支持CNAME域名解析。

操作:

选择要进行域名解析的ALB实例，复制其对应的DNS名称。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210413155929.png" alt="image-20210413155922961" style="zoom:67%;" />

| 配置         | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| **记录类型** | 在下拉列表中选择CNAME。                                      |
| **主机记录** | 您的域名的前缀。                                             |
| **解析线路** | 选择默认。                                                   |
| **记录值**   | 输入加速域名对应的CNAME地址，即您复制的ALB实例的DNS名称。    |
| **TTL**      | 全称Time To Live，表示DNS记录在DNS服务器上缓存时间，本文使用默认值。 |

