# 负载均衡

随着**应用型负载均衡ALB（Application Load Balancer）**的引入，原**负载均衡SLB（Server Load Balancer）**现称为**传统型负载均衡CLB（Classic Load Balancer）**

SLB不会自动将不健康的后端服务器移出SLB，只是不会分发请求给不健康的实例

负载均衡服务监听规定了如何将请求转发给后端服务器。一个负载均衡实例至少添加一个监听。

后端多台云服务器ECS实例配置的权重都一样，但是实际上ECS实例**负载却不一样。可能是开启了会话保持功能**(（ 4层通过源IP、 7层通过cookie），会造成负载不一样;长连接应用， 新增后端服务器后， 由于客户端不主动断开连接， 因此已有连接会继续维持在原有服务器上  

更改SLB设置是不会更改ip的

某些特殊应用场景下需要关闭健康检查,七层服务(HTTP和HTTPS监听)可以关闭健康检查，**四层服务(UDP和TCP监听)无法关闭健康检查**

主备服务器组只支持四层监听（TCP和UDP协议）。

负载均衡SLB实例可以通过配置不同的healthcheck路径（站点URL）来实现对同一台ECS实例上不同站点的健康检查。

7层服务可以通过**HttpHeader:X-Forwarded-For获取来访者真实IP**，并保证配置负载均衡SLB监听时开启“获取真实访问IP”，4层服务可以直接获取，无需额外配置

为什么没有业务的时候也有很多IP在频繁访问后端服务器， 会占用很多服务器的资源吗？  

```text
这些访问是LVS集群发起的4层健康检查
可能的网段有100.64.0.0/10， 10.158.0.0/16， 10.159.0.0/16和10.49.0.0/16。
该健康检查访问并不会实例建立链接， 只是探测端口的存活与否， 因此对后端服务器资源的消耗是非常有限的
```

负载均衡如何使用能充分利用其高可用性 ？  

```text
1. 用好健康检查， 做好应用级别的容灾
2. 保证每个SLB实例后端都挂在不同可用区的ECS
3. 针对重要业务在不同可用区分别购买实例， 使用GSLB（ 云解析DNS） 进行SLB实例级别的调度和负载均衡
```

健康检查的原理？  

```text
1. TCP健康检查通过发送SYN报文探测目标端口是否存活， 收到后端服务器返回的SYN ACK后即认为服务健康， 同时
主动发起RST终止TCP握手过程
2. HTTP健康检查使用HEAD方法请求目标URL， 当服务器返回预期中的返回码（ 2xx,3xx,4xx,5xx） 后即认为服务健康
3. UDP健康检查是SLB定期给后端端口发送UDP探测报文给后端服务器， 后端服务器如果正常则不会返回任何消息，
如果服务不正常则回应ICMP不可达报文
```

## CLB

CLB通过设置虚拟服务地址，将添加的同一地域的多台ECS实例虚拟成一个高性能和高可用的后端服务池，并根据转发规则，将来自客户端的请求分发给后端服务器池中的ECS实例。

CLB**默认检查**云服务器池中的ECS实例的健康状态，**自动隔离**异常状态的ECS实例

四层负载均衡通过**LVS（Linux Virtual Server）+ keepalived**的方式实现

七层负载均衡通过**Tengine**（淘宝网发起的Web服务器项目，在Nginx的基础上，针对有大访问量的网站需求进行了优化）实现

负载均衡基础架构是采用集群部署,只有当主可用区整体不可用时，如机房整体断电或者机房出口光缆中断等，负载均衡才会切换到备可用区

TCP/UDP协议和HTTP/HTTPS协议的流量**都需要经过LVS集群**进行转发:

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210415221546.png)

### 实例

把鼠标移至性能保障型实例的问号图标，可查看具体的性能指标:

![image-20210913223502601](https://gitee.com/c_honghui/picture/raw/master/img/20210913223509.png)

- **最大连接数**-Max Connection

  最大连接数定义了一个负载均衡实例能够承载的最大连接数量。当实例上的连接超过规格定义的最大连接数时，新建连接请求将被丢弃。

- **每秒新建连接数**-Connection Per Second（CPS）

  每秒新建连接数定义了新建连接的速率。当新建连接的速率超过规格定义的每秒新建连接数时，新建连接请求将被丢弃。

- **每秒查询数**-Query Per Second（QPS）

  每秒请求数是**七层监听**特有的概念，指的是**每秒可以完成的HTTP或HTTPS的查询（请求）的数量**。当请求速率超过规格所定义的每秒查询数时，新建连接请求将被丢弃。

### 监听

创建完实例后,要为实例配置监听

- 四层监听将请求**直接转发给后端服务器，不会修改报头**。客户端请求到达负载均衡监听后，负载均衡服务器会使用监听中配置的后端端口**与后端服务器建立TCP连接。**

- 七层监听原理上是反向代理的一种实现。客户端请求到达负载均衡监听后，负载均衡服务器会通过与后端服务器建立TCP连接，即**再次通过新TCP连接HTTP协议访问后端**，而不是直接转发报文到后端ECS。

  由于七层监听比四层监听在底层实现上多了一个Tengine处理环节，因此，**七层监听性能没有四层好**。此外，客户端端口不足、后端服务器连接过多等场景也可能导致七层服务性能不高，如果您对性能有很高的要求，建议您使用四层监听。

- 可根据应用场景选择监听协议：tcp udp http https

**支持监听转发,前提是配置http监听**

单个连接下载的流量上限计算方法为：单个连接下载峰值=设置的负载均衡总带宽/(N-1)。N为流量转发分组个数，当前值固定为4。例如您在控制台上设置的是10Mb带宽上限，那么单个客户端可下载的最大流量为10/(4-1)=3.33Mb。

### 后端服务器

- 确保ECS实例的地域和负载均衡实例的地域相同。此外，建议您将ECS部署在不同的可用区内，提高可用性
- 可以在任意时刻增加或减少负载均衡的后端ECS实例**数量**并且支持不同ECS实例之间的**切换**
- 后端服务器是**可以不同操作系统**
- 在ECS上部署好应用后，不需要再进行特别的配置。但如果您要配置一个四层监听（TCP协议或UDP协议），并且ECS使用的是Linux系统，确保ECS实例上/etc/sysctl.conf文件中的以下三个参数的值为零：

```
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```

#### 默认服务器组

用来接收前端请求的ECS实例。如果监听没有设置虚拟服务器组或主备服务器组，默认将请求转发至默认服务器组中的ECS。

在使用负载均衡服务前，必须至少添加一台默认服务器接收负载均衡转发的客户端请求。

#### 虚拟服务器组

虚拟服务器组 （VServer group）是一组 ECS 实例。将虚拟服务器组和一个监听关联后，监听只会将流量转发给关联的虚拟服务器组的后端服务器，不会再将流量转发给其他后端服务器。

一个ECS实例可以属于多个虚拟服务器组

一个虚拟服务器组可绑定在一个实例的多个监听上

#### 主备服务器组

一个主备服务器组只包括两台ECS实例，一台作为主服务器，一台作为备服务器。由于**备服务器不会做健康检查**，所以只要主服务器健康检查失败，系统会直接将流量切到备机。当主服务器健康检查成功恢复服务后，流量会自动切到主服务器。

### 健康检查

负载均衡健康检查使用的地址段是100.64.0.0/10，后端服务器务必不能屏蔽该地址段

只可能关闭HTTP和HTTPS监听的健康检查，不能关闭TCP和UDP监听的健康检查

**TCP健康检查方式**对服务器的性能资源**消耗相对要少**一些。如果您对后端服务器的负载高度敏感，则选择TCP健康检查；如果负载不是很高，则选择HTTP健康检查。

#### HTTP/HTTPS监听健康检查机制

健康检查通过HTTP HEAD探测来获取状态信息

![img](https://gitee.com/c_honghui/picture/raw/master/img/20210719165345.png)

1. Tengine节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】+【检查路径】发送**HTTP HEAD或GET请求**（包含设置的【域名】），模拟浏览器的访问行为来检查服务器应用是否健康。
2. 后端ECS收到请求后，根据相应服务的运行情况，返回HTTP状态码。

如果后端ECS实例的服务关闭HEAD方法，会导致健康检查失败。建议在ECS实例上用HEAD方法访问自已IP地址进行测试：

```
curl -v -0 -I -H "Host:" -X HEAD http://IP:port
```

#### TCP监听健康检查机制

1. LVS节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】发送TCP **SYN数据包**检测服务器端口是否存活。
2. 后端ECS收到请求后，如果相应端口正在正常监听，则会返回SYN+ACK数据包。

#### 配置健康检查

2. 单击**监听**页签。

3. 单击**添加监听**或目标监听**操作**列的**修改监听配置**。

4. 单击**下一步**至**健康检查**页签，配置健康检查。

   在配置健康检查时，建议您使用默认值。

![image-20210913232527224](https://gitee.com/c_honghui/picture/raw/master/img/20210913232527.png)

TCP/HTTP/HTTPS监听建议使用的健康检查配置：

| 配置             | 推荐值 |
| :--------------- | :----- |
| **响应超时时间** | 5秒    |
| **健康检查间隔** | 2秒    |
| **不健康阈值**   | 3      |

### 访问控制

可以针对不同的监听设置访问白名单或黑名单

### 证书管理

负载均衡只支持**PEM格式**的证书。在上传证书前，确保您的证书、证书链和私钥符合格式要求。

配置HTTPS监听，您可以直接使用SSL证书服务中的证书或者将所需的第三方签发的服务器证书和CA证书上传到负载均衡。上传后，无需在后端服务器再配置证书。

#### 部署https业务(单向认证)

1. 购买服务器证书并上传到负载均衡的证书管理系统,上传后无需在后端ecs上进行其他证书配置,上传的证书必须是PEM格式
2. 配置负载均衡实例

- 在**监听**页签下，单击**添加监听**。
- 在**协议&监听**页签下，完成如下配置。
  - **选择负载均衡协议**：HTTPS。
  - **监听端口**：443。
  - **调度算法**：轮询（RR）。
- 单击**下一步**，在**SSL证书**页签下，选择已经上传的服务器证书和TLS安全策略。
- 单击**下一步**，选择**默认服务器组**，单击**继续添加**，添加ECS服务器，后端协议监听端口设置为80。

### 实践

#### 将http访问重定向到https

前提:已创建https监听

操作:

1. 在**监听**页签下，单击**添加监听**。
2. 在**协议&监听**页签下，负载均衡协议选择**HTTP**（ 如果不需要域名URL转发建议使用TCP监听， 性能更优）， 监听端口输入**80**。
3. 单击**高级配置**后的**修改**。
4. 开启**监听转发**，选择目的监听为**HTTPS:443**。

#### 相同域名不同路径的流量转发

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210415145254.png" alt="img" style="zoom:67%;" />

### 费用

只需为出云方向的带宽付费

当出现资源争抢时，优先保证按带宽计费实例的带宽峰值，按流量计费实例的带宽峰值可能受到限制。

### 压力测试

四层监听经过LVS后直接到达后端服务器，而七层监听经过LVS后，还需要再经过Tengine，最后到达后端服务器。七层监听比四层监听多了一个处理环节，因此，七层性能没有四层性能好。

以下情况也可能会造成七层压测性能低：

- 客户端端口不足 。

  在进行压力测试时，客户端端口不足会导致建立连接失败。负载均衡会默认抹除TCP连接的timestamp属性，Linux协议栈的tw_reuse（time_wait 状态连接复用）无法生效，time_wait状态连接堆积导致客户端端口不足。

  解决方法：客户端使用长连接代替短连接。使用RST报文断开连接，即socket设置SO_LINGER属性。

- 后端服务器accept队列满 。

  后端服务器accept队列满，导致后端服务器不回复syn_ack报文，客户端超时。

  解决方法：默认net.core.somaxconn的值为128，执行`sysctl -w net.core.somaxconn=1024`命令更改net.core.somaxconn的值，并重启后端服务器上的应用。

- 后端服务器连接过多。

  由于架构设计的原因，使用七层负载均衡时，用户长连接经过Tengine后变成短连接，可能导致后端服务器连接过多，从而表现为压测性能低。

- 后端服务器依赖的应用成为瓶颈。

  请求经过负载均衡到达后端服务器后，后端服务器本身负载正常，但由于所有的后端服务器上的应用又依赖其它应用，例如数据库，当数据库成为瓶颈时，也会引起性能降低。

- 后端服务器的健康检查状态异常。

  在压测时，容易忽略后端服务器的健康检查状态，如果有后端服务器健康检查失败或者健康检查状态经常跳跃（好到坏，又从坏到好，反复变化），也会导致压测性能低。

压测建议:

- 压测负载均衡转发能力建议使用短连接 。

  一般来说压测除了验证会话保持和均衡性等功能外，主要想验证负载均衡的转发能力，因此使用短连接比较合适，用于测试负载均衡和后端服务器的处理能力。使用短连接测试时，需要注意客户端端口不足的问题。

- 压测负载均衡吞吐量建议使用长连接，用于测试带宽上限或特殊业务。

  压测工具的超时时间建议设置为一个较小值，如5秒。超时时间太大的话，测试结果会体现在平均响应时间加长，不利于判断压测水位是否已到达。超时时间调小，测试结果会体现在成功率上，便于快速判断压测水位。

- 后端服务器提供一个静态网页用于压测，以避免应用逻辑带来的损耗。

- 压测时，监听配置建议如下：

  - 不开启会话保持功能，否则压力会集中在个别后端服务器。
  - 关闭健康检查功能，减少健康检查对后端服务器的访问请求。
  - 性能测试服务的5000并发规格能够提供5个及5个以上的公网IP。

不建议您使用Apache ab作为压力测试工具。

Apache ab在大量并发场景下存在3s、6s、9s阶梯式停顿的现象。Apache ab会通过判断content length来确定请求是否成功，而负载均衡挂载多台后端服务器时，返回的content length会不一致，导致测试结果有误。

建议使用阿里云[PTS](https://pts.aliyun.com/)。

可以设置足够高的并发，PTS会分配来自全国各地的公网IP，压力来源足够分散，并且可以在PTS中集成云监控，实时查看端到端的全部性能数据。

