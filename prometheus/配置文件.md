# 配置文件

[Configuration | Prometheus](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)

检查配置文件是否正确：`./promtool check config prometheus.yml`

重新加载配置：`kill -hup 进程id`

## 全局配置文件

```yaml
vim prometheus.yml
global:
	scrape_interval:     15s	#每隔15秒采集一次数据，默认1m
	evaluation_interval: 15s	#记录规则和报警规则的执行间隔（频率），默认1m
	scrape_timeout: 15s	#采集数据的超时时间，该值不能大于scrape_interval的值，默认10s。
#告警规则
rule_files:
    ...
#配置被监控端，称为target，每个target用job_name分组管理，又分静态配置和服务发现
scrape_configs:
    ...
#告警配置
alerting:
    ...
#从远程数据库读写
remote_write:
    ...
remote_read:
    ...
```

## scrape_configs

```yaml
job_name: <job_name>
#默认继承全局配置，在这指定会覆盖全局配置
[ scrape_interval: <duration> | default = <global_config.scrape_interval> ]
[ scrape_timeout: <duration> | default = <global_config.scrape_timeout> ]
#指标路径
[ metrics_path: <path> | default = /metrics ]
#标签
[ honor_labels: <boolean> | default = false ]

#http协议
[ scheme: <scheme> | default = http ]
#参数
params:
  [ <string>: [<string>, ...] ]
#基础认证
basic_auth:
  [ username: <string> ]
  [ password: <secret> ]
  [ password_file: <string> ]
tls_config:
  [ <tls_config> ]
[ proxy_url: <string> ]

#服务发现
consul_sd_configs:
  [ - <consul_sd_config> ... ]
dns_sd_configs:
  [ - <dns_sd_config> ... ]
file_sd_configs:
  [ - <file_sd_config> ... ]
kubernetes_sd_configs:
  [ - <kubernetes_sd_config> ... ]
...

#静态配置
static_configs:
  - target: ['localhost:9090']
  
relabel_configs:
  ...
  
metric_relabel_configs:
  ...
  
[ sample_limit: <int> | default = 0 ]
```

## relabel_configs

允许在采集之前对任何目标及其标签进行修改

重新标签的意义：

- 重命名标签
- 删除标签
- 过滤目标

```yaml
relabel_configs:
  #对哪个源标签操作
  [ source_labels: '[' <labelname> [, ...] ']' ]
  #多个源标签时连接的分隔符
  [ separator: <string> | default = ; ]
  #重新标记的标签
  [ target_label: <labelname> ]
  #正则表达式匹配源标签的值
  [ regex: <regex> | default = (.*) ]

  [ modulus: <int> ]
  #替换正则表达式匹配到的分组。分组引用$1,$2,$3
  [ replacement: <string> | default = $1 ]
  #基于正则表达式匹配执行的操作
  [ action: <relabel_action> | default = replace ]
```

action动作：

- replace：默认，通过regex匹配source_label的值，用replacement来引用表达式匹配的分组
- keep：删除regex不匹配的目标source_label
- drop：删除regex匹配的目标source_label
- labeldrop：删除regex匹配的标签
- labelkeep：删除regex不匹配的标签
- hashmod：设置target_label为modulus连接的哈希值source_labels
- labelmap：匹配regex所有标签名称，然后复制匹配标签的值进行分组