# spring cloud微服务架构

## 概念

传统的web开发方式，和微服务相对应的，这种方式成为单体式开发。所有功能打包在一个war包里，部署在一个JEE容器（tomcat、jboss、weblogic）里。

### 客户端如何访问服务？

原来的单体式开发，所有的服务都在本地，UI可以直接调用，现在按功能拆分成独立的服务，跑在独立的虚拟机的java进程。

后台有n个服务，前台就需要记住管理n个服务，n个服务的调用也是一个不小的网络开销，所以一般在后台n个服务和UI之间会有一个代理，或者叫API Gateway

网关：

拆分成微服务后，出现大量的服务，大量的接口。微服务的调用需要一个把关的东西，也就是网关。在调用者和被调用者中间加一层网关，每次调用时进行权限校验。另外，网关也可以作为一个提供服务接口文档的平台。

使用网关有一个问题就是要决定在多大粒度上使用：最粗粒度的方案是整个微服务一个网关，微服务外部通过网关访问微服务，微服务内部则直接调用；最细粒度则是所有调用，不管是微服务内部调用或者来自外部的调用，都必须通过网关。折中的方案是按照业务领域将微服务分成几个区，区内直接调用，区间通过网关调用。

服务注册与发现：

一个微服务如何发现其他微服务呢？最简单的方式就是每个微服务里面配置其他微服务的地址，但是当微服务数量众多的时候，这样做明显不现实。所以需要使用到微服务架构中的一个最重要的组件：**服务注册中心**，所有服务都注册到服务注册中心，同时也可以从服务注册中心获取当前可用的服务清单

![image-20210830000756786](https://gitee.com/c_honghui/picture/raw/master/img/20210830000803.png)

配置中心：

当服务数量超过一定程度之后，如果需要在每个服务里面分别维护每一个服务的配置文件，运维人员估计要哭了。那么，就需要用到微服务架构里面第二个重要的组件：**配置中心**

![image-20210830001102261](https://gitee.com/c_honghui/picture/raw/master/img/20210830001102.png)

熔断：

当一个服务因为各种原因停止响应时，调用方通常会等待一段时间，然后超时或者收到错误返回。如果调用链路比较长，可能会导致请求堆积，整条链路占用大量资源一直在等待下游响应。所以当多次访问一个服务失败时，应熔断，标记该服务已停止工作，直接返回错误。直至该服务恢复正常后再重新建立连接。

链路跟踪：

在微服务架构下，一个用户的请求往往涉及多个内部服务调用。为了方便定位问题，需要能够记录每个用户请求时，微服务内部产生了多少服务调用，及其调用关系。

要实现链路跟踪，每次服务调用会在HTTP的HEADERS中记录至少记录四项数据：

- traceId：traceId标识一个用户请求的调用链路。具有相同traceId的调用属于同一条链路。
- spanId：标识一次服务调用的ID，即链路跟踪的节点ID。
- parentId：父节点的spanId。
- requestTime & responseTime：请求时间和响应时间。

## 传统架构vs微服务架构

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20210816234357.png" alt="image-20210816234357840" style="zoom: 50%;" />

## 常见微服务框架

dubbo/dubbox

- 阿里开发、当当改良
- 基于rpc

spring cloud

- spring团队开发
- 基于restful

![image-20210830001235014](https://gitee.com/c_honghui/picture/raw/master/img/20210830001235.png)

## 服务类型

provider

- 提供者，提供服务的一方

consumer

- 消费者，调用服务的一方

## 通信方式

RPC

- 基于tcp，平台有关

RESTful

- 基于http，平台无关

## 技术架构

![image-20210817000011237](https://gitee.com/c_honghui/picture/raw/master/img/20210817000011.png)

