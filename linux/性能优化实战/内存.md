# 内存

## linux内存怎么工作

我们通常说的内存容量，其实这指的是物理内存，物理内存也称为主存，大多数计算机用的主存都是动态随机访问内存（DRAM）。**只有内核才可以直接访问物理内存。**



**Linux 内核给每个进程都提供了一个独立的虚拟地址空间**，并且这个地址空间是连续的。这样，**进程就可以很方便地访问内存，更确切地说是访问虚拟内存**

进程在用户态时，只能访问用户内存；只有进入内核态后，才可以访问内核空间内存



**对普通进程来说，能看到的其实是内核提供的虚拟内存，这些虚拟内存还需要通过页表，由系统映射为物理内存。**










VIRT 是进程虚拟内存的大小：只要是进程申请过的内存，**即便还没有真正分配物理内存，也会计算在内**。

RES 是常驻内存的大小：也就是进程实际使用的物理内存大小，**但不包括 Swap 和共享内存。**

SHR 是共享内存的大小：比如与其他进程**共同使用的共享内存、加载的动态链接库以及程序的代码段等。**

%MEM 是进程使用物理内存占系统总内存的百分比。



## 内存的监控

```shell
[root@localhost ~]# free
             total        used         free      shared   buffers   cached
Mem:         16402432    16360492      41940        0     465404   12714880
-/+ buffers/cache:        3180208   13222224
Swap:        8193108        264      8192844
```



首先是第一行：

1. total：物理内存的总大小。 
2. used：已经使用的物理内存多小。 
3. free：空闲的物理内存值。 
4. shared：多个进程共享的内存值。
5. buffers/cached：磁盘缓存的大小。 



1．**从内核的角度来查看内存的状态    total - used = free**

就是内核目前可以直接分配到，不需要额外的操作，即为上面free命令输出中第二行Mem项的值，可以看出，此系统物理内存有16G，空闲的内存只有41940K，也就是40M多一点，我们来做一个这样的计算：

16402432－16360492＝41940  

其实就是总的物理内存减去已经使用的物理内存得到的就是空闲的物理内存大小，注意这里的可用内存值41940并不包含处于buffers和cached状态的内存大小。

如果你认为这个系统空闲内存太小，那你就错了，实际上，内核完全控制着内存的使用情况，linux会在需要内存的时候，或在系统运行逐步推进时，将buffers和cached状态的内存变为free状态的内存，以供系统使用。 

2．**从应用层的角度来看系统内存的使用状态   free+buffer/cached**

也就是linux上运行的应用程序可以使用的内存大小，即free命令第三行“(-/+ buffers/cached)”的输出，可以看到，此系统已经使用的内存才3180208K，而空闲的内存达到13222224K，继续做这样一个计算：

41940＋（465404＋12714880）＝13222224

通过这个等式可知，应用程序可用的物理内存值是Mem项的free值加上buffers和cached值之和，也就是说，这个free值是包括buffers和cached项大小的，

对于应用程序来说，buffers/cached占有的内存是可用的，因为buffers/cached是为了提高文件读取的性能，当应用程序需要用到内存的时候，buffers/cached会很快地被回收，以供应用程序使用。

 buffer和cache也是真实的物理内存。

 通过内核角度去查看空闲内存，如果空闲内存较多，那很明显，这台机器是内存非常空闲的，但是如果从内核层面看到的free内存小的话，并不代表内存不足，**还要综合看buffer/cache，如果这个值也非常小，这样才能够说明内存确实不足了。**

## buffer和cache

buffers与cached都是内存操作，用来保存系统曾经打开过的文件以及文件属性信息，这样当操作系统需要读取某些文件时，会首先在buffers与cached内存区查找，如果找到，直接读出传送给应用程序，如果没有找到需要数据，才从磁盘读取，这就是操作系统的缓存机制，通过缓存，大大提高了操作系统的性能。但buffers与cached缓冲的内容却是不同的。


buffers是用来缓冲块设备做的，它只记录文件系统的元数据（metadata）以及 tracking in-flight pages，而cached是用来给文件做缓冲。更通俗一点说：buffers主要用来存放目录里面有什么内容，文件的属性以及权限等等。而cached直接用来记忆我们打开过的文件和程序。


## 内存泄漏

***\*内存泄漏的危害非常大，这些忘记释放的内存，不仅应用程序自己不能访问，系统也不能把它们再次分配给其他应用。内存泄漏不断累积，甚至会耗尽系统内存。\****



## 分析内存瓶颈

具体的分析思路主要有这几步。

1、先用 free 和 top，查看系统整体的内存使用情况。

2、再用 vmstat 和 pidstat，查看一段时间的趋势，，从而判断出内存问题的类型。

3、最后进行详细分析，比如内存分配分析、缓存 / 缓冲区分析、具体进程的内存使用分析等。