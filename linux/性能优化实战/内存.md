# 内存

## linux内存怎么工作

我们通常说的内存容量，其实这指的是物理内存，物理内存也称为主存，大多数计算机用的主存都是动态随机访问内存（DRAM）。只有内核才可以直接访问物理内存。



Linux 内核给每个进程都提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样，进程就可以很方便地访问内存，更确切地说是访问虚拟内存

进程在用户态时，只能访问用户内存；只有进入内核态后，才可以访问内核空间内存



内存映射，其实就是将虚拟内存地址映射到物理内存地址，为了完成内存映射，内核为每个进程都维护了一张页表，记录虚拟地址与物理地址的映射关系



查看内存使用情况：

![img](https://gitee.com/c_honghui/picture/raw/master/img/20220331232047.png)



![](https://gitee.com/c_honghui/picture/raw/master/img/20220331232053.png)
VIRT 是进程虚拟内存的大小：只要是进程申请过的内存，**即便还没有真正分配物理内存，也会计算在内**。

RES 是常驻内存的大小：也就是进程实际使用的物理内存大小，**但不包括 Swap 和共享内存。**

SHR 是共享内存的大小：比如与其他进程**共同使用的共享内存、加载的动态链接库以及程序的代码段等。**

%MEM 是进程使用物理内存占系统总内存的百分比。

## buffer和cache

在读写普通文件时，会经过文件系统，由文件系统负责与磁盘交互；而读写磁盘或者分区时，就会跳过文件系统，也就是所谓的“裸I/O“。这两种读写方式所使用的缓存是不同的，也就是文中所讲的 Cache 和 Buffer 区别。



**Buffers** 是对原始磁盘块的临时存储，也就是**用来缓存磁盘的数据**，通常不会特别大(20MB左右)，这样，内核就可以把分散的写集中起来统一优化磁盘的写入，比如可以把多次小的写合并成单词大的写等等

**Cached** 是从磁盘读取文件的页缓存，也就是用来**缓存从文件读取的数据**。这样，下次访问这些文件数据时，就可以直接从内存中快速获取，而不需要再次访问缓慢的磁盘。

## 内存泄漏

## 分析内存瓶颈

具体的分析思路主要有这几步。

1、先用 free 和 top，查看系统整体的内存使用情况。

2、再用 vmstat 和 pidstat，查看一段时间的趋势，，从而判断出内存问题的类型。

3、最后进行详细分析，比如内存分配分析、缓存 / 缓冲区分析、具体进程的内存使用分析等。