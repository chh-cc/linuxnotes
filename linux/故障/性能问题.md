## 问题一:load周期性升高,没有业务流量上升

分析:

在使用 top 命令检查系统负载的时候，可以看到 Load averages 字段，但是这个字段并不是表示 CPU 的繁忙程度，而是度量系统整体负载。  

如果你看到 load average 数值是 10，则表明平均有 10 个进程在运行或等待状态。有可能系统有很高的负载但是 CPU 使用率却很低，或者负载很低而 CPU 利用率很高，因为这两者没有直接关系。  

用脚本统计出来处于运行队列的进程呢:

```shell
#!/bin/bash
LANG=C
PATH=/sbin:/usr/sbin:/bin:/usr/bin
interval=1
length=86400
for i in $(seq 1 $(expr ${length} / ${interval}));do
date
LANG=C ps -eTo stat,pid,tid,ppid,comm --no-header | sed -e 's/^ \*//' |
perl -nE 'chomp;say if (m!^\S*[RD]+\S*!)'
date
cat /proc/loadavg
echo -e "\n"
sleep ${interval}
done
```

从统计出来的结果可以看到：

```shell
at Jan 20 15:54:12 CST 2018
D 958 958 957 nginx
D 959 959 957 nginx
D 960 960 957 nginx
D 961 961 957 nginx
R 962 962 957 nginx
D 963 963 957 nginx
D 964 964 957 nginx
D 965 965 957 nginx
D 966 966 957 nginx
D 967 967 957 nginx
D 968 968 957 nginx
D 969 969 957 nginx
D 970 970 957 nginx
D 971 971 957 nginx
D 972 972 957 nginx
D 973 973 957 nginx
D 974 974 957 nginx
R 975 975 957 nginx
D 976 976 957 nginx
D 977 977 957 nginx
D 978 978 957 nginx
D 979 979 957 nginx
R 980 980 957 nginx
D 983 983 957 nginx
D 984 984 957 nginx
D 985 985 957 nginx
D 986 986 957 nginx
D 987 987 957 nginx
D 988 988 957 nginx
D 989 989 957 nginx
R 11908 11908 18870 ps
Sat Jan 20 15:54:12 CST 2018
25.76 20.60 19.00 12/404 11912
注： R 代表运行中的队列， D 是不可中断的睡眠进程
```

在 load 比较高的时候，有大量的 nginx 处于 R 或者 D 状态，他们才是造成 load 上升的元凶，和我们底层的负载确实是没有关系的。  

查 CPU 使用率比较高的线程小脚本：  

```shell
#!/bin/bash
LANG=C
PATH=/sbin:/usr/sbin:/bin:/usr/bin
interval=1
length=86400
for i in $(seq 1 $(expr ${length} / ${interval}));do
date
LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | grep -v CPU | sort -n -r | head -20
date
LANG=C cat /proc/loadavg
{ LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | sed -e 's/^ *//' | tr -s ' ' |
grep -v CPU | sort -n -r | cut -d ' ' -f 1 | xargs -I{} echo -n "{} + " &&
echo '0'; } | bc -l
sleep ${interval}
done
fuser -k $0
```

## 问题二：IO异常飙升，系统响应慢

分析：

iostat采集IO，确认IO发生在系统盘还是数据盘

```shell
#每隔 3 秒采集一次磁盘 io，输出时间，一共采集 30 次
iostat -d 3 -k -x -t 30

通过这个命令我们可以确认如下信息：
- 问题发生的时间
- 哪块盘发生的 io
- 磁盘的 IOPS（ r/s w/s）以及吞吐量（ rkB/s wkB/s ）
```

再抓一下发生 IO 的进程，需要安装 iotop 进行捕获  

```shell
yum install iotop -y
#每隔 3 秒采集一次，一共采集 30 次，静默模式，只显示有 io 发生的进程
iotop -b -o -d 3 -t -qqq -n 30

通过这个命令我们可以确认如下信息：
- 问题发生的时间
- 产生 IO 的进程 id 以及进程参数（ command）
- 进程产生的吞吐量（如果有多个可以把 qqq 去掉可显示总量）
- 进程占用当前 IO 的百分比
```

