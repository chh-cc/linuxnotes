## vmstat、mpstat、iostat、sar、pidstat

vmstat 内存监控工具，主要看memory

```shell
vmstat 1 10
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 258380 190788 2702112    0    0    40   161    1    1 17  5 78  1  0
 2  0      0 263432 190788 2702216    0    0     0  1748 6925 9058 49  7 43  1  0
 3  0      0 185860 190788 2702436    0    0     0   912 7482 9277 69  4 27  0  0
 2  0      0 280304 190788 2702468    0    0     0   620 6736 9173 45  5 50  0  0
 3  0      0 212876 190788 2702568    0    0     0   284 6641 9430 38  7 55  0  0
 2  0      0 255876 190788 2702576    0    0     0   604 7364 9314 65 11 23  0  0
 6  0      0 318840 190788 2702448    0    0     0   336 5912 9076 22  8 71  0  0
 2  0      0 225620 190788 2702520    0    0     0  1024 8397 13429 64 13 23  0  0
 1  0      0 228412 190788 2702552    0    0     0  1052 7066 10195 42  4 52  2  0
 3  0      0 252344 190792 2702528    0    0     0   244 6921 8890 50 11 38  0  0
```

mpstat 实时cpu监控工具，主要看idle

```shell
mpstat -P ALL 1 10
Linux 3.10.0-327.10.1.el7.x86_64 (iZ94dupy6gtZ)         05/05/2023      _x86_64_        (4 CPU)

05:38:03 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:38:04 PM  all   40.20    0.00    7.29    1.01    0.00    0.25    0.00    0.00    0.00   51.26
05:38:04 PM    0   42.00    0.00   15.00    2.00    0.00    0.00    0.00    0.00    0.00   41.00
05:38:04 PM    1    7.22    0.00    2.06    2.06    0.00    0.00    0.00    0.00    0.00   88.66
05:38:04 PM    2   19.19    0.00    3.03    0.00    0.00    0.00    0.00    0.00    0.00   77.78
05:38:04 PM    3   92.08    0.00    7.92    0.00    0.00    0.00    0.00    0.00    0.00    0.00

05:38:04 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:38:05 PM  all   64.07    0.00    8.79    0.50    0.00    0.25    0.00    0.00    0.00   26.38
05:38:05 PM    0   60.61    0.00    7.07    0.00    0.00    1.01    0.00    0.00    0.00   31.31
05:38:05 PM    1   47.52    0.00   17.82    1.98    0.00    0.99    0.00    0.00    0.00   31.68
05:38:05 PM    2   67.68    0.00    5.05    0.00    0.00    0.00    0.00    0.00    0.00   27.27
05:38:05 PM    3   79.00    0.00    6.00    0.00    0.00    0.00    0.00    0.00    0.00   15.00

...
```

iostat 查看磁盘读写信息（查看磁盘忙不忙，主要看util）

```shell
iostat -d -x -k 1 10
Linux 3.10.0-327.10.1.el7.x86_64 (iZ94dupy6gtZ)         05/05/2023      _x86_64_        (4 CPU)

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.09    26.08   12.35   37.99   157.09   640.36    31.69     0.13    2.56    3.52    2.25   0.62   3.13
vdb               0.00     0.00    0.00    0.00     0.02     0.00    14.72     0.00    1.84    1.83    3.32   0.25   0.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00    55.00    0.00   67.00     0.00  1364.00    40.72     0.13    1.93    0.00    1.93   0.64   4.30
vdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

...
```

sar 性能分析工具（查看详细负载）

```shell
sar -q 1 10
Linux 3.10.0-327.10.1.el7.x86_64 (iZ94dupy6gtZ)         05/05/2023      _x86_64_        (4 CPU)

06:01:48 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
06:01:49 PM         2      2287      2.70      2.53      2.51         0
06:01:50 PM         3      2287      2.64      2.52      2.51         0
06:01:51 PM         4      2289      2.64      2.52      2.51         0
06:01:52 PM         3      2288      2.64      2.52      2.51         0
06:01:53 PM         4      2287      2.64      2.52      2.51         0
06:01:54 PM         5      2288      2.64      2.52      2.51         0
06:01:55 PM         3      2288      2.83      2.56      2.52         0
06:01:56 PM         1      2287      2.83      2.56      2.52         0
06:01:57 PM         1      2287      2.83      2.56      2.52         0
06:01:58 PM         1      2287      2.83      2.56      2.52         0
Average:            3      2288      2.72      2.54      2.51         0
```

pidstat 查看某个进程占用磁盘读写

```shell
pidstat -d 1 10
Linux 3.10.0-327.10.1.el7.x86_64 (iZ94dupy6gtZ)         05/05/2023      _x86_64_        (4 CPU)

06:03:14 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
06:03:15 PM     0       288      0.00      7.77      0.00  jbd2/vda1-8
06:03:15 PM    27      1350      0.00    411.65      0.00  mysqld
06:03:15 PM     0    251848      0.00      3.88      0.00  AliHips
06:03:15 PM     0    961639      0.00      3.88      3.88  supervisord

06:03:15 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
06:03:16 PM     0       288      0.00      8.00      0.00  jbd2/vda1-8
06:03:16 PM    27      1350      0.00    116.00      0.00  mysqld
06:03:16 PM     0    261301      0.00      4.00      4.00  airflow
06:03:16 PM     0    261310      0.00      4.00      4.00  airflow
06:03:16 PM     0    961639      0.00      8.00      0.00  supervisord

...
```

## lsof使用和脏数据清理

lsof #显示系统正打开的所有文件

lsof 文件 #查看文件是否被打开

lsof -p pid #查看进程打开了哪些文件

通过端口查看打开了哪些文件：lsof -i :端口号;lsof -p pid



有时候删除文件后磁盘空间并没有变化，可能是文件还被其他进程打开着，如何清理脏数据：

lsof ｜grep deleted

ll /proc/pid号/fd

echo > /proc/pid号/fd/3