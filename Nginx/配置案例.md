# 配置案例

## 通过slb转发到部署在nginx的网站

配置slb

- 域名解析到slb公网ip，申请域名证书
- 配置slb七层443监听端口和部署证书
- 配置后端服务器端口为443

配置后端nginx

```shell
...
http {
    server {
    listen 80;
    server_name www.xxx.com xxx.com;
    index index.html index.php index.htm;
    charset utf-8;
   
    if ($host = "www.xxx.com") {
       rewrite ^/(.*)$ https://www.xxx.com permanent;
    }
 
    client_max_body_size 75M;
    location / {
            root   /usr/local/xxx;
            index  index.html index.htm;
    }
    }
    
    server {
        listen       443;
        server_name  www.xxx.com xxx.com;

        charset utf-8;

        client_max_body_size 75M;

        location / {
            root   /usr/local/xxx;
            index  index.html index.htm;
        }
    }
}
```

## 通过slb转发到nginx再转发二级域名

配置slb

- 域名解析到slb公网ip

- 配置slb四层443监听端口
- 配置后端服务器端口为443

配置后端nginx

```shell
...
http {
  server {
     listen 443; 
     server_name xxx.xxx.com;
     access_log  /var/log/nginx/xxx.log;

     ssl on;
     ssl_certificate /etc/ssl/poop2020/5916045_xxx.xxx.com.pem;
     ssl_certificate_key /etc/ssl/poop2020/5916045_xxx.xxx.com.key;
     ssl_session_timeout 5m;
     ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
     ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;
     ssl_prefer_server_ciphers on;
     
     location / {
        proxy_pass  http://10.xx.xx.125:8801;
        proxy_redirect     off;
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header X-NginX-Proxy true;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_redirect off;
        proxy_max_temp_file_size 0;
        proxy_connect_timeout 900;
        proxy_send_timeout 900;
        proxy_read_timeout 9000;
        proxy_buffer_size 16k;
        proxy_buffers 4 64k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
        client_max_body_size 20m;
        client_body_buffer_size 10m;
        fastcgi_connect_timeout 1200s;
        fastcgi_send_timeout 1200s;
		fastcgi_read_timeout 1200s; 
     }
}
```

