# Helm

## Helm安装

Helm安装文档

[Helm | Installing Helm](https://helm.sh/docs/intro/install/)

Helm安装包

[Releases · helm/helm (github.com)](https://github.com/helm/helm/releases)

## 概念

Helm是Kubernetes的包管理器，类似于centos的yum，主要用来管理 Charts

- Chart：用来封装Kubernetes原生应用程序的一系列YAML文件，类似yum的rpm文件
- Release：在Kubernetes集群上运行的Chart的一个实例。在同一个集群上，一个Chart可以安装很多次。每次安装都会创建一个新的release。
- Repository：用于发布和存储Chart的存储库。

组件

- Helm CLI是Helm客户端，可以在Kubernetes集群的master节点或者本地执行。
- Tiller是服务器端组件，在Kubernetes集群上运行，并管理Kubernetes应用程序的生命周期。
- Repository是Chart存储库，Helm客户端通过HTTP协议来访问存储库中Chart的索引文件和压缩包。

Helm v3是直接与k8s api互通 无需再helm init 创建服务端，Helm2是CS结构，客户端称为Helm，服务端称为Tiller；Helm3只有客户端，称为Helm。

## 使用

```shell
#先添加常用的chart源
helm repo add stable https://kubernetes-charts.storage.googleapis.com
helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com  
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add aliyuncs https://apphub.aliyuncs.com

#查看chart列表
[root@master nginx]# helm repo list
NAME        URL                                                       
stable      https://kubernetes-charts.storage.googleapis.com          
incubator   https://kubernetes-charts-incubator.storage.googleapis.com
bitnami     https://charts.bitnami.com/bitnami                        
aliyuncs    https://apphub.aliyuncs.com 
```

查看版本

```shell
[root@master nginx]# helm search repo nginx
NAME                                CHART VERSION   APP VERSION             DESCRIPTION                                       
aliyuncs/nginx                      5.1.5           1.16.1                  Chart for the nginx server                        
aliyuncs/nginx-ingress              1.30.3          0.28.0                  An nginx Ingress controller that uses ConfigMap...
aliyuncs/nginx-ingress-controller   5.3.4           0.29.0                  Chart for the nginx Ingress controller            
aliyuncs/nginx-lego                 0.3.1                                   Chart for nginx-ingress-controller and kube-lego  
aliyuncs/nginx-php                  1.0.0           nginx-1.10.3_php-7.0    Chart for the nginx php server                    
bitnami/nginx                       6.2.1           1.19.2                  Chart for the nginx server                        
bitnami/nginx-ingress-controller    5.5.1           0.35.0                  Chart for the nginx Ingress controller            
stable/nginx-ingress                1.41.3          v0.34.1                 DEPRECATED! An nginx Ingress controller that us...
stable/nginx-ldapauth-proxy         0.1.4           1.13.5                  nginx proxy with ldapauth                         
stable/nginx-lego                   0.3.1                                   Chart for nginx-ingress-controller and kube-lego  
bitnami/kong                        1.3.2           2.1.3                   Kong is a scalable, open source API layer (aka ...
stable/gcloud-endpoints             0.1.2           1                       DEPRECATED Develop, deploy, protect and monitor...
```

下载chart包

```shell
helm pull aliyuncs/nginx --untar #将nginx包从创库拉到当前目录
#查看结构
[root@master charts]# tree nginx/
nginx/
├── Chart.yaml #包含Chart的基本信息，包括chart版本，名称等
├── ci
│   └── values-with-ingress-metrics-and-serverblock.yaml
├── README.md
├── templates #存放应用一系列 k8s 资源的 yaml 模板
│   ├── deployment.yaml
│   ├── _helpers.tpl #下划线开头，定义一些可重用的模板片断，此文件中的定义在任何资源定义模板中可用
│   ├── ingress.yaml
│   ├── NOTES.txt
│   ├── server-block-configmap.yaml
│   ├── servicemonitor.yaml
│   ├── svc.yaml
│   └── tls-secrets.yaml
├── values.schema.json
└── values.yaml #包含了必要的值定义（默认值）, 用于存储 templates 目录中模板文件中用到变量的值

2 directories, 13 files
```

## Helm语法

### 表达式

模版表达式： {{ 模版表达式 }}

模版表达式： {{- 模版表达式 -}} ， 表示去掉表达式输出结果前面和后面的空格，去掉前面空格可以这么写{{- 模版表达式 }}, 去掉后面空格 {{ 模版表达式 -}}

### 变量和变量作用域

默认情况最左面的点( . ), 代表全局作用域，用于引用全局对象，中间的点，很像是js中对json对象中属性的引用方式。

**Values**代表的就是values.yaml定义的参数：

```yaml
cat templates/deployment.yaml
#引用全局作用域下values对象的replicaCount属性
{{ .Values.replicaCount }}
#引用嵌套对象
{{ .Values.image.repository }}
```

### 流程控制语句

**with**主要就是用来修改 . 作用域的

```yaml
{{ .Values.a.b.c.repository }}
{{ .Values.a.b.c.pullPolicy }}
转成：
{{- with .Values.a.b.c }}
{{ .repository }}
{{ .pullPolicy }}
{{- end }}
```

**if**语法

```yaml
{{ if 条件表达式 }}
# Do something
{{ else if 条件表达式 }}
# Do something else
{{ else }}
# Default case
{{ end }}
```

**range**主要用于循环遍历数组类型

语法1:

 ```yaml
 #遍历map类型，用于遍历键值对象
 
 #变量$key代表对象的属性名，$val代表属性值
 
 {{- range $key, $val := 键值对象 }}
 {{ $key }}: {{ $val | quote }}
 {{- end}}
 ```

语法2：

```
{{- range 数组 }}
{{ . | title | quote }} # . (点)，引用数组元素值。
{{- end }}
```

```yaml
#values.yaml定义

#map类型
favorite:
  drink: coffee
  food: pizza

#数组类型
pizzaToppings:
  - mushrooms
  - cheese
  - peppers
  - onions

map类型遍历例子:
{{- range $key, $val := .Values.favorite }}
{{ $key }}: {{ $val | quote }}
{{- end}}

数组类型遍历例子:
{{- range .Values.pizzaToppings}}
{{ . | quote }} 
{{- end}}
```

### 子模版定义

可以在_(下划线)开头的文件中定义子模版，方便后续复用

helm create默认为我们创建了_helpers.tpl 公共库定义文件，可以直接在里面定义子模版，也可以新建一个，只要以下划线开头命名即可

语法：

```yaml
定义模版:
{{ define "模版名字" }} 模版内容 {{ end }}

引用模版:
{{ include "模版名字" 作用域}}
```

### 函数

http://masterminds.github.io/sprig/strings.html