# Service

## 为什么用service

每个pod都有自己的ip地址，也可以被访问，可是**pod的ip是不固定的**，一旦被更新、被删除后重新创建，ip地址就改变了，所以引入service这个概念

服务调用需要对不同的pod进行负载均衡

Service是一种可以访问 Pod逻辑分组的策略， Service**通过 Label Selector**选取合适的pod，构建出一个**endpoint，即负载均衡列表**。实际运用中一般会为同一个微服务的pod实例都打上类似`app=xxx`的标签，同时为该微服务创建一个标签为`app=xxx`的service。

![img](https://gitee.com/c_honghui/picture/raw/master/img/20211123234933.jpeg)

## 定义一个service

创建一个svc的同时会创建一个同名的endpoint，endpoint记录了svc关联的pod的ip地址；**pod更新后ip地址改变，endpoint的地址也会刷新**

查看endpoint：

```shell
kubectl get ep -n kube-system
```

定义一个svc

```yaml
vim nginx-svc.yaml

apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx
  name: nginx-svc
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  - name: https
    port: 443
    protocol: TCP
    targetPort: 443
  selector:
    app: nginx
  sessionAffinity: None
  type: ClusterIP
```

创建svc

```shell
kubectl create -f nginx-svc.yaml

#查看svc
kubectl get svc nginx-svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
nginx-svc    ClusterIP   10.100.169.194   <none>        80/TCP,443/TCP   4s

#在集群内部访问clusterip
[root@k8s-master01 ~]# curl 10.100.169.194
#pod之间访问
curl http://nginx-svc

#查看endpoint
kubectl get ep nginx-svc
NAME         ENDPOINTS                                                              AGE
nginx-svc    172.161.125.10:443,172.161.125.18:443,172.171.14.246:443 + 3 more...   5d19h
```

## service类型

东西向的流量调用，即服务间的调用，使用ClusterIP

南北向的流量调用，即外部请求访问k8s集群，使用Nodeport、LoadBalancer

### ClusterIP

ClusterIP：默认值，在**集群内部使用**的IP，其他pod可以通过这个ip访问到该pod组，集群外部访问不了

![img](https://gitee.com/c_honghui/picture/raw/master/img/20211126004158.jpeg)

配置文件：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-python #service名称
spec:
  clusterIP: 10.97.97.97 #不指定会自动分配
  ports:
  - port: 3000 #service端口
    protocol: TCP
    targetPort: 443 #后端pod端口
  selector:
    run: pod-python
  type: ClusterIP #service类型
```

### NodePort

NodePort：在所有安装了kube-proxy的节点打开一个端口来暴露服务，**集群外部**通过NodeIP:NodePort访问pod的服务，**nodeport端口号默认范围是30000~32767**

![img](https://gitee.com/c_honghui/picture/raw/master/img/20211126004412.jpeg)

```shell
kubectl get svc -n kubernetes-dashboard
NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard        NodePort    10.111.4.67     <none>        443:30543/TCP   21d
```

编辑nginx-svc

```shell
kubectl edit svc nginx-svc
```

修改配置

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-python
spec:
  ports:
  - port: 3000 #service端口
    protocol: TCP
    targetPort: 443 #后端pod端口
    nodePort: 30080 #node节点的端口，不指定会自动分配
  selector:
    run: pod-python
  type: NodePort
```

查看svc

```shell
kubectl get svc
```

### LoadBalancer

LoadBalancer：使用云供应商的负载均衡器公开服务，把每个NodeIP:NodePort作为后端添加进去

![img](https://gitee.com/c_honghui/picture/raw/master/img/20211126004657.jpeg)

配置文件：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-python
spec:
  ports:
  - port: 3000
    protocol: TCP
    targetPort: 443
    nodePort: 30080
  selector:
    run: pod-python
  type: LoadBalancer
```

### Headless Service

k8s的dns会解析service为clusterip，这样可以通过clusterip随机访问后端的pod。如果想要dns解析podip，那就要用headless service（无头服务）

定义headless service

```yaml
vim nginx-sts.yaml

apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  clusterIP: None #此参数表示headless service
  selector:
    app: nginx
  ports:
  - name: web
    port: 80
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  serviceName: "nginx"
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:  
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.15.2
        ports:
        - containerPort: 80
          name: web
```

查看svc

```shell
kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.0.0.1     <none>        443/TCP   3d10h
nginx        ClusterIP   None         <none>        80/TCP    2m48s
```

dns解析

```shell
nslookup web-01.nginx.default.svc.cluster.local
```

