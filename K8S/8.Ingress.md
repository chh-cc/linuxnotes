# Ingress

k8s可以通过nodeport、loadbalancer让集群外部访问服务，但是采用 NodePort 方式暴露服务面临问题是，**服务一旦多起来，NodePort 在每个节点上开启的端口也会变多**，而且难以维护

我们可以部署一个nginx-pod，把nginx-pod的端口映射到宿主机，然后在nginx-pod里面配置转发给相应的service就行了，但也有新的缺陷，每次有新加的服务就要手动修改nginx-pod配置，所以要用到ingress

ingress用于实现用域名的方式访问k8s内部应用。

Ingress-Nginx官方文档：[Introduction - NGINX Ingress Controller (kubernetes.github.io)](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/)

## 原理

Ingress 简单的理解就是你原来需要改 Nginx 配置，然后配置各种域名对应哪个 Service，现在把这个动作抽象出来，变成一个 Ingress 对象，你可以用 yaml 创建，每次不要去改 Nginx 了，直接改 yaml 然后创建/更新就行了

Ingress Controller 这东西就是解决 “Nginx 的处理方式” 的；Ingress Controoler 通过与 Kubernetes API 交互，动态的去感知集群中 Ingress 规则变化，然后读取他，按照他自己模板生成一段 Nginx 配置，再写到 Nginx Pod 里，最后 reload 一下

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20220220011114.png" alt="img" style="zoom:80%;" />

## 安装ingress

先安装Helm

https://helm.sh/docs/intro/install/

使用helm安装ingress：

```shell
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
```

查看repo源:

```shell
helm repo list
```

查看ingress-nginx的版本

```shell
helm search repo ingress-nginx
```

下载ingress的helm包至本地

```shell
helm pull ingress-nginx/ingress-nginx
#wget https://github.com/kubernetes/ingress-nginx/releases/download/ingress-nginx-3.6.0/ingress-nginx-3.6.0.tgz
```

更改对应的配置

```shell
[root@master01 ~]# mkdir temp

[root@master01 ~]# mv ingress-nginx-3.6.0.tgz temp/

[root@master01 ~]# cd temp/

[root@master01 temp]# tar xf ingress-nginx-3.13.0.tgz

[root@master01 temp]# cd ingress-nginx

[root@master01 ingress-nginx]# ls

CHANGELOG.md Chart.yaml ci OWNERS README.md templates values.yaml

[root@master01 ingress-nginx]#vim values.yaml
```

需要修改的位置

```yaml
controller.image.repository: registry.cn-beijing.aliyuncs.com/dotbalo/controller #需要将公网镜像同步至公司内网镜像仓库
controller.image.tag: "v0.40.2"

dnsPolicy: ClusterFirstWithHostNet

hostNetwork: true #设置为true,使用宿主机的端口

kind: DaemonSet

nodeSelector: ingress: "true"

type: ClusterIP

controller.admissionWebhook.patch.image.repository: registry.cn-beijing.aliyuncs.com/dotbalo/kube-webhook-certgen
controller.admissionWebhook.patch.image.tag: v1.3.0
```

给需要部署ingress的节点上打标签

```shell
kubectl label node k8s-node01 ingress=true
kubectl create ns ingress-nginx
helm install ingress-nginx -n ingress-nginx .
```

查看pod

```shell
kubectl get po -n ingress-nginx
NAME                             READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-zwlwh   1/1     Running   0          2m6s
```

## 配置ingress

### 转发域名到后端service

创建一个ingress实例

```yaml
#之前集群有部署kuboard，我们创建个ingress让nginx转发到kuboard这个service
#kubectl get svc -n kube-system
NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
kuboard          NodePort    10.111.246.18   <none>        80:32567/TCP             98d

vim ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-kuboard #ingress名称
  namespace: kube-system #后端service的namespace
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: / #访问域名的路径
        pathType: Prefix
        backend:
          service:
            name: kuboard #后端service名称
            port: 
              number: 80 #后端service端口
              
#然后把kuboard.k8s.com解析到ingress的节点ip：192.168.101.148，就可以用域名访问kuboard

#进入ingress-nginx这个pod里可以看到nginx.conf里自动增加以下内容
server {
		server_name kuboard.k8s.com ;
		
		listen 80  ;
		
		location ~* "^/" {
			
			set $namespace      "kube-system";
			set $ingress_name   "ingress-kuboard";
			set $service_name   "kuboard";
			set $service_port   "80";
			set $location_path  "/";
			
		}
}
```

### 永久重定向

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
              
#访问kuboard.k8s.com会跳转到https://www.baidu.com，浏览器地址也会改变
```

### 重写（rewrite）

kuboard.k8s.com/api → kuboard.k8s.com，浏览器地址不会变

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2 #路径重写为/$2,$2就是path参数的(.*)
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

### SSL证书

创建secret

```shell
kubectl create secret tls ingress-kuboard-tls --key tls.key --cert tls.key -n kube-system
```

ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
  tls:
    - hosts:
        - kuboard.k8s.com
      secretName: ingress-kuboard-tls
```

### 黑白名单

Annotations：只对指定ingress有效，适合配置白名单，其他ip访问会403

configmap：全局生效，适合配置黑名单

Annotations配置白名单

```yaml
nginx.ingress.kubernetes.io/whitelist-source-range: 172.10.0.1
```

Annotations配置黑名单

```yaml
    nginx.ingress.kubernetes.io/server-snippet: |-
      deny 192.168.0.1;
      deny 192.168.0.100;
      allow all;
```

configmap配置黑名单？

```yaml
vim nginx-blockcidrs.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blockcidrs
  namespace: kube-system
data:
  blockcidrs: 192.168.101.144
```

### 匹配请求头

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/server-snippet: |-

        if ($http_user_agent ~* "(Mobile)" ){
          set $agentflag 1;
        }

        if ( $agentflag = 1 ) {
          return 301 https://m.example.com;
        }
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

### 速率限制

```shell
#这些注释定义了对连接和传输速率的限制。这些可以用来减轻DDoS攻击。
 
nginx.ingress.kubernetes.io/limit-connections #单个IP地址允许的并发连接数。超出此限制时，将返回503错误。
nginx.ingress.kubernetes.io/limit-rps #每秒从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-rpm #每分钟从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-burst-multiplier #突发大小限制速率的倍数。默认的脉冲串乘数为5，此注释将覆盖默认的乘数。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-rate-after #最初的千字节数，在此之后，对给定连接的响应的进一步传输将受到速率的限制。必须在启用代理缓冲的情况下使用此功能。
nginx.ingress.kubernetes.io/limit-rate #每秒允许发送到给定连接的千字节数。零值禁用速率限制。必须在启用代理缓冲的情况下使用此功能。
nginx.ingress.kubernetes.io/limit-whitelist #客户端IP源范围要从速率限制中排除。该值是逗号分隔的CIDR列表。
```



```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/limit-rate: 100K #限制客户端每秒传输的字节数
    nginx.ingress.kubernetes.io/limit-whitelist: 10.1.10.100 #白名单中的IP不限速
    nginx.ingress.kubernetes.io/limit-rps: 1 #单个IP每秒的连接数
    nginx.ingress.kubernetes.io/limit-rpm: 30 #单个IP每分钟的连接数
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

