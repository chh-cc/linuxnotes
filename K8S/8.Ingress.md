# Ingress

k8s可以通过nodeport、loadbalancer让集群外部访问服务，但是采用 NodePort 方式暴露服务面临问题是，**服务一旦多起来，NodePort 在每个节点上开启的端口也会变多**，而且难以维护，而且service是四层转发

我们更希望看到 Kubernetes 内置一个全局的负载均衡器。然后，通过访问URL，把请求转发给不同的后端 Service。

这种全局的、为了代理不同后端 Service 而设置的负载均衡服务，就是 Kubernetes 里的 Ingress 服务。

所以，Ingress 的功能其实很容易理解：所谓 Ingress，就是 Service 的“Service”。

ingress用于实现用域名的方式访问k8s内部应用。

Ingress-Nginx官方文档：[Introduction - NGINX Ingress Controller (kubernetes.github.io)](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/)

## 原理

### Ingress

Ingress对象的主要内容，其实就是一个“反向代理”的配置文件的描述，它定义了某个域名的请求转发到集群中指定的 Service。

<img src="https://gitee.com/c_honghui/picture/raw/master/img/20220220011114.png" alt="img" style="zoom:80%;" />

### Ingress Controller

Ingress Controller 这东西就是解决 “Nginx 的处理方式” 的；在集群中部署Ingress Controller，它会根据ingress对象生成一段 Nginx 配置，再写到 ingress-nginx 这个Pod 里，最后 reload 一下

## 安装ingress contoller

先安装Helm

https://helm.sh/docs/intro/install/

使用helm安装ingress：

```shell
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
```

查看repo源:

```shell
helm repo list
```

查看ingress-nginx的版本

```shell
helm search repo ingress-nginx
```

下载ingress的helm包至本地

```shell
helm pull ingress-nginx/ingress-nginx
#wget https://github.com/kubernetes/ingress-nginx/releases/download/ingress-nginx-3.6.0/ingress-nginx-3.6.0.tgz
```

更改对应的配置

```shell
[root@master01 ~]# mkdir temp

[root@master01 ~]# mv ingress-nginx-3.6.0.tgz temp/

[root@master01 ~]# cd temp/

[root@master01 temp]# tar xf ingress-nginx-3.13.0.tgz

[root@master01 temp]# cd ingress-nginx

[root@master01 ingress-nginx]# ls

CHANGELOG.md Chart.yaml ci OWNERS README.md templates values.yaml

[root@master01 ingress-nginx]#vim values.yaml
```

需要修改的位置

```yaml
controller.image.repository: registry.cn-beijing.aliyuncs.com/dotbalo/controller #需要将公网镜像同步至公司内网镜像仓库
controller.image.tag: "v0.40.2"

dnsPolicy: ClusterFirstWithHostNet

hostNetwork: true #设置为true,使用宿主机的端口

kind: DaemonSet

nodeSelector: ingress: "true"

type: ClusterIP

controller.admissionWebhook.patch.image.repository: registry.cn-beijing.aliyuncs.com/dotbalo/kube-webhook-certgen
controller.admissionWebhook.patch.image.tag: v1.3.0
```

给需要部署ingress的节点上打标签

```shell
kubectl label node k8s-node01 ingress=true
kubectl create ns ingress-nginx
helm install ingress-nginx -n ingress-nginx .
```

查看pod

```shell
kubectl get po -n ingress-nginx
NAME                             READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-zwlwh   1/1     Running   0          2m6s
```

## 创建配置ingress对象

### 转发域名到后端service

创建一个ingress实例

```yaml
#之前集群有部署kuboard，我们创建个ingress让nginx转发到kuboard这个service
kubectl get svc -n kube-system
NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
kuboard          NodePort    10.111.246.18   <none>        80:32567/TCP             98d

#创建一个ingress对象
vim ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-kuboard #ingress名称
  namespace: kube-system #要和代理的后端service的namespace一样
spec:
  ingressClassName: nginx
  rules: #定义规则
  - host: kuboard.k8s.com #站点域名
    http:
      paths:
      - path: / #url
        pathType: Prefix
        backend:
          service:
            name: kuboard #url对应的后端service名称
            port: 
              number: 80 #后端service端口
              
#然后把kuboard.k8s.com解析到ingress的节点ip：192.168.101.148，就可以用域名访问kuboard

#进入ingress-nginx这个pod里可以看到nginx.conf里自动增加以下内容
server {
		server_name kuboard.k8s.com ;
		
		listen 80  ;
		
		location ~* "^/" {
			
			set $namespace      "kube-system";
			set $ingress_name   "ingress-kuboard";
			set $service_name   "kuboard";
			set $service_port   "80";
			set $location_path  "/";
			
		}
}
```

### 永久重定向

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
              
#访问kuboard.k8s.com会跳转到https://www.baidu.com，浏览器地址也会改变
```

### 重写（rewrite）

kuboard.k8s.com/api → kuboard.k8s.com，浏览器地址不会变

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2 #路径重写为/$2,$2就是path参数的(.*)
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

### SSL证书

创建secret

```shell
kubectl create secret tls ingress-kuboard-tls --key tls.key --cert tls.key -n kube-system
```

ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
  tls:
    - hosts:
        - kuboard.k8s.com
      secretName: ingress-kuboard-tls
```

### 黑白名单

Annotations：只对指定ingress有效，适合配置白名单，其他ip访问会403

configmap：全局生效，适合配置黑名单

Annotations配置白名单

```yaml
nginx.ingress.kubernetes.io/whitelist-source-range: 172.10.0.1
```

Annotations配置黑名单

```yaml
    nginx.ingress.kubernetes.io/server-snippet: |-
        deny 192.168.0.1;
        deny 192.168.0.100;
        allow all;
```

configmap配置黑名单？

```yaml
vim nginx-blockcidrs.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blockcidrs
  namespace: kube-system
data:
  blockcidrs: 192.168.101.144
```

### 匹配请求头

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/server-snippet: |-
        set $agentflag 0;
         
        if ($http_user_agent ~* "(Mobile)" ){
          set $agentflag 1;
        }

        if ( $agentflag = 1 ) {
          return 301 https://m.example.com;
        }
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

### 速率限制

```shell
#这些注释定义了对连接和传输速率的限制。这些可以用来减轻DDoS攻击。
 
nginx.ingress.kubernetes.io/limit-connections #单个IP地址允许的并发连接数。超出此限制时，将返回503错误。
nginx.ingress.kubernetes.io/limit-rps #每秒从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-rpm #每分钟从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-burst-multiplier #突发大小限制速率的倍数。默认的脉冲串乘数为5，此注释将覆盖默认的乘数。当客户端超过此限制时，将 返回limit-req-status-code默认值： 503。
nginx.ingress.kubernetes.io/limit-rate-after #最初的千字节数，在此之后，对给定连接的响应的进一步传输将受到速率的限制。必须在启用代理缓冲的情况下使用此功能。
nginx.ingress.kubernetes.io/limit-rate #每秒允许发送到给定连接的千字节数。零值禁用速率限制。必须在启用代理缓冲的情况下使用此功能。
nginx.ingress.kubernetes.io/limit-whitelist #客户端IP源范围要从速率限制中排除。该值是逗号分隔的CIDR列表。
```



```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/limit-rate: 100K #限制客户端每秒传输的字节数
    nginx.ingress.kubernetes.io/limit-whitelist: 10.1.10.100 #白名单中的IP不限速
    nginx.ingress.kubernetes.io/limit-rps: 1 #单个IP每秒的连接数
    nginx.ingress.kubernetes.io/limit-rpm: 30 #单个IP每分钟的连接数
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

### 灰度/金丝雀发布

Annotations 支持以下 4 种 Canary 规则实现不同场景下的灰度发布和测试：

```yaml
nginx.ingress.kubernetes.io/canary-by-header: 基于 Request Header 的流量切分，适用于灰度发布以及 A/B 测试。当 Request Header 设置为 always时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为 never时，请求不会被发送到 Canary 入口；对于任何其他 Header 值，将忽略 Header，并通过优先级将请求与其他金丝雀规则进行优先级的比较。
nginx.ingress.kubernetes.io/canary-by-header-value: 要匹配的 Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。该规则允许用户自定义 Request Header 的值，必须与上一个 annotation (即：canary-by-header）一起使用。
nginx.ingress.kubernetes.io/canary-weight: 基于服务权重的流量切分，适用于蓝绿部署，权重范围 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为 100 意味着所有请求都将被发送到 Canary 入口。
nginx.ingress.kubernetes.io/canary-by-cookie: 基于 Cookie 的流量切分，适用于灰度发布与 A/B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的cookie。当 cookie 值设置为 always时，它将被路由到 Canary 入口；当 cookie 值设置为 never时，请求不会被发送到 Canary 入口；对于任何其他值，将忽略 cookie 并将请求与其他金丝雀规则进行优先级的比较。 定义两个版本的代码。
```

把以上的四个 annotation 规则可以总体划分为以下两类：

- 基于权重

![基于权重](https://gitee.com/c_honghui/picture/raw/master/img/20220223233513.png)

- 基于用户请求

![基于规则](https://gitee.com/jadepeng/pic/raw/master/pic/2020/1/17/1579246569310.png)

再创建一个ingress，实现百分之五十访问kuboardv1，百分之五十访问kuboardv2

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true" #可以使用两个相同域名
    nginx.ingress.kubernetes.io/canary-weight: "50" #百分之五十流量到金丝雀版本
    nginx.ingress.kubernetes.io/canary-by-header: always
    nginx.ingress.kubernetes.io/canary-by-header-value: canary #如果请求头的always等于canary就只会访问到金丝雀版本，用curl -H "always:canary" http://kuboard.k8s.com测试
    nginx.ingress.kubernetes.io/canary-by-cookie: always #?cookie值为always时只会访问到金丝雀版本，curl -b "canary-cookie=always" http://kuboard.k8s.com
  name: ingress-kuboardv2
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kuboardv2
            port:
              number: 80
```

优先级：

```yaml
canary-by-header -> canary-by-cookie -> canary-weight
```

### 自定义错误页面

annotations配置

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/server-snippet: |-
        error_page 404 https://...;
  name: ingress-kuboard
  namespace: kube-system
spec:
  ingressClassName: nginx
  rules:
  - host: kuboard.k8s.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: kuboard
            port:
              number: 80
```

configmap全局配置

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blockcidrs
  namespace: kube-system
data:
  custom-http-errors: 404,403
  
修改ingress-nginx配置403默认访问的后端
spec:
  template:
    spec:
      containers:
      - args:
        - --default-backend=<namespace>/<pod-name>
```

### 基本认证

