# Deployment

用于部署无状态的服务，这个是最常用的控制器。一般用于管理维护企业内部无状态的微服务，比如configserver、zuul、springboot。它可以管理多个副本的Pod实现无缝迁移、自动扩缩容、自动灾难恢复、一键回滚等功能。

## 使用deployment创建pod

```shell
cat deployment.yml

```

创建pod

```shell
kubectl create -f deployment.yml
```

查看deployment状态

```shell
kubectl get deploy -owide

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx-deployment   					3/3     3            3           41s   nginx        nginx:1.17.1   app=nginx-pod

#NAME：deployment名称
#READY：pod状态
#UP-TO-DATE：已经达到期望状态的被更新的副本数
#AVAILABLE：已经可用的副本数
#AGE：应用程序运行的时间
#CONTAINERS：容器名称
#IMAGES：镜像名称
#SELECTOR：pod的标签
```

## deployment更新

仅当 Deployment Pod 模板（即 .spec.template）发生改变时，才会生成新的RS

镜像更新触发Deployment:

```shell
kubectl set image deploy nginx nginx=nginx:1.16.1 --record
#- -record ： 标志将所执行的命令写入资源注 kubernetes.io/change-cause 中。 这对于以后的检查是有用的。例如 要查看针对每个 Deployment 修订版本所执行过的命令。
```

查看上线状态:

```shell
kubectl rollout status deploy nginx
```

查看 Deployment 创建的 ReplicaSet

```shell
kubectl get rs
```

## deployment回滚

Deployment 的所有上线记录都保留在系统中，当deployment更新失败时，可以随时回滚

Deployment 修订历史：

```shell
kubectl rollout history deploy nginx
```

回滚到上一个版本：

```shell
kubectl rollout undo deploy nginx
```

查看指定版本的详细信息：

```shell
kubectl rollout history deploy nginx --revision=5
```

回滚到指定版本：

```shell
kubectl rollout undo deploy nginx --to-revision=5
```

## deployment扩容和缩容

扩容为5个副本：

```shell
kubectl scale deploy --replicas=5 nginx
```

缩容为3个副本：

```shell
kubectl scale deploy --replicas=3 nginx
```

## deployment更新暂停和恢复

暂停更新：

```shell
kubectl rollout pause deployment nginx
```

第一次变更配置：

```shell
kubectl set image deploy nginx nginx=nginx:1.15.3 --record
```

第二次变更配置：

```shell
kubectl set resources deploy nginx -c nginx --limits=cpu=200m,memory=128Mi --requests=cpu=10m,memory=16Mi
```

恢复更新：

```shell
kubectl rollout resume deploy nginx
```

## deployment配置

```yaml
.spec.revisionHistoryLimit #设置保留rs旧的revision个数
.spec.minReadySeconds #可选参数，新创建的Pod状态为Ready持续的时间至少为几秒才认为可用，默认0即被创建就视为可用
.spec.strategy.type #更新deployment方式，默认RollingUpdate
	RollingUpdate #滚动更新
		maxUnavailable #指定在回滚或更新时最大不可用pod数量，可选字段，默认25%，向下取整，0.5算0
		maxSurge #可超过期望值的最大pod，可选字段，默认25%，向上取整，0.5算1
	Recreate #重建，先删除旧pod，再创建新pod
```

假设maxSurge:3, maxUnavailable=2, desired replicas=25

更新的时候，NewRS创建maxSurge(3)个Pods，这时达到pods数的上限值desired replicas + maxSurge (28个）
不会等NewRS创建的Pods Ready，而是马上delete OldRS maxUnavailable(2)个Pods，这时Ready的Pods number最差也能保证desired replicas - maxUnavailable(23个)

接下来的流程是不固定，只要新建的Pods有几个返回Ready，则意味着可以接着删除几个旧的Pods了。只要有几个删除成功的Pods返回，就会创建一定数量的Pods，只要All pods数量与上限值desired replicas + maxSurge有差值空间，就会接着创建新的Pods。

如此进行滚动更新， 直到创建的新Pods个数达到desired replicas，并等待它们都Ready，然后再删除所有剩余的旧的Pods。至此，滚动流程结束。
