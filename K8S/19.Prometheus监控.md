# Prometheus

## 安装

地址：https://github.com/prometheus-operator/kube-prometheus

下载：

```shell
git clone -b release-0.5 --single-branch https://github.com/prometheus-operator/kube-prometheus.git
```

安装operator：

```shell
cd kube-prometheus/manifests/setup/
kubectl apply -f .

[root@k8s-master01 manifests]# kubectl get po -n monitoring
NAME                                   READY   STATUS    RESTARTS   AGE
prometheus-operator-6478d8fc6d-mqlf9   2/2     Running   0          2m43s

kubectl get svc -n monitoring
```

安装Prometheus：

```shell
cd ..
kubectl apply -f .

[root@k8s-master01 manifests]# kubectl get po -n monitoring
NAME                                   READY   STATUS    RESTARTS   AGE
alertmanager-main-0                    2/2     Running   0          28m
alertmanager-main-1                    2/2     Running   0          28m
alertmanager-main-2                    2/2     Running   0          28m
grafana-5d9d5f67c4-wrblp               1/1     Running   0          28m
kube-state-metrics-7fddf8779f-pxmsh    3/3     Running   0          28m
node-exporter-84l65                    2/2     Running   0          28m
node-exporter-9zpq8                    2/2     Running   0          28m
node-exporter-flppr                    2/2     Running   0          28m
node-exporter-pdrvv                    2/2     Running   0          28m
node-exporter-qrm4h                    2/2     Running   0          28m
prometheus-adapter-cb548cdbf-s7dcj     1/1     Running   0          28m
prometheus-k8s-0                       3/3     Running   1          28m
prometheus-k8s-1                       3/3     Running   0          28m
prometheus-operator-6478d8fc6d-mqlf9   2/2     Running   0          126m
```

创建ingress（之前已经部署了ingress-nginx）

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prom-ingresses
  namespace: monitoring
spec:
  ingressClassName: nginx
  rules:
  - host: alert.test.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: alertmanager-main
            port: 
              number: 9093
  - host: grafana.test.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port: 
              number: 3000
  - host: prom.test.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-k8s
            port: 
              number: 9090
```

把域名解析到ingress-nginx部署的节点的ip地址

