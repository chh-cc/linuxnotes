# StatefulSet

用于部署**有状态**的且需要**有序启动**的应用程序，比如部署Eureka集群、ElasticSearch集群、MongoDB集群或者**需要持久化**的Rabbit MQ集群、Redis集群、Kafka集群和ZooKeeper集群等。

StatefulSet为每个pod维护一个唯一且固定的标识符，一般格式为StatefulSetName-Number。比如定义一个名字是Redis-Sentinel的

StatefulSet，指定创建3个pod，那么创建出来的pod的名字为Redis-Sentinel-0、Redis-Sentinel-1、Redis-Sentinel-2。pod一般使用Headless Service（无头服务）进行通信，和普通的Service的区别在于没有ClusterIP，它使用Endpoint通信。

Headless一般格式为：statefulsetname-number.servicename.namespace.svc.cluster.local

## 创建一个statefulset应用

定义一个简单的statefulset：

```yaml
vim nginx-sts.yaml

apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  clusterIP: None
  selector:
    app: nginx
  ports:
  - name: web
    port: 80
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:  
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.15.2
        ports:
        - containerPort: 80
          name: web
     
#此处没有添加存储配置
```

创建pod

```shell
kubectl create -f nginx-sts.yaml
```

查看pods

```shell
[root@k8s-master-1 statefulset]# kubectl get pods
NAME                                      READY   STATUS    RESTARTS   AGE
web-0                                     1/1     Running   0          2m39s
web-1                                     1/1     Running   0          2m34s

#web-0创建好后才会继续创建web-1
```

查看svc

```shell
kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.0.0.1     <none>        443/TCP   3d10h
nginx        ClusterIP   None         <none>        80/TCP    2m48s
```

扩容

```shell
kubectl scale --replicas=3 sts web
```



